import EventEmitter from"eventemitter3";const keyPosit={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,Backspace:8,Tab:9,Enter:13,Shift:16,Control:17,Alt:18,CapsLock:20,Esc:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Insert:45,Left:37,Up:38,Right:39,Down:40,Del:46,NumLock:144,Cmd:91,CmdFF:224,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"`":192,"=":187,"+":187,"-":189,"'":222,"/":191,".":190,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},CLICK_DISTANCE=10,FOUR_CORNER={TOP_LEFT:"topLeft",TOP_RIGHT:"topRight",BOTTOM_RIGHT:"bottomRight",BOTTOM_LEFT:"bottomLeft"},DRAG_NODE_PARTS={BODY:"body",ROTATE:"rotate",TOP_LEFT_BUTTON:"topLeftButton",TOP_RIGHT_BUTTON:"topRightButton",BOTTOM_RIGHT_BUTTON:"bottomRightButton",BOTTOM_LEFT_BUTTON:"bottomLeftButton"};function getNodeID(){return(1e7*Math.floor(1e12*Math.random())+(new Date).getTime()).toString(36)}let nodeKeyIndex=0;function createNodeKey(){return nodeKeyIndex+=1}const deepCopy=e=>JSON.parse(JSON.stringify(e)),downloadFile=(e,t)=>{var i=document.createElement("a");i.href=e,i.download=t,i.click()},throttle=(t,i,s=20)=>{let o=null;return(...e)=>{o=o||setTimeout(()=>{t.call(i,...e),o=null},s)}},getFontString=(e,t)=>e+"px "+t,splitTextLines=e=>e.replace(/\r\n?/g,"\n").split("\n"),radToDeg=e=>e*(180/Math.PI),degToRad=e=>e*(Math.PI/180),createCanvas=(e,t,i={noStyle:!1,noTranslate:!1,className:""})=>{var s=document.createElement("canvas"),o=(i.noStyle||(s.style.cssText="position: absolute;left: 0;top: 0;"),i.className&&(s.className=i.className),s.getContext("2d"));return s.width=e,s.height=t,i.noTranslate||o?.translate(s.width/2,s.height/2),{canvas:s,ctx:o}},getTowCoordinateDistance=(e,t,i,s)=>Math.sqrt((e-i)**2+(t-s)**2),getCoordinateToLineDistance=(e,t,i,s,o,a)=>{return i===o?Math.abs(e-i):(a=(s-a)/(o-i),Math.abs((a*e+ +t+(0-+s-a*i))/Math.sqrt(a*a+1)))},checkIsAtSegment=(e,t,i,s,o,a,n=10)=>{var r;return void 0!==o&&void 0!==a&&!(getCoordinateToLineDistance(e,t,i,s,o,a)>n)&&(r=getTowCoordinateDistance(e,t,i,s),e=getTowCoordinateDistance(e,t,o,a),t=getTowCoordinateDistance(i,s,o,a),r<=(i=Math.sqrt(n*n+t*t)))&&e<=i},getTowCoordinateRotate=(e,t,i,s,o,a)=>radToDeg(Math.atan2(s-t,i-e)-Math.atan2(a-t,o-e)),getRotatedCoordinate=(e,t,i,s,o)=>{o=radToDeg(Math.atan2(t-s,e-i))+o,e=getTowCoordinateDistance(e,t,i,s);return{x:Math.cos(degToRad(o))*e+i,y:Math.sin(degToRad(o))*e+s}},getNodeCenterCoordinate=e=>{var{x:e,y:t,width:i,height:s}=e;return{x:e+i/2,y:t+s/2}},transformCoordinateReverseRotate=(e,t,i,s,o)=>{return 0!==o&&(e=(i=getRotatedCoordinate(e,t,i,s,-o)).x,t=i.y),{x:e,y:t}},transformCoordinateOnNode=(e,t,i)=>{var s=getNodeCenterCoordinate(i);return transformCoordinateReverseRotate(e,t,s.x,s.y,i.rotate)},getNodeFourCornerCoordinate=(e,t)=>{var{x:i,y:s,width:o,height:a}=e;switch(t){case"topLeft":return{x:i,y:s};case"topRight":return{x:i+o,y:s};case"bottomRight":return{x:i+o,y:s+a};case"bottomLeft":return{x:i,y:s+a}}return{}},getBoundingRect=(e=[],t=!1)=>{let i=1/0,s=-1/0,o=1/0,a=-1/0;e.forEach(e=>{var[e,t]=e;e<i&&(i=e),e>s&&(s=e),t<o&&(o=t),t>a&&(a=t)});var e=i,n=o,r=s-i,h=a-o;return t?[{x:e,y:n},{x:e+r,y:n},{x:e+r,y:n+h},{x:e,y:n+h}]:{x:e,y:n,width:r,height:h}},getNodeRotatedFourCornerCoordinate=(e,t)=>{var i=getNodeCenterCoordinate(e),t=getNodeFourCornerCoordinate(e,t);return t&&t.x&&t.y?getRotatedCoordinate(t.x,t.y,i.x,i.y,e.rotate):0},checkCoordinateIsInRectangle=(e,t,i,s,o,a)=>{var n;return"object"==typeof i&&(i=(n=i).x,s=n.y,o=n.width,a=n.height),void 0!==s&&void 0!==o&&void 0!==a&&i<=e&&e<=i+o&&s<=t&&t<=s+a},getMultiplexNodeRectInfo=(e=[])=>{if(e.length<=0)return{minX:0,maxX:0,minY:0,maxY:0};let i=1/0,s=-1/0,o=1/0,a=-1/0;return e.forEach(e=>{(e?.getEndCoordinateList?.()).forEach(({x:e,y:t})=>{e<i&&(i=e),e>s&&(s=e),t<o&&(o=t),t>a&&(a=t)})}),{minX:i,maxX:s,minY:o,maxY:a}};let textCheckEl=null;const getTextActWidth=(e,t)=>{textCheckEl||((textCheckEl=document.createElement("div")).style.position="fixed",textCheckEl.style.left="-99999px",document.body.appendChild(textCheckEl));var{fontSize:t,fontFamily:i}=t,e=(textCheckEl.innerText=e,textCheckEl.style.fontSize=t+"px",textCheckEl.style.fontFamily=i,textCheckEl.getBoundingClientRect())["width"];return e},getNodeFourCorners=e=>{var t=getNodeRotatedFourCornerCoordinate(e,"bottomRight");return[getNodeRotatedFourCornerCoordinate(e,"topLeft"),getNodeRotatedFourCornerCoordinate(e,"topRight"),getNodeRotatedFourCornerCoordinate(e,"bottomLeft"),t]},createImageObj=i=>new Promise(e=>{const t=new Image;t.setAttribute("crossOrigin","anonymous"),t.onload=()=>{e(t)},t.onerror=()=>{e(null)},t.src=i}),getMaxFontSizeInWidth=(e,t,i)=>{let s=12;for(;getTextActWidth(e,{...i,fontSize:s+1})<t;)s+=1;return s},getWrapTextActWidth=t=>{var e=t["text"],e=splitTextLines(e);let i=-1/0;return e.forEach(e=>{e=getTextActWidth(e,t.style);e>i&&(i=e)}),i},getWrapTextMaxRowTextNumber=e=>{e=splitTextLines(e);let t=-1/0;return e.forEach(e=>{e.length>t&&(t=e.length)}),t},getTextNodeSize=e=>{var{text:t,style:i}=e;return{width:getWrapTextActWidth(e),height:Math.max(splitTextLines(t).length,1)*(i.fontSize*i.lineHeightRatio)}},computedLineWidthBySpeed=(e,t,i=2)=>{let s=0;var o=i+2;return-1===t&&(t=o),.5*(s=10<=e?i:e<=.5?o+1:o-(e-.5)/9.5*o)+.3*t};var utils=Object.freeze({__proto__:null,getNodeID:getNodeID,createNodeKey:createNodeKey,deepCopy:deepCopy,downloadFile:downloadFile,throttle:throttle,getFontString:getFontString,splitTextLines:splitTextLines,radToDeg:radToDeg,degToRad:degToRad,createCanvas:createCanvas,getTowCoordinateDistance:getTowCoordinateDistance,getCoordinateToLineDistance:getCoordinateToLineDistance,checkIsAtSegment:checkIsAtSegment,getTowCoordinateRotate:getTowCoordinateRotate,getRotatedCoordinate:getRotatedCoordinate,getNodeCenterCoordinate:getNodeCenterCoordinate,transformCoordinateReverseRotate:transformCoordinateReverseRotate,transformCoordinateOnNode:transformCoordinateOnNode,getNodeFourCornerCoordinate:getNodeFourCornerCoordinate,getBoundingRect:getBoundingRect,getNodeRotatedFourCornerCoordinate:getNodeRotatedFourCornerCoordinate,checkCoordinateIsInRectangle:checkCoordinateIsInRectangle,getMultiplexNodeRectInfo:getMultiplexNodeRectInfo,getTextActWidth:getTextActWidth,getNodeFourCorners:getNodeFourCorners,createImageObj:createImageObj,getMaxFontSizeInWidth:getMaxFontSizeInWidth,getWrapTextActWidth:getWrapTextActWidth,getWrapTextMaxRowTextNumber:getWrapTextMaxRowTextNumber,getTextNodeSize:getTextNodeSize,computedLineWidthBySpeed:computedLineWidthBySpeed});class Author{app;startScrollX;startScrollY;isDragAuthor;constructor(e){this.app=e,this.startScrollX=0,this.startScrollY=0,this.isDragAuthor=!1,this.onMove=throttle(this.onMove,this,15),this.bindEvent()}onStart(){this.startScrollX=this.app.state.scrollX,this.startScrollY=this.app.state.scrollY}onMove(e,t){void 0!==this.startScrollX&&void 0!==this.startScrollY&&void 0!==this.app.state.scale&&this.app.scrollTo(this.startScrollX-t.mouseOffset.originX/this.app.state.scale,this.startScrollY-t.mouseOffset.originY/this.app.state.scale)}bindEvent(){this.app.event.on("keydown",e=>{e.keyCode===keyPosit.Space&&(this.isDragAuthor=!0,this.app.cursor.set("grab"))}),this.app.event.on("keyup",()=>{this.isDragAuthor&&(this.isDragAuthor=!1,this.app.cursor.set("default"))})}setEditAuthor(){this.app.cursor.set("default"),this.app.updateState({readonly:!1})}setReadonlyAuthor(){this.app.cursor.set("grab"),this.app.cancelActiveNode(),this.app.updateState({readonly:!0})}}class Background{app;constructor(e){this.app=e}set(){this.app.state.backgroundColor?this.addBackgroundColor():this.remove()}addBackgroundColor(){this.app.mountEL.style.backgroundColor=this.app.state.backgroundColor}remove(){this.app.mountEL.style.backgroundColor=""}static canvasAddBackgroundColor(e,t,i,s){e.save(),e.rect(0,0,t,i),e.fillStyle=s,e.fill(),e.restore()}}class Cursor{app;currentType;constructor(e){this.app=e,this.currentType="default"}set(e="default"){let t="text"===(this.currentType=e)?"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAAXNSR0IArs4c6QAAAWZJREFUSEvNlLFOwzAQhi+5iaUrDDwBHekDNHtZEOorMFk5JQ8APEAsJyOPwAjsZEZ0LAMrCzwBUxx0kVM5adI4RZXwlMj2p///fXceHGh5B+LC/wPHcXxWFMWSHSulbtvO91JsoA8AMDXAXCkV2PC9wAwgIlZ5Y8HubOWjwLX9GtCCN1Q7g1v2N+oM/Mr3/Usp5UftwAlsoG8AcNRlnfeTJHkflbGBrnvqvZGrM5iI5gDw0gNdI+KyrXQwigHoDyLO+qAM78w4DMNjz/O++todEae7oJ1gIcQpIn7+BboFHrDP5wOlVO4yuBpREBGX1HnPRWdoQ3EURQut9VMXtCzLkzRNv12UblUFET0CwEX7stZ6lmXZagx0o1gIMTEPNrEAK631dQ01rVuNyPobAHg+5PZeQ7HVXWz31ff9eynls62SiEoDCqzhU+Vu73VFMd/14qZiWDGDuCOrZf/b952G0Nh8+fwvoNqzF6HDmhsAAAAASUVORK5CYII=) 10 10, auto":"eraser"===e?"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAAXNSR0IArs4c6QAAAbZJREFUSEvNlL1rVEEUxc95uwvCVjYKNnZa2ATEXrALNhaKiBgQDabQwt13hlQbi30w8x4oNhaCkYBFElAhoJXaip2FRfIX2FhY2c2VJy5skn0fERacbphzf3Pv5dxLzOlwTlz8H2Dv/VqSJF/NbFHS3bpqW2ec5/mqmWUk1wC8iTFmzrnLVfBWYO/9gGQxBVkl+c7M1iWdnwVvBIcQ7gN4OiP4IckPZrYj6fTB91pwURT3YozPqso1sxWSnwF8knR8WlcJDiHcAfC8yY5mdgvAT5KvJXUn+plg7/0SyZdN0Kn3bQA/JK1UgvM8v2Fmr44A/SMleSlN048zwSGEqwC2jgpNkmRxOBy+r+yx9/4xyQUAF9vCzeyKc+5trStCCCaJRVFciDF+aQG/Lmmz1schhHKKXkg6UQqzLDvT7XZ3a+BLkjZaTV6ZcafTOTsYDPbKgPF4fLLX630/VCa5nKZprRX32a1cMiRHZTsmsNFodKzf7/+a3M3stnNuvalNh3w8gQO4Jmn7r1OeADhlZjedc62sWDUgyyQfADgH4BuAR2WG5UdNmdZOXtvgOl3jdvvXT+YG/g3VNZQXhpoDKQAAAABJRU5ErkJggg==) 10 10, auto":e;this.app.mountEL.style.cursor=t}setEraser(){this.set("eraser")}setText(){this.set("text")}setMove(){this.set("move")}hide(){this.set("none")}reset(){this.set()}setCrossHair(){this.set("crosshair")}setResize(e){let t="";switch(e){case DRAG_NODE_PARTS.BODY:t="move";break;case DRAG_NODE_PARTS.ROTATE:t="grab";break;case DRAG_NODE_PARTS.TOP_LEFT_BUTTON:t="nw-resize";break;case DRAG_NODE_PARTS.TOP_RIGHT_BUTTON:t="ne-resize";break;case DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON:t="se-resize";break;case DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON:t="sw-resize"}this.set(t)}}class Event extends EventEmitter{app;calculate;lastMousePos;mouseDistance;lastMouseTime;mouseDuration;mouseSpeed;isMousedown;mousedownPos;mouseOffset;constructor(e){super(),this.app=e,this.calculate=e.calculate,this.lastMousePos={x:0,y:0},this.mouseDistance=0,this.lastMouseTime=Date.now(),this.mouseDuration=0,this.mouseSpeed=0,this.isMousedown=!1,this.mousedownPos={x:0,y:0,unGridClientX:0,unGridClientY:0,originClientX:0,originClientY:0},this.mouseOffset={x:0,y:0,originX:0,originY:0},this.onMousedown=this.onMousedown.bind(this),this.onMousemove=this.onMousemove.bind(this),this.onMouseup=this.onMouseup.bind(this),this.onDblclick=this.onDblclick.bind(this),this.onMousewheel=this.onMousewheel.bind(this),this.onKeydown=this.onKeydown.bind(this),this.onKeyup=this.onKeyup.bind(this),this.onContextmenu=this.onContextmenu.bind(this),this.bindEvent()}onMouseup(e){e=this.transformEvent(e),this.isMousedown=!1,this.mousedownPos.x=0,this.mousedownPos.y=0,this.emit("mouseup",e,this)}onDblclick(e){e=this.transformEvent(e),this.emit("dblclick",e,this)}onMousewheel(e){e=this.transformEvent(e),this.emit("mousewheel",e.originEvent.wheelDelta<0?"down":"up")}onContextmenu(e){e.stopPropagation(),e.preventDefault(),e=this.transformEvent(e),this.emit("contextmenu",e,this)}onKeydown(e){this.emit("keydown",e,this)}onKeyup(e){this.emit("keyup",e,this)}onMousedown(e){e=this.transformEvent(e),this.isMousedown=!0,this.mousedownPos.x=e.clientX,this.mousedownPos.y=e.clientY,this.mousedownPos.unGridClientX=e.unGridClientX,this.mousedownPos.unGridClientY=e.unGridClientY,this.mousedownPos.originClientX=e.originEvent.clientX,this.mousedownPos.originClientY=e.originEvent.clientY,this.emit("mousedown",e,this)}onMousemove(e){var t=(e=this.transformEvent(e)).clientX,i=e.clientY,s=(this.isMousedown&&(this.mouseOffset.x=t-this.mousedownPos.x,this.mouseOffset.y=i-this.mousedownPos.y,this.mouseOffset.originX=e.originEvent.clientX-this.mousedownPos.originClientX,this.mouseOffset.originY=e.originEvent.clientY-this.mousedownPos.originClientY),Date.now());this.mouseDuration=s-this.lastMouseTime,this.mouseDistance=getTowCoordinateDistance(t,i,this.lastMousePos.x,this.lastMousePos.y),this.mouseSpeed=this.mouseDistance/this.mouseDuration,this.emit("mousemove",e,this),this.lastMouseTime=s,this.lastMousePos.x=t,this.lastMousePos.y=i}transformEvent(e){var t=this.app["calculate"],i=t.windowToContainer(e.clientX,e.clientY),{x:i,y:s}=t.reverseScale(i.x,i.y),o=i=t.addScrollX(i),a=s=t.addScrollY(s),t=t.gridAdsorbent(i,s);return{originEvent:e,unGridClientX:o,unGridClientY:a,clientX:t.x,clientY:t.y}}bindEvent(){this.app.mountEL.addEventListener("mousedown",this.onMousedown),this.app.mountEL.addEventListener("mousemove",this.onMousemove),this.app.mountEL.addEventListener("mouseup",this.onMouseup),this.app.mountEL.addEventListener("dblclick",this.onDblclick),this.app.mountEL.addEventListener("mousewheel",this.onMousewheel),this.app.mountEL.addEventListener("contextmenu",this.onContextmenu),window.addEventListener("keydown",this.onKeydown),window.addEventListener("keyup",this.onKeyup)}unbindEvent(){this.app.mountEL.removeEventListener("mousedown",this.onMousedown),this.app.mountEL.removeEventListener("mousemove",this.onMousemove),this.app.mountEL.removeEventListener("mouseup",this.onMouseup),this.app.mountEL.removeEventListener("dblclick",this.onDblclick),this.app.mountEL.removeEventListener("mousewheel",this.onMousewheel),this.app.mountEL.removeEventListener("contextmenu",this.onContextmenu),window.removeEventListener("keydown",this.onKeydown),window.removeEventListener("keyup",this.onKeyup)}}class Export{app;openPreview;saveState;constructor(e){this.app=e,this.openPreview=!1,this.saveState={scale:0,scrollX:0,scrollY:0,width:0,height:0}}exportJson(){return this.app.getData()}render(e,t){e.save(),this.getNodeList(t).forEach(e=>{var t,i;e.noRender||(t=e.isActive,i=e.isSelected,e.isActive=!1,e.isSelected=!1,e.render(),e.isActive=t,e.isSelected=i)}),e.restore()}saveAppState(){var{width:e,height:t,state:i,ctx:s}=this.app;this.saveState.width=e,this.saveState.height=t,i.scale&&(this.saveState.scale=i.scale),i.scrollX&&(this.saveState.scrollX=i.scrollX),i.scrollY&&(this.saveState.scrollY=i.scrollY),this.saveState.ctx=s}exportImage({type:e="image/png",renderBg:t=!0,useBlob:i=!1,paddingX:s=10,paddingY:o=10,onlySelected:a=!0}={}){var{minX:n,maxX:r,minY:h,maxY:d}=getMultiplexNodeRectInfo(this.getNodeList(a)),r=r-n+2*s,d=d-h+2*o;const{canvas:l,ctx:c}=createCanvas(r,d,{noStyle:!0,noTranslate:!0});return c?(this.show(l),this.saveAppState(),this.changeAppState(n-s,h-o,c),t&&this.app.state.backgroundColor&&c&&Background.canvasAddBackgroundColor(c,r,d,this.app.state.backgroundColor),this.render(c,a),this.recoveryAppState(),i?new Promise((t,i)=>{l.toBlob(e=>{e?t(e):i()},e)}):l.toDataURL(e)):(console.error("Create Export Canvas Error"),"")}show(e){this.openPreview&&(e.style.cssText="position: absolute;left: 0;top: 0;background-color: #FFFFFF;",document.body.appendChild(e))}recoveryAppState(){var{width:e,height:t,scale:i,scrollX:s,scrollY:o,ctx:a}=this.saveState;this.app.state.scale=i,this.app.state.scrollX=s,this.app.state.scrollY=o,this.app.width=e,this.app.height=t,a&&(this.app.ctx=a)}changeAppState(e,t,i){this.app.ctx=i,this.app.width=2*e,this.app.height=2*t,this.app.state.scale=1,this.app.state.scrollX=0,this.app.state.scrollY=0}getNodeList(e=!0){if(!e)return this.app.nodes.nodeList;let t=[];return this.app.nodes.activeNode?t.push(this.app.nodes.activeNode):this.app.selection.hasSelectionNodes()&&(t=this.app.selection.getSelectionNodes()),this.app.nodes.nodeList.filter(e=>t.includes(e))}}class Canvas{width;height;el;ctx;constructor(e,t,i){this.width=e,this.height=t;var{canvas:e,ctx:t}=createCanvas(e,t,i);t&&(this.el=e,this.ctx=t)}clearCanvas(){var{width:e,height:t}=this;this.ctx?.clearRect(-e/2,-t/2,e,t)}}class Grid{app;canvas;ctx;constructor(e){this.app=e,this.canvas=null,this.ctx=null,this.init(),this.app.on("zoomChange",this.renderGrid,this),this.app.on("scrollChange",this.renderGrid,this)}renderVerticalLines(){var{calculate:t,width:i,state:e}=this.app,{gridConfig:s,scale:o}=e;let a=0;if(void 0===s||void 0===o||void 0===s.size)console.error("gridConfig or scale or gridConfig.size is undefined");else{for(let e=-i/2;e<i/2;e+=s.size)this.plotVerticalLine(e),a=e;for(let e=-i/2-s.size;e>-t.subScrollX(i/o/2);e-=s.size)this.plotVerticalLine(e);for(let e=a+s.size;e<t.addScrollX(i/o/2);e+=s.size)this.plotVerticalLine(e)}}renderHorizontalLines(){var{calculate:i,height:s,state:e}=this.app,{gridConfig:o,scale:a}=e;if(void 0!==o&&void 0!==a&&void 0!==o.size){let t=0;for(let e=-s/2;e<s/2;e+=o.size)this.plotHorizontalLine(e),t=e;for(let e=-s/2-o.size;e>-i.subScrollY(s/a/2);e-=o.size)this.plotHorizontalLine(e);for(let e=t+o.size;e<i.addScrollY(s/a/2);e+=o.size)this.plotHorizontalLine(e)}}renderGrid(){this.canvas.clearCanvas();var{gridConfig:e,scale:t,showGrid:i}=this.app.state;i&&(this.ctx&&t&&e&&this.ctx.strokeStyle&&this.ctx.lineWidth&&(this.ctx.save(),this.ctx.scale(t,t),this.ctx.strokeStyle=e.strokeStyle,this.ctx.lineWidth=e.lineWidth),this.renderVerticalLines(),this.renderHorizontalLines(),this.ctx?.restore())}plotHorizontalLine(e){var{calculate:t,width:i,state:s}=this.app;void 0!==s.scale&&(t=t.subScrollY(e),this.ctx?.beginPath(),this.ctx?.moveTo(-i/s.scale/2,t),this.ctx?.lineTo(i/s.scale/2,t),this.ctx?.stroke())}plotVerticalLine(e){var{calculate:t,height:i,state:s}=this.app;void 0!==s.scale&&(t=t.subScrollX(e),this.ctx?.beginPath(),this.ctx?.moveTo(t,-i/s.scale/2),this.ctx?.lineTo(t,i/s.scale/2),this.ctx?.stroke())}showGrid(){this.app.updateState({showGrid:!0}),this.renderGrid()}hideGrid(){this.app.updateState({showGrid:!1}),this.canvas.clearCanvas()}updateGrid(e={}){this.app.updateState({gridConfig:{...this.app.state.gridConfig,...e}}),this.app.state.showGrid&&(this.hideGrid(),this.showGrid())}init(){this.canvas&&this.app.mountEL.removeChild(this.canvas.el);var{width:e,height:t}=this.app;this.canvas=new Canvas(e,t,{className:"grid"}),this.ctx=this.canvas.ctx,this.app.mountEL.insertBefore(this.canvas.el,this.app.mountEL.children[0])}}class History{app;historyStack;length;index;fixIndex;constructor(e){this.app=e,this.historyStack=[],this.length=0,this.index=-1,this.fixIndex=-1}emitChange(){this.app.emit("shuttle",this.index,this.length)}now(){return this.historyStack[this.length-1]}clear(){this.index=-1,this.length=0,this.historyStack=[],this.emitChange()}add(e){var t=0<this.length?this.historyStack[this.length-1]:null,e=deepCopy(e);e!==t&&(this.historyStack.push(e),this.length+=1,this.index=this.length-1,this.emitChange())}shuttle(){const e=this.app.getData(),t=this.historyStack[this.index],i=(this.fixIndex=this.index,this.length);this.app.setData(t,!0).then(()=>{this.index=this.fixIndex,this.length=i,this.emitChange(),this.app.emit("change",t),this.app.emitDiffNodesChange(e,t),this.app.emitDiffStateChange(e,t)}).catch(()=>{console.error("History shuttle setData error")})}undo(){this.index<=0||(--this.index,this.shuttle())}redo(){this.index>=this.length-1||(this.index+=1,this.shuttle())}}class ImageEdit extends EventEmitter{app;el;isReady;previewEl;imageData;maxWidth;maxHeight;maxRatio;constructor(e){super(),this.app=e,this.el=null,this.isReady=!1,this.previewEl=null,this.imageData=null,this.maxWidth=750,this.maxHeight=450,this.maxRatio=this.maxWidth/this.maxHeight,this.onImageSelectChange=this.onImageSelectChange.bind(this)}updatePreviewElPos(e,t){var i;this.imageData?(i=100/this.imageData.ratio,this.previewEl||(this.previewEl=document.createElement("div"),this.previewEl.style.position="fixed",this.previewEl.style.width="100px",this.previewEl.style.height=i+"px",this.previewEl.style.backgroundImage=`url('${this.imageData.url}')`,this.previewEl.style.backgroundSize="cover",this.previewEl.style.pointerEvents="none",document.body.appendChild(this.previewEl)),e=this.app.calculate.mountELToWindow(e,t),this.previewEl.style.left=e.x-50+"px",this.previewEl.style.top=e.y-i/2+"px"):console.error("imageData is null")}reset(){this.el&&(this.el.value=""),this.isReady=!1,this.previewEl&&document.body.removeChild(this.previewEl),this.previewEl=null,this.imageData=null}async getImageUrl(s){return new Promise((e,t)=>{const i=new FileReader;i.onloadend=()=>{e(i.result)},i.onerror=()=>{t()},i.readAsDataURL(s)})}async getImageSize(t){return new Promise((s,e)=>{const o=new Image;o.setAttribute("crossOrigin","anonymous"),o.onload=()=>{let e=o["width"],t=o["height"];var i=o.width/o.height;(o.width>this.maxWidth||o.height>this.maxHeight)&&(i>this.maxRatio?(e=this.maxWidth,t=this.maxWidth/i):(t=this.maxHeight,e=this.maxHeight*i)),s({imageObj:o,size:{width:e,height:t},ratio:i})},o.onerror=()=>{e()},o.src=t})}async onImageSelectChange(e){var t,i,s,e=await this.getImageUrl(e.target.files[0]);"string"!=typeof e?console.error("url is not string"):({imageObj:t,size:i,ratio:s}=await this.getImageSize(e),this.isReady=!0,this.imageData={url:e,...i,ratio:s,imageObj:t},this.emit("imageSelectChange",this.imageData))}selectImage(){this.el||(this.el=document.createElement("input"),this.el.style.position="fixed",this.el.style.left="-9999999px",this.el.type="file",this.el.accept="image/*",this.el.addEventListener("change",this.onImageSelectChange),document.body.appendChild(this.el)),this.el.click()}}class KeyCommand{app;keyPosit;shortcutMap;constructor(e){this.app=e,this.keyPosit=keyPosit,this.shortcutMap={},this.bindEvent()}getKeyCodeArr(e){e=(e=e.replace(/\+\+/,"+add")).split(/\s*\+\s*/).map(e=>"add"===e?"+":e);const t=[];return e.forEach(e=>{t.push(keyPosit[e])}),t}getOriginEventCodeArr(e){var t=[];return(e.ctrlKey||e.metaKey)&&t.push(keyPosit.Control),e.altKey&&t.push(keyPosit.Alt),e.shiftKey&&t.push(keyPosit.Shift),t.includes(e.keyCode)||t.push(e.keyCode),t}checkKey(e,t){const i=this.getOriginEventCodeArr(e);var s=this.getKeyCodeArr(t);if(i.length!==s.length)return!1;for(let t=0;t<i.length;t+=1){var o=s.findIndex(e=>e===i[t]);if(-1===o)return!1;s.splice(o,1)}return!0}onKeydown(t){Object.keys(this.shortcutMap).forEach(e=>{this.checkKey(t,e)&&(t.stopPropagation(),t.preventDefault(),this.shortcutMap[e].forEach(e=>{e.fn.call(e.ctx)}))})}addShortcut(e,t,i){e.split(/\s*\|\s*/).forEach(e=>{this.shortcutMap[e]?this.shortcutMap[e].push({fn:t,ctx:i}):this.shortcutMap[e]=[{fn:t,ctx:i}]})}removeShortcut(e,i){e.split(/\s*\|\s*/).forEach(e=>{var t;this.shortcutMap[e]&&(i?-1!==(t=this.shortcutMap[e].findIndex(e=>e.fn===i))&&this.shortcutMap[e].splice(t,1):(this.shortcutMap[e]=[],delete this.shortcutMap[e]))})}bindEvent(){this.app.event.on("keydown",this.onKeydown,this)}unBindEvent(){this.app.event.off("keydown",this.onKeydown)}}const checkIsAtRectangleInner=(e,t)=>checkCoordinateIsInRectangle(t.x,t.y,e)?e:null,getCircleRadius=(e,t)=>Math.min(Math.abs(e),Math.abs(t))/2,checkIsAtMultiplexSegment=(e,t)=>{let i=!1;return e.forEach(e=>{i||checkIsAtSegment(t.x,t.y,...e,CLICK_DISTANCE)&&(i=!0)}),i},checkIsAtCircleEdge=(e,t)=>{var{width:i,height:s,x:o,y:a}=e,i=getCircleRadius(i,s),s=getTowCoordinateDistance(t.x,t.y,o+i,a+i);return s>=i-CLICK_DISTANCE&&s<=i+CLICK_DISTANCE?e:null},checkIsAtRectangleEdge=(e,t)=>{var{x:i,y:s,width:o,height:a}=e,o=[[i,s,i+o,s],[i+o,s,i+o,s+a],[i+o,s+a,i,s+a],[i,s+a,i,s]];return checkIsAtMultiplexSegment(o,t)?e:null},checkIsAtTriangleEdge=(e,t)=>{var{x:i,y:s,width:o,height:a}=e,a=[[i+o/2,s,i+o,s+a],[i+o,s+a,i,s+a],[i,s+a,i+o/2,s]];return checkIsAtMultiplexSegment(a,t)?e:null},checkIsAtDiamondEdge=(e,t)=>{var{x:i,y:s,width:o,height:a}=e,a=[[i+o/2,s,i+o,s+a/2],[i+o,s+a/2,i+o/2,s+a],[i+o/2,s+a,i,s+a/2],[i,s+a/2,i+o/2,s]];return checkIsAtMultiplexSegment(a,t)?e:null},checkIsAtArrowEdge=(e,t)=>{var i=e["coordinateArr"];return void 0!==i&&(i=[[i[0][0],i[0][1],i[i.length-1][0],i[i.length-1][1]]],checkIsAtMultiplexSegment(i,t))?e:null},checkIsAtArbitraryPlotLineEdge=(t,i)=>{let s=null;return void 0===t.coordinateArr?null:(t.coordinateArr.forEach(e=>{s||getTowCoordinateDistance(i.x,i.y,e[0],e[1])<=CLICK_DISTANCE&&(s=t)}),s)},checkIsAtLineEdge=(e,t)=>{var i=[];if(void 0===e.coordinateArr)return null;var s=e.coordinateArr.length,o=e.coordinateArr;for(let e=0;e<s-1;e+=1)i.push([...o[e],...o[e+1]]);return checkIsAtMultiplexSegment(i,t)?e:null};var checkClick=Object.freeze({__proto__:null,checkIsAtRectangleInner:checkIsAtRectangleInner,getCircleRadius:getCircleRadius,checkIsAtMultiplexSegment:checkIsAtMultiplexSegment,checkIsAtCircleEdge:checkIsAtCircleEdge,checkIsAtRectangleEdge:checkIsAtRectangleEdge,checkIsAtTriangleEdge:checkIsAtTriangleEdge,checkIsAtDiamondEdge:checkIsAtDiamondEdge,checkIsAtArrowEdge:checkIsAtArrowEdge,checkIsAtArbitraryPlotLineEdge:checkIsAtArbitraryPlotLineEdge,checkIsAtLineEdge:checkIsAtLineEdge});class BaseNode extends EventEmitter{app;id;type;key;isCreate;isActive;isSelected;startX;startY;x;y;width;height;startRotate;rotate;noRender;style;dragNode;constructor(e,t){super(),this.app=t,this.id=e.id,this.type=e.type||"",this.key=createNodeKey(),this.isCreate=!0,this.isActive=!0,this.isSelected=!1,this.startX=0,this.startY=0,this.x=e.x||0,this.y=e.y||0,this.width=e.width||0,this.height=e.height||0,this.startRotate=0,this.rotate=e.rotate||0,this.noRender=!1,this.style={strokeStyle:this.app.state.defaultColor,fillStyle:"transparent",lineWidth:2,lineDash:0,globalAlpha:1,...e.style||{}},this.dragNode=void 0}isClick(e,t){throw new Error("Subclasses need to implement this method!")}offsetRotate(e){return this.updateRotate(this.startRotate+e),this}setStyle(e={}){const t=e;return Object.keys(t).forEach(e=>{"lineDash"===e?0<t.lineDash&&this.app.ctx.setLineDash([t.lineDash]):void 0!==t[e]&&""!==t[e]&&null!==t[e]&&(this.app.ctx[e]=t[e])}),this}warpRender(e){var{x:t,y:i,width:s,height:o,rotate:a,style:n}=this,{x:t,y:i}=this.app.calculate.transform(t,i),s=s/2,o=o/2,r=t+s,h=i+o;return this.app.ctx.save(),this.app.ctx.translate(r,h),this.app.ctx.rotate(degToRad(a)),this.setStyle(n),e({halfWidth:s,halfHeight:o,tx:t,ty:i,cx:r,cy:h}),this.app.ctx.restore(),this}saveState(){var{rotate:e,x:t,y:i}=this;return this.startRotate=e,this.startX=t,this.startY=i,this}move(e,t){var{startX:i,startY:s}=this;return this.x=i+e,this.y=s+t,this.emit("nodePositionChange",this.x,this.y),this}updateRotate(e){this.rotate=e=(e%=360)<0?360+e:e,this.emit("nodeRotateChange",this.rotate)}rotateByCenter(e,t,i){this.offsetRotate(e);t=getRotatedCoordinate(this.startX,this.startY,t,i,e);this.updatePos(t.x,t.y)}startResize(e,t){return this.dragNode.startResize(e,t),this}endResize(){return this.dragNode.endResize(),this}resize(...e){return this.dragNode.handleResizeNode(...e),this}getEndCoordinateList(){return getNodeFourCorners(this)}updateRect(e,t,i,s){return this.updatePos(e,t),this.updateSize(i,s),this}updateSize(e,t){return this.width=e,this.height=t,this.emit("nodeSizeChange",this.width,this.height),this}updatePos(e,t){return this.x=e,this.y=t,this.emit("nodePositionChange",this.x,this.y),this}serialize(){return{id:this.id,type:this.type,width:this.width,height:this.height,x:this.x,y:this.y,rotate:this.rotate,style:{...this.style}}}renderDragNode(){this.isActive&&!this.isCreate?(this.dragNode.showAll(),this.dragNode.render()):this.isSelected&&(this.dragNode.onlyShowBody(),this.dragNode.render())}render(){throw new Error("Subclasses need to implement this methodï¼")}}class BaseMultiplexCoordinateNode extends BaseNode{startCoordinateArr;coordinateArr;startWidth;startHeight;fictitiousCoordinate;constructor(e,t){super(e,t),this.startCoordinateArr=[],this.coordinateArr=e.coordinateArr||[],this.startWidth=0,this.startHeight=0,this.fictitiousCoordinate={x:0,y:0}}updateRect(e,t,i,s){var{startWidth:o,startHeight:a,startCoordinateArr:n}=this;if(void 0!==o&&void 0!==a){const r=i/o,h=s/a;this.coordinateArr=n.map(e=>{return[e[0]*r,e[1]*h,...e.slice(2)]});o=getBoundingRect(this.coordinateArr);const d=o.x-e,l=o.y-t;this.coordinateArr=this.coordinateArr.map(e=>[e[0]-d,e[1]-l,...e.slice(2)]),this.updatePos(e,t),this.updateSize(i,s)}return this}rotateByCenter(i,s,o){this.coordinateArr=this.startCoordinateArr.map(e=>{var t=getRotatedCoordinate(e[0],e[1],s,o,i);return[t.x,t.y,...e.slice(2)]}),this.updateMultiplexCoordinateBoundingRect()}serialize(){return{...super.serialize(),coordinateArr:[...this.coordinateArr]}}getEndCoordinateList(){return this.coordinateArr.map(e=>{var t=getNodeCenterCoordinate(this),e=getRotatedCoordinate(e[0],e[1],t.x,t.y,this.rotate);return{x:e.x,y:e.y}})}addCoordinate(e,t,...i){if(Array.isArray(this.coordinateArr))return this.coordinateArr.push([e,t,...i]),this}updateMultiplexCoordinateBoundingRect(){var e=getBoundingRect(this.coordinateArr);return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}updateFictitiousCoordinate(e,t){this.fictitiousCoordinate.x=e,this.fictitiousCoordinate.y=t}move(t,i){this.coordinateArr=this.startCoordinateArr.map(e=>[e[0]+t,e[1]+i,...e.slice(2)]);var{startX:e,startY:s}=this;return e&&s&&(this.x=e+t,this.y=s+i),this}saveState(){var{rotate:e,x:t,y:i,width:s,height:o,coordinateArr:a}=this;return this.startRotate=e,this.startX=t,this.startY=i,this.startCoordinateArr=deepCopy(a),this.startWidth=s,this.startHeight=o,this}}const plotWrap=(e,t,i=!1)=>{e.beginPath(),t(),e.stroke(),i&&e.fill()},plotCircle=(e,t,i,s,o=!1)=>{plotWrap(e,()=>{e.arc(t,i,s,0,2*Math.PI)},o)},plotArrow=(i,e)=>{const t=e[0][0],s=e[0][1],o=e[e.length-1][0],a=e[e.length-1][1],n=(plotWrap(i,()=>{i.moveTo(t,s),i.lineTo(o,a)},!0),radToDeg(Math.atan2(a-s,o-t)));plotWrap(i,()=>{var e=30-n,t=o-30*Math.cos(degToRad(e)),e=a+30*Math.sin(degToRad(e));i.moveTo(t,e),i.lineTo(o,a)},!0),plotWrap(i,()=>{var e=90-n-30,t=o-30*Math.sin(degToRad(e)),e=a-30*Math.cos(degToRad(e));i.moveTo(t,e),i.lineTo(o,a)})},plotRect=(e,t,i,s,o,a=!1)=>{plotWrap(e,()=>{e.rect(t,i,s,o),a&&e.fillRect(t,i,s,o)})},plotDiamond=(e,t,i,s,o,a=!1)=>{plotWrap(e,()=>{e.moveTo(t+s/2,i),e.lineTo(t+s,i+o/2),e.lineTo(t+s/2,i+o),e.lineTo(t,i+o/2),e.closePath()},a)},transformArbitraryLineCoordinate=(e,t)=>{var{x:i,y:s}=t.app.calculate.transform(e[0],e[1]);return[i-t.cx,s-t.cy,...e.slice(2)]},plotLineSegment=(e,t,i,s,o,a=0)=>{plotWrap(e,()=>{0<a&&(e.lineWidth=a),e.moveTo(t,i),e.lineTo(s,o),e.lineCap="round",e.lineJoin="round"})},plotTriangle=(e,t,i,s,o,a=!1)=>{plotWrap(e,()=>{e.moveTo(t+s/2,i),e.lineTo(t+s,i+o),e.lineTo(t,i+o),e.closePath()},a)},plotArbitraryLine=(s,o,a)=>{for(let i=0;i<o.length-1;i+=1)plotWrap(s,()=>{var e=transformArbitraryLineCoordinate(o[i],a),t=transformArbitraryLineCoordinate(o[i+1],a);plotLineSegment(s,e[0],e[1],t[0],t[1],t[2])},!0)},plotText=(i,e,s,o)=>{const{text:t,style:a}=e,n=a.fontSize*a.lineHeightRatio;plotWrap(i,()=>{i.font=getFontString(a.fontSize,a.fontFamily),i.textBaseline="middle",splitTextLines(t).forEach((e,t)=>{i.fillText(e,s,o+(t*n+n/2))})})},plotImage=(i,s,o,a,n,r)=>{plotWrap(i,()=>{let e=0,t=0;n/r>s.ratio?(t=r,e=s.ratio*r):(e=n,t=n/s.ratio),i.drawImage(s.imageObj,o,a,e,t)})},plotLine=(i,e)=>{plotWrap(i,()=>{let t=!0;e.forEach(e=>{t?(t=!1,i.moveTo(e[0],e[1])):i.lineTo(e[0],e[1])})})};var plot=Object.freeze({__proto__:null,plotWrap:plotWrap,plotCircle:plotCircle,plotArrow:plotArrow,plotRect:plotRect,plotDiamond:plotDiamond,plotLineSegment:plotLineSegment,plotTriangle:plotTriangle,plotArbitraryLine:plotArbitraryLine,plotText:plotText,plotImage:plotImage,plotLine:plotLine});class DragNode extends BaseNode{options;node;offset;size;resizeType;diagonalCoordinate;mousedownPosAndNodePosOffset;nodeRatio;hideParts;constructor(e,t,i={}){super({type:"dragNode",notNeedDragNode:!0},t),this.options={lockRatio:!1,...i},this.style={strokeStyle:"#666",fillStyle:"transparent",lineWidth:"small",lineDash:0,globalAlpha:1},this.node=e,this.offset=5,this.size=10,this.resizeType="",this.diagonalCoordinate={x:0,y:0},this.mousedownPosAndNodePosOffset={x:0,y:0},this.nodeRatio=0,this.hideParts=[],this.x=0,this.y=0}startResize(e,t){this.resizeType=e,this.options.lockRatio&&(this.nodeRatio=this.node.width/this.node.height),e===DRAG_NODE_PARTS.BODY||e===DRAG_NODE_PARTS.ROTATE?this.node.saveState():e===DRAG_NODE_PARTS.TOP_LEFT_BUTTON?this.handleDragMousedown(t,FOUR_CORNER.TOP_LEFT):e===DRAG_NODE_PARTS.TOP_RIGHT_BUTTON?this.handleDragMousedown(t,FOUR_CORNER.TOP_RIGHT):e===DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON?this.handleDragMousedown(t,FOUR_CORNER.BOTTOM_RIGHT):e===DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON&&this.handleDragMousedown(t,FOUR_CORNER.BOTTOM_LEFT)}endResize(){this.resizeType="",this.diagonalCoordinate={x:0,y:0},this.mousedownPosAndNodePosOffset={x:0,y:0},this.nodeRatio=0}handleDragMousedown(e,t){var i=getNodeCenterCoordinate(this.node),t=getNodeRotatedFourCornerCoordinate(this.node,t);this.diagonalCoordinate.x=2*i.x-t.x,this.diagonalCoordinate.y=2*i.y-t.y,this.mousedownPosAndNodePosOffset.x=e.clientX-t.x,this.mousedownPosAndNodePosOffset.y=e.clientY-t.y,this.node.saveState()}handleResizeNode(e,t,i,s,o){var a=this["resizeType"];a===DRAG_NODE_PARTS.BODY?this.handleMoveNode(s,o):a===DRAG_NODE_PARTS.ROTATE?this.handleRotateNode(e,t,i):a===DRAG_NODE_PARTS.TOP_LEFT_BUTTON?this.handleStretchNode(e,(e,t)=>({width:2*(e.x-t.x),height:2*(e.y-t.y)}),e=>({x:e.x,y:e.y}),(e,t)=>{let i=t["x"],s=t["y"];return e>this.nodeRatio?i=t.x+t.width-this.nodeRatio*t.height:e<this.nodeRatio&&(s=t.y+(t.height-t.width/this.nodeRatio)),{x:i,y:s}}):a===DRAG_NODE_PARTS.TOP_RIGHT_BUTTON?this.handleStretchNode(e,(e,t)=>({width:2*(t.x-e.x),height:2*(e.y-t.y)}),(e,t)=>({x:e.x-t.width,y:e.y}),(e,t)=>{let i=t["x"],s=t["y"];return e>this.nodeRatio?i=t.x+this.nodeRatio*t.height:e<this.nodeRatio&&(i=t.x+t.width,s=t.y+(t.height-t.width/this.nodeRatio)),{x:i,y:s}}):a===DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON?this.handleStretchNode(e,(e,t)=>({width:2*(t.x-e.x),height:2*(t.y-e.y)}),(e,t)=>({x:e.x-t.width,y:e.y-t.height}),(e,t)=>{let i=t["x"],s=t["y"];return e>this.nodeRatio?(i=t.x+this.nodeRatio*t.height,s=t.y+t.height):e<this.nodeRatio&&(i=t.x+t.width,s=t.y+t.width/this.nodeRatio),{x:i,y:s}}):a===DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON&&this.handleStretchNode(e,(e,t)=>({width:2*(e.x-t.x),height:2*(t.y-e.y)}),(e,t)=>({x:e.x,y:e.y-t.height}),(e,t)=>{let i=t["x"],s=t["y"];return e>this.nodeRatio?(i=t.x+t.width-this.nodeRatio*t.height,s=t.y+t.height):e<this.nodeRatio&&(s=t.y+t.width/this.nodeRatio),{x:i,y:s}})}handleMoveNode(e,t){this.node.move(e,t)}handleRotateNode(e,t,i){var s=getNodeCenterCoordinate(this.node),s=getTowCoordinateRotate(s.x,s.y,e.clientX,e.clientY,t,i);this.node.offsetRotate(s)}setHideParts(e=[]){this.hideParts=e}showAll(){this.setHideParts([])}onlyShowBody(){this.setHideParts([DRAG_NODE_PARTS.ROTATE,DRAG_NODE_PARTS.TOP_LEFT_BUTTON,DRAG_NODE_PARTS.TOP_RIGHT_BUTTON,DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON,DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON])}update(){this.x=this.node.x-this.offset,this.y=this.node.y-this.offset,this.width=this.node.width+2*this.offset,this.height=this.node.height+2*this.offset,this.rotate=this.node.rotate}stretchCalc(e,t,i,s){var o={x:(e+this.diagonalCoordinate.x)/2,y:(t+this.diagonalCoordinate.y)/2},e=transformCoordinateReverseRotate(e,t,o.x,o.y,this.node.rotate),t=i(o,e);let a=!1,n=(t.width<0&&(t.width=0,a=!0),!1);t.height<0&&(t.height=0,n=!0);i=s(e,t),s={x:i.x,y:i.y,width:t.width,height:t.height};return(a||n)&&(s.x=this.node.x,s.y=this.node.y),{newRect:s,newCenter:o}}handleStretchNode(e,t,i,s){var o=e.clientX-this.mousedownPosAndNodePosOffset.x,e=e.clientY-this.mousedownPosAndNodePosOffset.y,{newRect:o,newCenter:e}=this.stretchCalc(o,e,t,i);this.options.lockRatio?this.fixStretch(o,e,t,i,s):this.node.updateRect(o.x,o.y,o.width,o.height)}fixStretch(e,t,i,s,o){o=o(e.width/e.height,e),e=getRotatedCoordinate(o.x,o.y,t.x,t.y,this.node.rotate),o=this.stretchCalc(e.x,e.y,i,s).newRect;0===o.width&&0===o.height||this.node.updateRect(o.x,o.y,o.width,o.height)}render(){this.update();const{width:i,height:s}=this;this.warpRender(({halfWidth:e,halfHeight:t})=>{this.app.ctx.save(),this.hideParts.includes(DRAG_NODE_PARTS.BODY)||(this.app.ctx.setLineDash([5]),plotRect(this.app.ctx,-e,-t,i,s),this.app.ctx.restore()),this.hideParts.includes(DRAG_NODE_PARTS.TOP_LEFT_BUTTON)||plotRect(this.app.ctx,-e-this.size,-t-this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.TOP_RIGHT_BUTTON)||plotRect(this.app.ctx,-e+this.node.width+this.size,-t-this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON)||plotRect(this.app.ctx,-e+this.node.width+this.size,-t+this.node.height+this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON)||plotRect(this.app.ctx,-e-this.size,-t+this.node.height+this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.ROTATE)||plotCircle(this.app.ctx,-e+this.node.width/2+this.size/2,-t-2*this.size,this.size)})}checkCoordinateInDragNodeWhere(e,t){let i="";e=transformCoordinateOnNode(e,t,this.node);return checkCoordinateIsInRectangle(e.x,e.y,this)?i=DRAG_NODE_PARTS.BODY:getTowCoordinateDistance(e.x,e.y,this.x+this.width/2,this.y-2*this.size)<=this.size?i=DRAG_NODE_PARTS.ROTATE:this._checkCoordinateIsInButton(e.x,e.y,FOUR_CORNER.TOP_LEFT)?i=DRAG_NODE_PARTS.TOP_LEFT_BUTTON:this._checkCoordinateIsInButton(e.x,e.y,FOUR_CORNER.TOP_RIGHT)?i=DRAG_NODE_PARTS.TOP_RIGHT_BUTTON:this._checkCoordinateIsInButton(e.x,e.y,FOUR_CORNER.BOTTOM_RIGHT)?i=DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON:this._checkCoordinateIsInButton(e.x,e.y,FOUR_CORNER.BOTTOM_LEFT)&&(i=DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON),i=this.hideParts.includes(i)?"":i}_checkCoordinateIsInButton(e,t,i){let s=0,o=0;switch(i){case FOUR_CORNER.TOP_LEFT:s=this.x-this.size,o=this.y-this.size;break;case FOUR_CORNER.TOP_RIGHT:s=this.x+this.width,o=this.y-this.size;break;case FOUR_CORNER.BOTTOM_RIGHT:s=this.x+this.width,o=this.y+this.height;break;case FOUR_CORNER.BOTTOM_LEFT:s=this.x-this.size,o=this.y+this.height}return checkCoordinateIsInRectangle(e,t,s,o,this.size,this.size)}}class ArbitraryPlot extends BaseMultiplexCoordinateNode{lastLineWidth;constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app),this.lastLineWidth=-1}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtArbitraryPlotLineEdge(this,e)}singleRender(e,t,i,s,o){this.app.ctx.save(),plotLineSegment(this.app.ctx,e,t,i,s,o),this.app.ctx.restore()}render(){const i=this["coordinateArr"];this.warpRender(({cx:e,cy:t})=>{plotArbitraryLine(this.app.ctx,i,{app:this.app,cx:e,cy:t})}),this.renderDragNode()}}class Arrow extends BaseMultiplexCoordinateNode{constructor(e,t){super(e,t),this.dragNode=new DragNode(this,t)}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtArrowEdge(this,e)}render(){const{coordinateArr:a,fictitiousCoordinate:n}=this;this.warpRender(({cx:i,cy:s})=>{let e=[];var t,o;0<a.length&&this.isCreate&&({x:t,y:o}=this.app.calculate.transform(n.x-i,n.y-s),e=[[t,o]]),plotArrow(this.app.ctx,a.map(e=>{var{x:e,y:t}=this.app.calculate.transform(e[0],e[1]);return[e-i,t-s]}).concat(e))}),this.renderDragNode()}}class Circle extends BaseNode{constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app,{lockRatio:!0})}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtCircleEdge(this,e)}render(){const{width:e,height:t}=this;this.warpRender(()=>{plotCircle(this.app.ctx,0,0,getCircleRadius(e,t),!0)}),this.renderDragNode()}}class Diamond extends BaseNode{constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app)}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtDiamondEdge(this,e)}getEndCoordinateList(){const{x:e,y:t,width:i,height:s,rotate:o}=this;var a=[[e+i/2,t],[e+i,t+s/2],[e+i/2,t+s],[e,t+s/2]];const n=getNodeCenterCoordinate(this);return a.map(e=>getRotatedCoordinate(e[0],e[1],n.x,n.y,o))}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:e,halfHeight:t})=>{plotDiamond(this.app.ctx,-e,-t,i,s,!0)}),this.renderDragNode()}}let Image$1=class extends BaseNode{url;imageObj;ratio;constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app,{lockRatio:!0});var{url:t,imageObj:e,ratio:i}=e;this.url=t||"",this.imageObj=e||null,this.ratio=i||1}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtRectangleInner(this,e)}serialize(){return{...super.serialize(),url:this.url,ratio:this.ratio}}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:e,halfHeight:t})=>{plotImage(this.app.ctx,this,-e,-t,i,s)}),this.renderDragNode()}};class Line extends BaseMultiplexCoordinateNode{isSingle;constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app);var{isSingle:t=!1}=e;this.isSingle=t}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtLineEdge(this,e)}render(){const{coordinateArr:a,fictitiousCoordinate:n}=this;this.warpRender(({cx:i,cy:s})=>{let e=[];var t,o;0<a.length&&this.isCreate&&({x:t,y:o}=this.app.calculate.transform(n.x-i,n.y-s),e=[[t,o]]),plotLine(this.app.ctx,a.map(e=>{var{x:e,y:t}=this.app.calculate.transform(e[0],e[1]);return[e-i,t-s]}).concat(e))}),this.renderDragNode()}}class Rectangle extends BaseNode{constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app)}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtRectangleEdge(this,e)}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:e,halfHeight:t})=>{plotRect(this.app.ctx,-e,-t,i,s,!0)}),this.renderDragNode()}}class Text extends BaseNode{text;constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app,{lockRatio:!0}),this.text=e?.text||"",this.style.fillStyle=e?.style?.fillStyle||"#000000",this.style.fontSize=e?.style?.fontSize||18,this.style.lineHeightRatio=e?.style?.lineHeightRatio||1.5,this.style.fontFamily=e?.style?.fontFamily||"Microsoft YaHei, sans-serif"}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtRectangleInner(this,e)}updateRect(e,t,i,s){var{text:o,style:a}=this;this.style.fontSize=Math.floor(s/splitTextLines(o).length/a.lineHeightRatio),super.updateRect(e,t,i,s)}serialize(){return{...super.serialize(),text:this.text}}render(){this.warpRender(({halfWidth:e,halfHeight:t})=>{plotText(this.app.ctx,this,-e,-t)}),this.renderDragNode()}}class Triangle extends BaseNode{constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app)}getEndCoordinateList(){const{x:e,y:t,width:i,height:s,rotate:o}=this;var a=[[e+i/2,t],[e+i,t+s],[e,t+s]];const n=getNodeCenterCoordinate(this);return a.map(e=>getRotatedCoordinate(e[0],e[1],n.x,n.y,o))}isClick(e,t){e=transformCoordinateOnNode(e,t,this);return checkIsAtTriangleEdge(this,e)}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:e,halfHeight:t})=>{plotTriangle(this.app.ctx,-e,-t,i,s,!0)}),this.renderDragNode()}}class Nodes{app;nodeList;activeNode;isCreateNode;isResize;resizeNode;constructor(e){this.app=e,this.nodeList=[],this.activeNode=void 0,this.isCreateNode=!1,this.isResize=!1,this.resizeNode=null,this.handleResize=throttle(this.handleResize,this,15)}createNode(e,t=()=>{},i,s){return!this.hasActiveNode()&&!this.isCreateNode&&(e.id=getNodeID(),e=this.pureCreateNode(e))&&(this.addNode(e),s||this.setActiveNode(e),this.isCreateNode=!0,t.call(i,e)),this}copyNode(t,a,n){return new Promise(async o=>{var e;t&&("image"===(e=t.serialize?.()).type&&null!=e.url&&(e.imageObj=await createImageObj(e.url)),this.createNode(e,e=>{e.startResize(DRAG_NODE_PARTS.BODY);let t=20,i=20;n&&(t=n.x-e.x-e.width/2,i=n.y-e.y-e.height/2);var s=this.app.calculate.gridAdsorbent(t,i);e.resize(null,null,null,s.x,s.y),e.isCreate=!1,a&&(e.isActive=!1),this.isCreateNode=!1,o(e)},this,a))})}createRectangleLikeNode(e,t,i,s,o){this.createNode({type:e,x:t,y:i,width:s,height:o}),this.activeNode?.updateSize?.(s,o)}createCircle(e,t,i){this.createNode({type:"circle",x:e,y:t});i=getTowCoordinateDistance(i.clientX,i.clientY,e,t);this.activeNode?.updateSize?.(i,i)}createArbitraryPlot(e,t){this.createNode({type:"arbitrary-plot"});var i=this.activeNode,s=computedLineWidthBySpeed(t.mouseSpeed,i?.lastLineWidth),{calculate:o,ctx:a,state:n}=(i?.lastLineWidth&&(i.lastLineWidth=s),i?.addCoordinate?.(e.clientX,e.clientY,s),this.app),t=o.transformToCanvasCalculate(o.subScrollX(t.lastMousePos.x),o.subScrollY(t.lastMousePos.y)),o=o.transformToCanvasCalculate(o.subScrollX(e.clientX),o.subScrollY(e.clientY));a.save(),a.scale(n.scale,n.scale),i?.singleRender?.(t.x,t.y,o.x,o.y,s),a.restore()}createImage(e,{width:t,height:i,imageObj:s,url:o,ratio:a}){e=this.app.calculate.gridAdsorbent(e.unGridClientX-t/2,e.unGridClientY-i/2);this.createNode({type:"image",x:e.x,y:e.y,url:o,imageObj:s,width:t,height:i,ratio:a})}editingText(e){"text"===e.type&&(e.noRender=!0,this.setActiveNode(e))}completeEditingText(){var e=this.activeNode;e&&"text"===e.type&&(e?.text?.trim()?e.noRender=!1:(this.deleteNode(e),this.setActiveNode()))}completeCreateArrow(e){this.activeNode?.addCoordinate?.(e.clientX,e.clientY)}createArrow(t,i,e){this.createNode({type:"arrow",x:t,y:i},e=>{e.addCoordinate(t,i)}),this.activeNode?.updateFictitiousCoordinate?.(e.clientX,e.clientY)}createLine(t,i,e,s=!1,o=!1){o||this.createNode({type:"line",x:t,y:i,isSingle:s},e=>{e.addCoordinate(t,i)});o=this.activeNode;o&&o.updateFictitiousCoordinate?.(e.clientX,e.clientY)}insertNode(e,t){this.nodeList.splice(t,0,e)}addNode(e){return this.nodeList.push(e),this}getNodesNum(){return this.nodeList.length}hasNodes(){return 0<this.nodeList.length}unshiftNode(e){return this.nodeList.unshift(e),this}deleteNode(e){var t=this.getNodeIndex(e);return-1!==t&&(this.nodeList.splice(t,1),e.isActive)&&this.cancelActiveNode(),this}deleteAllNodes(){return this.activeNode=void 0,this.nodeList=[],this.isCreateNode=!1,this.isResize=!1,this.resizeNode=null,this}getNodeIndex(t){return this.nodeList.findIndex(e=>e===t)}createNodesFromData(e){return e.forEach(e=>{e=this.pureCreateNode(e);e.isActive=!1,e.isCreate=!1,this.addNode(e)}),this}hasActiveNode(){return this.activeNode}setActiveNode(e){return this.cancelActiveNode(),(this.activeNode=e)&&(e.isActive=!0),this.app.emit("activeNodeChange",this.activeNode),this}cancelActiveNode(){return this.hasActiveNode()&&(this.activeNode&&(this.activeNode.isActive=!1,this.activeNode=void 0),this.app.emit("activeNodeChange",this.activeNode)),this}checkIsClickNode(e){var t=e.unGridClientX,i=e.unGridClientY;for(let e=this.nodeList.length-1;0<=e;--e){var s=this.nodeList[e];if(s.isClick?.(t,i))return s}return null}pureCreateNode(e={}){switch(e.type){case"rectangle":return new Rectangle(e,this.app);case"diamond":return new Diamond(e,this.app);case"triangle":return new Triangle(e,this.app);case"circle":return new Circle(e,this.app);case"arbitrary-plot":return new ArbitraryPlot(e,this.app);case"image":return new Image$1(e,this.app);case"arrow":return new Arrow(e,this.app);case"line":return new Line(e,this.app);case"text":return new Text(e,this.app);default:return null}}completeCreateLine(e,t=()=>{}){let i=this.activeNode;var s=e.clientX,e=e.clientY;i&&i.isSingle?(i.addCoordinate?.(s,e),t()):(this.createNode({type:"line",isSingle:!1}),(i=this.activeNode)?.addCoordinate?.(s,e),i?.updateFictitiousCoordinate?.(s,e))}completeCreateNode(){this.isCreateNode=!1;var e=this.activeNode;return e&&(["arbitrary-plot","arrow","line"].includes(e.type)&&e.updateMultiplexCoordinateBoundingRect(),e.isCreate=!1,this.app.emitChange()),this}setActiveNodeStyle(t={}){return this.hasActiveNode()&&Object.keys(t).forEach(e=>{this.activeNode.style[e]=t[e]}),this}checkInResizeHand(e,t){var i=this.activeNode,e=i?.dragNode?.checkCoordinateInDragNodeWhere?.(e,t);return e?{node:i,hand:e}:null}checkIsResize(e,t,i){return!!this.hasActiveNode()&&!!(e=this.checkInResizeHand(e,t))&&(this.isResize=!0,e.node&&(this.resizeNode=e.node,this.resizeNode.startResize?.(e.hand,i)),this.app.cursor.setResize(e.hand),!0)}handleResize(...e){this.isResize&&this.resizeNode?.resize?.(...e)}endResize(){this.isResize=!1,this.resizeNode?.endResize?.(),this.resizeNode=null}serialize(e=!1){var t=this.nodeList.map(e=>e.serialize?.());return e?JSON.stringify(t):t}}class Render{app;beingCopyActiveNode;beingCopySelectedNodes;beingCopyNode;constructor(e){this.app=e,this.beingCopyActiveNode=null,this.beingCopySelectedNodes=[],this.registerShortcutKeys()}setActiveNodeStyle(e={}){return this.app.nodes.hasActiveNode()&&(this.app.nodes.setActiveNodeStyle(e),this.render(),this.app.nodes.isCreateNode||this.app.emitChange()),this}setCurrentNodesStyle(e={}){this.setActiveNodeStyle(e),this.app.selection.setSelectedNodeStyle(e)}clearCanvas(){var{width:e,height:t}=this.app;return this.app.ctx.clearRect(-e/2,-t/2,e,t),this}render(){var e=this.app["state"];return this.clearCanvas(),this.app.ctx.save(),this.app.ctx.scale(e.scale,e.scale),this.app.nodes.nodeList.forEach(e=>{e.noRender||e.render()}),this.app.ctx.restore(),this}registerShortcutKeys(){this.app.keyCommand.addShortcut("Control+a",()=>{this.selectAll()}),this.app.keyCommand.addShortcut("Control+0",()=>{this.setZoom(1)}),this.app.keyCommand.addShortcut("Del|Backspace",()=>{this.deleteCurrentNodes()}),this.app.keyCommand.addShortcut("Control+c",()=>{this.copyCurrentNode()}),this.app.keyCommand.addShortcut("Control+x",()=>{this.cutCurrentNode()}),this.app.keyCommand.addShortcut("Control+z",()=>{this.app.history.undo()}),this.app.keyCommand.addShortcut("Control+'",()=>{this.app.state.showGrid?this.app.grid.hideGrid():this.app.grid.showGrid()}),this.app.keyCommand.addShortcut("Control+y",()=>{this.app.history.redo()}),this.app.keyCommand.addShortcut("Control+v",()=>{this.pasteCurrentNode(!0)})}copyCurrentNode(){this.app.nodes.activeNode?(this.beingCopySelectedNodes=[],this.beingCopyNode=this.app.nodes.activeNode):this.app.selection.hasSelectionNodes()&&(this.beingCopyNode=void 0,this.beingCopySelectedNodes=this.app.selection.getSelectionNodes())}cutCurrentNode(){this.app.nodes.activeNode?(this.copyCurrentNode(),this.deleteCurrentNodes()):this.app.selection.hasSelectionNodes()&&(this.copyCurrentNode(),this.deleteCurrentNodes(),this.app.selection.setMultiplexSelectNodes(this.beingCopySelectedNodes),this.app.selection.emitChange())}pasteCurrentNode(e=!1){let t=null;var i,s;e&&(i=this.app.event.lastMousePos["x"],s=this.app.event.lastMousePos["y"],t={x:i,y:s}),this.beingCopyNode?this.copyNode(this.beingCopyNode,!1,t).then(()=>{}):0<this.beingCopySelectedNodes.length&&this.app.selection.copySelectionNodes(e?t:null)}deleteNode(e){this.app.nodes.deleteNode(e),this.render(),this.app.emitChange()}async copyNode(e,t,i){this.app.nodes.cancelActiveNode(),await this.app.nodes.copyNode(e,t,i),this.render(),this.app.emitChange()}deleteActiveNode(){this.app.nodes.hasActiveNode()&&this.deleteNode(this.app.nodes.activeNode)}deleteCurrentNodes(){this.deleteActiveNode(),this.app.selection.deleteSelectedNodes()}cancelActiveNode(){return this.app.nodes.hasActiveNode()&&(this.app.nodes.cancelActiveNode(),this.render()),this}updateActiveNodePosition(e,t){return this.app.nodes.hasActiveNode()&&(this.app.nodes.activeNode.updatePos(e,t),this.render()),this}updateActiveNodeSize(e,t){return this.app.nodes.hasActiveNode()&&(this.app.nodes.activeNode.updateSize(e,t),this.render()),this}updateActiveNodeRotate(e){return this.app.nodes.hasActiveNode()&&(this.app.nodes.activeNode.updateRotate(e),this.render()),this}empty(){this.app.nodes.deleteAllNodes(),this.render(),this.app.emitChange()}zoomIn(e=.1){this.app.state.scale&&(this.app.updateState({scale:this.app.state.scale+e}),this.render(),this.app.emit("zoomChange",this.app.state.scale))}zoomOut(e=.1){this.app.state.scale&&(this.app.updateState({scale:0<this.app.state.scale-e?this.app.state.scale-e:0}),this.render(),this.app.emit("zoomChange",this.app.state.scale))}setZoom(e){e<0||1<e||(this.app.updateState({scale:e}),this.render(),this.app.emit("zoomChange",this.app.state.scale))}fit(){var e,t,i,s;this.app.nodes.hasNodes()&&(this.scrollToCenter(),{minX:e,maxX:s,minY:t,maxY:i}=getMultiplexNodeRectInfo(this.app.nodes.nodeList),s=Math.min(this.app.width/(s-e),this.app.height/(i-t)),this.setZoom(s))}scrollTo(e,t){this.app.updateState({scrollX:e,scrollY:t}),this.render(),this.app.emit("scrollChange",this.app.state.scrollX,this.app.state.scrollY)}scrollToCenter(){var e,t,i,s;this.app.nodes.hasNodes()?({minX:e,maxX:t,minY:i,maxY:s}=getMultiplexNodeRectInfo(this.app.nodes.nodeList),this.scrollTo(e-(this.app.width-(t-e))/2,i-(this.app.height-(s-i))/2)):this.scrollTo(0,0)}copyPasteCurrentNodes(){this.copyCurrentNode(),this.pasteCurrentNode()}setBackgroundColor(e){this.app.updateState({backgroundColor:e}),this.app.background.set()}selectAll(){this.app.selection.selectNodes(this.app.nodes.nodeList)}}class Calculate{app;constructor(e){this.app=e}transformToCanvasCalculate(e,t){return{x:e-=this.app.width/2,y:t-=this.app.height/2}}gridAdsorbent(e,t){var{gridConfig:i,showGrid:s}=this.app.state;return void 0===i?{}:s?void 0===(s=i.size)?{}:{x:e-e%s,y:t-t%s}:{x:e,y:t}}addScrollY(e){return void 0===this.app.state.scrollY?0:this.app.state.scrollY+e}addScrollX(e){return void 0===this.app.state.scrollX?0:this.app.state.scrollX+e}subScrollY(e){return void 0===this.app.state.scrollY?0:e-this.app.state.scrollY}subScrollX(e){return void 0===this.app.state.scrollX?0:e-this.app.state.scrollX}transformToScreenCalculate(e,t){return{x:e+=this.app.width/2,y:t+=this.app.height/2}}transform(e,t){e=this.transformToCanvasCalculate(e,t);return{x:this.subScrollX(e.x),y:this.subScrollY(e.y)}}mountELToWindow(e,t){return{x:e+this.app.left,y:t+this.app.top}}windowToContainer(e,t){return{x:e-this.app.left,y:t-this.app.top}}scale(e,t){var i=this.app["state"];return void 0===i.scale?{}:(e=this.transformToCanvasCalculate(e,t),{x:(t=this.transformToScreenCalculate(e.x*i.scale,e.y*i.scale)).x,y:t.y})}reverseScale(e,t){var i=this.app["state"];return void 0===i.scale?{}:(e=this.transformToCanvasCalculate(e,t),{x:(t=this.transformToScreenCalculate(e.x/i.scale,e.y/i.scale)).x,y:t.y})}}class MultiplexSelectNode extends BaseNode{selectedNodeList;wholeCenterPos;constructor(e,t){super(e,t),this.dragNode=new DragNode(this,this.app),this.selectedNodeList=[],this.wholeCenterPos={x:0,y:0}}updateNodes(t){const i=[];this.selectedNodeList.forEach(e=>{t.includes(e)&&i.push(e)}),this.setSelectedNodeList(i)}updateRect(){var e,t,i,s;this.selectedNodeList.length<=0?super.updateRect(0,0,0,0):({minX:e,maxX:t,minY:i,maxY:s}=getMultiplexNodeRectInfo(this.selectedNodeList),super.updateRect(e,i,t-e,s-i))}resize(...t){this.selectedNodeList.forEach(e=>{e.dragNode&&"rotate"===e.dragNode.resizeType?this.handleRotate(e,...t):e?.resize?.(...t)})}handleRotate(e,t,i,s){t=getTowCoordinateRotate(this.wholeCenterPos.x,this.wholeCenterPos.y,t.clientX,t.clientY,i,s);e.rotateByCenter?.(t,this.wholeCenterPos.x,this.wholeCenterPos.y)}endResize(){this.selectedNodeList.forEach(e=>{e.endResize?.()})}setSelectedNodeList(e){this.selectedNodeList.forEach(e=>{e.isSelected=!1}),this.selectedNodeList=e,this.selectedNodeList.forEach(e=>{e.isSelected=!0})}startResize(...t){this.selectedNodeList.forEach(e=>{"rotate"===t[0]&&(this.wholeCenterPos=getNodeCenterCoordinate(this)),e.startResize?.(...t)})}render(){this.width&&this.height&&0<this.selectedNodeList.length&&(this.width<=0||this.height<=0||this.dragNode.render())}}class Selection{app;canvas;ctx;createSelection;hasSelection;isResize;state;width;height;calculate;rectangle;multiplexSelectNode;constructor(e){this.app=e,this.canvas=null,this.ctx=void 0,this.createSelection=!1,this.hasSelection=!1,this.isResize=!1,this.state=this.app.state,this.width=this.app.width,this.height=this.app.height,this.calculate=new Calculate(this),this.rectangle=new Rectangle({type:"rectangle",style:{strokeStyle:"rgba(9,132,227,0.3)",fillStyle:"rgba(9,132,227,0.3)"}},this),this.multiplexSelectNode=new MultiplexSelectNode({type:"multiplexSelectNode"},this),this.checkInNodes=throttle(this.checkInNodes,this,20),this.handleResize=throttle(this.handleResize,this,15),this.init(),this.bindEvent()}checkInNodes(e,t){const n=Math.min(t.mousedownPos.x,e.clientX),r=Math.min(t.mousedownPos.y,e.clientY),h=Math.max(t.mousedownPos.x,e.clientX),d=Math.max(t.mousedownPos.y,e.clientY),l=[];this.app.nodes.nodeList.forEach(e=>{let i=1/0,s=-1/0,o=1/0,a=-1/0;var t=e?.getEndCoordinateList?.();getBoundingRect(t.map(e=>[e.x,e.y]),!0).forEach(({x:e,y:t})=>{e<i&&(i=e),e>s&&(s=e),t<o&&(o=t),t>a&&(a=t)}),i>=n&&s<=h&&o>=r&&a<=d&&l.push(e)}),this.setMultiplexSelectNodes(l,!0),this.app.render.render()}checkInResizeHand(e,t){return this.multiplexSelectNode.dragNode.checkCoordinateInDragNodeWhere(e,t)}deleteSelectedNodes(){this.getSelectionNodes().forEach(e=>{this.app.nodes.deleteNode(e)}),this.selectNodes([]),this.app.emitChange()}hasSelectionNodes(){return 0<this.getSelectionNodes().length}getSelectionNodes(){return this.multiplexSelectNode.selectedNodeList}async copySelectionNodes(e){var t=this.getSelectionNodes().map(e=>this.app.nodes.copyNode(e,!0)),t=await Promise.all(t);if(this.setMultiplexSelectNodes(t),e){if(this.multiplexSelectNode.startResize(DRAG_NODE_PARTS.BODY),!(this.multiplexSelectNode.x&&this.multiplexSelectNode.y&&this.multiplexSelectNode.width&&this.multiplexSelectNode.height))return void console.error("multiplexSelectNode x or y or width or height is null");t=e.x-this.multiplexSelectNode.x-this.multiplexSelectNode.width/2,e=e.y-this.multiplexSelectNode.y-this.multiplexSelectNode.height/2,t=this.app.calculate.gridAdsorbent(t,e);this.multiplexSelectNode.resize(null,null,null,t.x,t.y),this.multiplexSelectNode.endResize(),this.multiplexSelectNode.updateRect()}this.app.render.render(),this.renderSelection(),this.app.emitChange()}checkIsResize(e,t,i){return!!this.hasSelection&&!!(e=this.multiplexSelectNode.dragNode.checkCoordinateInDragNodeWhere(e,t))&&(this.isResize=!0,this.multiplexSelectNode.startResize(e,i),this.app.cursor.setResize(e),!0)}handleResize(...e){this.isResize&&(this.multiplexSelectNode.resize(...e),this.app.render.render(),this.multiplexSelectNode.updateRect(),this.renderSelection())}endResize(){this.isResize=!1,this.multiplexSelectNode.endResize()}setSelectedNodeStyle(i={}){this.hasSelectionNodes()&&(Object.keys(i).forEach(t=>{this.getSelectionNodes().forEach(e=>{e.style[t]=i[t]})}),this.app.render.render(),this.app.emitChange())}selectNodes(e=[]){this.hasSelection=0<e.length,this.setMultiplexSelectNodes(e),this.app.render.render(),this.renderSelection(),this.emitChange()}cancelSelectNodes(){this.selectNodes([])}setMultiplexSelectNodes(e=[],t){this.multiplexSelectNode.setSelectedNodeList(e),t||this.multiplexSelectNode.updateRect()}emitChange(){this.app.emit("multiplexSelectChange",this.getSelectionNodes())}bindEvent(){this.app.on("change",()=>{this.state=this.app.state,this.multiplexSelectNode.updateNodes(this.app.nodes.nodeList),this.renderSelection()}),this.app.on("scrollChange",()=>{this.renderSelection()}),this.app.on("zoomChange",()=>{this.renderSelection()})}onMousedown(e,t){1===e.originEvent.which&&(this.createSelection=!0,this.rectangle.updatePos(t.mousedownPos.x,t.mousedownPos.y))}onMousemove(e,t){Math.abs(t.mouseOffset.x)<=10&&Math.abs(t.mouseOffset.y)<=10||this.onMove(e,t)}onMouseup(){this.createSelection=!1,this.rectangle.updateRect(0,0,0,0),this.hasSelection=this.hasSelectionNodes(),this.multiplexSelectNode.updateRect(),this.renderSelection(),this.emitChange()}onMove(e,t){this.rectangle.updateSize(t.mouseOffset.x,t.mouseOffset.y),this.renderSelection(),this.checkInNodes(e,t)}reset(){this.setMultiplexSelectNodes([]),this.hasSelection=!1,this.renderSelection(),this.emitChange()}renderSelection(){this.canvas.clearCanvas(),this.ctx?.save(),this.app.state.scale&&this.ctx?.scale(this.app.state.scale,this.app.state.scale),this.rectangle.render(),this.multiplexSelectNode.render(),this.ctx?.restore()}init(){this.canvas&&this.app.mountEL.removeChild(this.canvas.el),this.width=this.app.width,this.height=this.app.height,this.canvas=new Canvas(this.width,this.height,{className:"selection"}),this.ctx=this.canvas.ctx,this.app.mountEL.appendChild(this.canvas.el)}}class TextEdit extends EventEmitter{app;editable;isEditing;constructor(e){super(),this.app=e,this.editable=void 0,this.isEditing=!1,this.onTextInput=this.onTextInput.bind(this),this.onTextBlur=this.onTextBlur.bind(this)}showTextEdit(){this.editable?this.editable.style.display="block":this.crateTextInputEl(),void 0!==this.editable&&(this.updateTextInputStyle(),this.editable.focus(),this.editable.select(),this.isEditing=!0)}onTextInput(){var e,t,i=this.app.nodes["activeNode"];i&&void 0!==this.editable&&(i.text=this.editable.value,{width:e,height:t}=getTextNodeSize(i),i.width=e,i.height=t,this.updateTextInputStyle())}onTextBlur(){void 0!==this.editable&&(this.editable.style.display="none",this.editable.value="",this.emit("blur"),this.isEditing=!1)}crateTextInputEl(){this.editable=document.createElement("textarea"),this.editable.dir="auto",this.editable.tabIndex=0,this.editable.wrap="off",this.editable.className="textInput",Object.assign(this.editable.style,{position:"fixed",display:"block",minHeight:"1em",backfaceVisibility:"hidden",margin:0,padding:0,border:0,outline:0,resize:"none",background:"transparent",overflow:"hidden",whiteSpace:"pre"}),this.editable.addEventListener("input",this.onTextInput),this.editable.addEventListener("blur",this.onTextBlur),document.body.appendChild(this.editable)}updateTextInputStyle(){var e,t,i,s,o,a,n,r,h=this.app.nodes["activeNode"];h&&void 0!==this.editable&&({x:a,y:n}=h,{width:h,height:e,style:t,text:o,rotate:i}=h,{calculate:r,state:s}=this.app,this.editable.value=o,a=r.subScrollX(a),n=r.subScrollY(n),void 0!==s.scale)&&(o=r.scale(a,n),a=r.mountELToWindow(o.x,o.y),n=t.fontSize*s.scale,r={font:getFontString(n,t.fontFamily),lineHeight:n*t.lineHeightRatio+"px",left:a.x+"px",top:a.y+"px",color:t.fillStyle,width:Math.max(h,100)*s.scale+"px",height:e*s.scale+"px",transform:`rotate(${i}deg)`,opacity:t.globalAlpha},Object.assign(this.editable.style,r))}}function isEqual(t,i){if(typeof t!=typeof i)return!1;if("object"!=typeof t)return t===i;var s=Object.keys(t),e=Object.keys(i);if(s.length!==e.length)return!1;for(let e=0;e<s.length;e+=1){var o=s[e];if(!isEqual(t[o],i[o]))return!1}return!0}function getDiffData(t,i){var s=void 0===t,e=void 0===i;if(!s||!e){if(e)return{type:"delete-all"};if(s&&0===i.nodes.length)return{type:"delete-all"};if(s)return{type:"cover-all",nodes:i.nodes};if(!isEqual(t.nodes,i.nodes)){const n=t.nodes,r=i.nodes;var e=n.length,o=r.length,s=e<o,t=o<e;if(s||t){i=s?r:n;const h=s?n.map(e=>e.id):r.map(e=>e.id);let e=i.filter(e=>!h.includes(e.id));return{type:s?"add":"delete",nodes:e=t?e.map(e=>({id:e.id})):e}}if(o===e){var a=[];for(let t=0;t<o;t+=1)if(!isEqual(n[t],r[t])){const d={};Object.keys(r[t]).forEach(e=>{isEqual(n[t][e],r[t][e])||(d[e]=r[t][e])}),d.id=r[t].id,a.push(d)}if(0<a.length)return{type:"update",nodes:a}}}}}function parseDiffNodes(i,{type:e,nodes:t}){return{add:()=>{i.push(...t)},delete:()=>{t.forEach(t=>{var e=i.findIndex(e=>e.id===t.id);i.splice(e,1)})},update:()=>{t.forEach(t=>{var e=i.findIndex(e=>e.id===t.id);i[e]={...i[e],...t}})},"cover-all":()=>{i.splice(0,i.length,...t)},"delete-all":()=>{i.splice(0,i.length)}}[e](),i}function getDiffState(e,t){var i,s,o,e=e?.state;if(void 0!==e)return t=t?.state,i=e.backgroundColor!==t.backgroundColor,s=e.showGrid!==t.showGrid,e=e.readonly!==t.readonly,i||s||e?(o={},i&&(o.backgroundColor=t.backgroundColor),s&&(o.showGrid=t.showGrid),e&&(o.readonly=t.readonly),{type:"update-state",state:o}):void 0}function parseDiffState(t,{state:i}){return Object.keys(i).forEach(e=>{t[e]=i[e]}),t}var nodes={ArbitraryPlot:ArbitraryPlot,Arrow:Arrow,Circle:Circle,Diamond:Diamond,Image:Image$1,Line:Line,MultiplexSelectNode:MultiplexSelectNode,Rectangle:Rectangle,Text:Text,Triangle:Triangle};class CreatLoader extends EventEmitter{options;mountEL;plotType;width;height;left;top;canvas;ctx;state;calculate;event;keyCommand;imageEdit;textEdit;cursor;history;export;background;selection;grid;author;nodes;render;watch;static utils;static checkClick;static plot;static nodes;onceLoaderOK=!1;constructor(e){super(),window.onload=()=>{this.onceLoaderOK=!0},this.options=e,this.mountEL=e.mountEL,this.plotType=e.plotType||"selection",this.width=0,this.height=0,this.left=0,this.top=0,this.canvas=void 0,this.ctx=void 0,this.state={scale:1,scrollX:0,scrollY:0,scrollStep:25,backgroundColor:"",showGrid:!1,readonly:!1,defaultColor:"#000000",gridConfig:{size:20,strokeStyle:"#dfe0e1",lineWidth:1},...e.state||{}},this.initCanvas(),this.calculate=new Calculate(this),this.event=new Event(this),this.event.on("mousedown",this.onMousedown,this),this.event.on("mousemove",this.onMousemove,this),this.event.on("mouseup",this.onMouseup,this),this.event.on("dblclick",this.onDblclick,this),this.event.on("mousewheel",this.onMousewheel,this),this.event.on("contextmenu",this.onContextmenu,this),this.keyCommand=new KeyCommand(this),this.imageEdit=new ImageEdit(this),this.imageEdit.on("imageSelectChange",this.onImageSelectChange,this),this.textEdit=new TextEdit(this),this.textEdit.on("blur",this.onTextInputBlur,this),this.cursor=new Cursor(this),this.history=new History(this),this.export=new Export(this),this.background=new Background(this),this.selection=new Selection(this),this.grid=new Grid(this),this.nodes=new Nodes(this),this.render=new Render(this),this.author=new Author(this),this.mountFunction(),this.checkIsOnNode=throttle(this.checkIsOnNode,this),this.emitChange(),this.helpUpdate(),this.watch={zoomChange:e=>this.on("zoomChange",e),scrollChange:e=>this.on("scrollChange",e),currentTypeChange:e=>this.on("currentTypeChange",e),shuttle:e=>this.on("shuttle",e),activeNodeChange:e=>this.on("activeNodeChange",e),multiplexSelectChange:e=>this.on("multiplexSelectChange",e),contextmenu:e=>this.on("contextmenu",e),diffNodesChange:e=>this.on("diffNodesChange",e),diffStateChange:e=>this.on("diffStateChange",e),localDataChange:e=>this.on("change",e),nodeRotateChange:e=>{this.on("nodeRotateChange",e)}}}mountFunction(){["exportImage","exportJson"].forEach(e=>{this[e]=this.export[e].bind(this.export)}),["showGrid","hideGrid","updateGrid"].forEach(e=>{this[e]=this.grid[e].bind(this.grid)}),["setEditAuthor","setReadonlyAuthor"].forEach(e=>{this[e]=this.author[e].bind(this.author)}),["undo","redo"].forEach(e=>{this[e]=this.history[e].bind(this.history)}),["unBindEvent","bindEvent"].forEach(e=>{this[e]=this.keyCommand[e].bind(this.keyCommand)}),["setSelectedNodeStyle","cancelSelectNodes"].forEach(e=>{this[e]=this.selection[e].bind(this.selection)}),["updateActiveNodeRotate","updateActiveNodeSize","updateActiveNodePosition","cancelActiveNode","scrollToCenter","copyPasteCurrentNodes","empty","zoomIn","zoomOut","setZoom","selectAll","fit","deleteActiveNode","deleteCurrentNodes","setBackgroundColor","copyNode","copyCurrentNode","deleteNode","setActiveNodeStyle","setCurrentNodesStyle","scrollTo","cutCurrentNode","pasteCurrentNode"].forEach(e=>{this[e]=this.render[e].bind(this.render)})}getData(){return{state:{...this.state},nodes:this.nodes.serialize()}}onImageSelectChange(){this.cursor.hide()}getContainerRectInfo(){var{width:e,height:t,left:i,top:s}=this.mountEL.getBoundingClientRect();this.width=e,this.height=t,this.left=i,this.top=s}helpUpdate(){this.state.readonly&&this.setReadonlyAuthor(),this.state.showGrid&&this.grid.showGrid(),this.background.set()}async setData({state:e={},nodes:t=[]},i,s){this.state=e;for(let e=0;e<t.length;e+=1)"image"===t[e].type&&(t[e].imageObj=await createImageObj(t[e].url));this.helpUpdate(),this.nodes.deleteAllNodes().createNodesFromData(t),this.render.render(),i||this.emitChange(s)}initCanvas(){this.getContainerRectInfo(),this.canvas&&this.mountEL.removeChild(this.canvas);var{canvas:e,ctx:t}=createCanvas(this.width,this.height,{className:"main"});this.canvas=e,this.ctx=t,this.mountEL.appendChild(this.canvas)}resize(){this.initCanvas(),this.render.render(),this.selection.init(),this.grid.init(),this.grid.renderGrid()}updateState(e={}){this.state={...this.state,...e},this.emitChange(void 0,!0)}updateCurrentType(e){this.plotType=e,"image"===this.plotType&&this.imageEdit.selectImage(),"eraser"===this.plotType?(this.cursor.setEraser(),this.cancelActiveNode()):"text"===this.plotType?this.cursor.setText():"selection"!==this.plotType?this.cursor.setCrossHair():this.cursor.reset(),this.emit("currentTypeChange",this.plotType)}onMousedown(e,t){var i;this.state.readonly||this.author.isDragAuthor?this.author.onStart():this.nodes.isCreateNode||this.textEdit.isEditing||(i=this.nodes.checkIsClickNode(e),"selection"===this.plotType?this.nodes.hasActiveNode()?this.nodes.checkIsResize(t.mousedownPos.unGridClientX,t.mousedownPos.unGridClientY,e)||(this.nodes.setActiveNode(i),this.render.render()):this.selection.hasSelection?this.selection.checkIsResize(t.mousedownPos.unGridClientX,t.mousedownPos.unGridClientY,e)||(this.selection.reset(),this.nodes.setActiveNode(i),this.render.render()):(i?(this.nodes.setActiveNode(i),this.render.render(),this):this.selection).onMousedown(e,t):"eraser"===this.plotType&&this.deleteNode(i))}onMousemove(e,t){var i,s,o,a;this.state.readonly||this.author.isDragAuthor?t.isMousedown&&this.author.onMove(e,t):t.isMousedown?(i=t.mousedownPos.x,s=t.mousedownPos.y,a=Math.max(t.mouseOffset.x,0),o=Math.max(t.mouseOffset.y,0),"selection"===this.plotType?this.selection.isResize?this.selection.handleResize(e,i,s,t.mouseOffset.x,t.mouseOffset.y):this.selection.createSelection?this.selection.onMousemove(e,t):(this.nodes.handleResize(e,i,s,t.mouseOffset.x,t.mouseOffset.y),this.render.render()):["rectangle","diamond","triangle"].includes(this.plotType)?(this.nodes.createRectangleLikeNode(this.plotType,i,s,a,o),this.render.render()):"circle"===this.plotType?(this.nodes.createCircle(i,s,e),this.render.render()):"arbitrary-plot"===this.plotType?this.nodes.createArbitraryPlot(e,t):"arrow"===this.plotType?(this.nodes.createArrow(i,s,e),this.render.render()):"line"===this.plotType&&3<getTowCoordinateDistance(i,s,e.clientX,e.clientY)&&(this.nodes.createLine(i,s,e,!0),this.render.render())):this.imageEdit.isReady?(this.cursor.hide(),this.imageEdit.updatePreviewElPos(e.originEvent.clientX,e.originEvent.clientY)):"selection"===this.plotType?this.nodes.hasActiveNode()?this.nodes.checkInResizeHand(e.unGridClientX,e.unGridClientY)?this.cursor.setResize("".hand):this.checkIsOnNode(e):this.selection.hasSelection&&(a=this.selection.checkInResizeHand(e.unGridClientX,e.unGridClientY))?this.cursor.setResize(a):this.checkIsOnNode(e):"line"===this.plotType&&(this.nodes.createLine(void 0,void 0,e,!1,!0),this.render.render())}checkIsOnNode(e){this.nodes.checkIsClickNode(e)?this.cursor.setMove():this.cursor.reset()}resetCurrentType(){"selection"!==this.plotType&&(this.plotType="selection",this.emit("currentTypeChange","selection"))}completeCreateNewNode(){this.resetCurrentType(),this.nodes.completeCreateNode(),this.render.render()}onMouseup(e){this.state.readonly||this.author.isDragAuthor||("text"===this.plotType?this.textEdit.isEditing||(this.createTextNode(e),this.resetCurrentType()):this.imageEdit.isReady?(this.nodes.createImage(e,this.imageEdit.imageData),this.completeCreateNewNode(),this.cursor.reset(),this.imageEdit.reset()):"arrow"===this.plotType?(this.nodes.completeCreateArrow(e),this.completeCreateNewNode()):"line"===this.plotType?(this.nodes.completeCreateLine(e,()=>{this.completeCreateNewNode()}),this.render.render()):this.nodes.isCreateNode?"arbitrary-plot"===this.plotType?(this.nodes.completeCreateNode(),this.nodes.setActiveNode()):this.completeCreateNewNode():this.nodes.isResize?(this.nodes.endResize(),this.emitChange()):this.selection.createSelection?this.selection.onMouseup():this.selection.isResize&&(this.selection.endResize(),this.emitChange()))}onDblclick(e){var t;"line"===this.plotType?this.completeCreateNewNode():(t=this.nodes.checkIsClickNode(e))?"text"===t.type&&(this.nodes.editingText(t),this.render.render(),this.keyCommand.unBindEvent(),this.textEdit.showTextEdit()):this.textEdit.isEditing||this.createTextNode(e)}onTextInputBlur(){this.keyCommand.bindEvent(),this.nodes.completeEditingText(),this.render.render(),this.emitChange()}createTextNode(e){this.nodes.createNode({type:"text",x:e.clientX,y:e.clientY}),this.keyCommand.unBindEvent(),this.textEdit.showTextEdit()}onMousewheel(e){var t;void 0!==this.state.scrollStep&&void 0!==this.state.scale&&(t=this.state.scrollStep/this.state.scale,this.scrollTo(this.state.scrollX,this.state.scrollY+("down"===e?t:-t)))}onContextmenu(e){let t;this.nodes.hasActiveNode()?t=[this.nodes.activeNode]:this.selection.hasSelectionNodes()&&(t=this.selection.getSelectionNodes()),this.emit("contextmenu",e.originEvent,t)}unBindEvent(){this.keyCommand.unBindEvent()}bindEvent(){this.keyCommand.bindEvent()}emitChange(e,t){var i=this.getData(),s=this.history.now();(void 0===s&&0!==i.nodes.length||void 0!==s&&!t)&&this.history.add(i),this.onceLoaderOK&&!e&&(this.emitDiffNodesChange(s,i),this.emitDiffStateChange(s,i)),this.emit("change",i)}emitDiffNodesChange(e,t){e=getDiffData(e,t);"object"==typeof e&&this.emit("diffNodesChange",e)}emitDiffStateChange(e,t){void 0!==getDiffState(e,t)&&this.emit("diffStateChange")}async parseSetDiffData(e){var t=this.getData(),i={};"update-state"===e.type?(i.nodes=t.nodes,i.state=parseDiffState(t.nodes,e)):(i.state=t.state,i.nodes=parseDiffNodes(t.nodes,e)),await this.setData(i,!1,!0)}}function creatLoader(t){return{mount:function(e){if(!((e="string"==typeof e?document.querySelector(e):e)&&e instanceof HTMLElement))throw new Error("mountEl is not a HTMLElement !");if(["absolute","fixed","relative"].includes(window.getComputedStyle(e).position))return new CreatLoader({mountEL:e,plotType:t.plotType,state:t});throw new Error("The DOM being mounted needs to be set to absolute/fixed/relative positioning!")}}}CreatLoader.utils=utils,CreatLoader.checkClick=checkClick,CreatLoader.plot=plot,CreatLoader.nodes=nodes;export{creatLoader as default};
//# sourceMappingURL=creat-loader.es.js.map
