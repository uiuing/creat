import EventEmitter from"eventemitter3";const keyPosit={0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,Backspace:8,Tab:9,Enter:13,Shift:16,Control:17,Alt:18,CapsLock:20,Esc:27,Space:32,PageUp:33,PageDown:34,End:35,Home:36,Insert:45,Left:37,Up:38,Right:39,Down:40,Del:46,NumLock:144,Cmd:91,CmdFF:224,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,"`":192,"=":187,"+":187,"-":189,"'":222,"/":191,".":190,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90},CLICK_DISTANCE=10,FOUR_CORNER={TOP_LEFT:"topLeft",TOP_RIGHT:"topRight",BOTTOM_RIGHT:"bottomRight",BOTTOM_LEFT:"bottomLeft"},DRAG_NODE_PARTS={BODY:"body",ROTATE:"rotate",TOP_LEFT_BUTTON:"topLeftButton",TOP_RIGHT_BUTTON:"topRightButton",BOTTOM_RIGHT_BUTTON:"bottomRightButton",BOTTOM_LEFT_BUTTON:"bottomLeftButton"};function getNodeID(){return(1e7*Math.floor(1e12*Math.random())+(new Date).getTime()).toString(36)}let nodeKeyIndex=0;function createNodeKey(){return nodeKeyIndex+=1}const deepCopy=t=>JSON.parse(JSON.stringify(t)),throttle=(e,i,s=20)=>{let o=null;return(...t)=>{o=o||setTimeout(()=>{e.call(i,...t),o=null},s)}},getFontString=(t,e)=>t+"px "+e,splitTextLines=t=>t.replace(/\r\n?/g,"\n").split("\n"),radToDeg=t=>t*(180/Math.PI),degToRad=t=>t*(Math.PI/180),createCanvas=(t,e,i={noStyle:!1,noTranslate:!1,className:""})=>{var s=document.createElement("canvas"),o=(i.noStyle||(s.style.cssText="position: absolute;left: 0;top: 0;"),i.className&&(s.className=i.className),s.getContext("2d"));return s.width=t,s.height=e,i.noTranslate||o?.translate(s.width/2,s.height/2),{canvas:s,ctx:o}},getTowCoordinateDistance=(t,e,i,s)=>Math.sqrt((t-i)**2+(e-s)**2),getCoordinateToLineDistance=(t,e,i,s,o,a)=>{return i===o?Math.abs(t-i):(a=(s-a)/(o-i),Math.abs((a*t+ +e+(0-+s-a*i))/Math.sqrt(a*a+1)))},checkIsAtSegment=(t,e,i,s,o,a,h=10)=>{var n;return void 0!==o&&void 0!==a&&!(getCoordinateToLineDistance(t,e,i,s,o,a)>h)&&(n=getTowCoordinateDistance(t,e,i,s),t=getTowCoordinateDistance(t,e,o,a),e=getTowCoordinateDistance(i,s,o,a),n<=(i=Math.sqrt(h*h+e*e)))&&t<=i},getTowCoordinateRotate=(t,e,i,s,o,a)=>radToDeg(Math.atan2(s-e,i-t)-Math.atan2(a-e,o-t)),getRotatedCoordinate=(t,e,i,s,o)=>{o=radToDeg(Math.atan2(e-s,t-i))+o,t=getTowCoordinateDistance(t,e,i,s);return{x:Math.cos(degToRad(o))*t+i,y:Math.sin(degToRad(o))*t+s}},getNodeCenterCoordinate=t=>{var{x:t,y:e,width:i,height:s}=t;return{x:t+i/2,y:e+s/2}},transformCoordinateReverseRotate=(t,e,i,s,o)=>{return 0!==o&&(t=(i=getRotatedCoordinate(t,e,i,s,-o)).x,e=i.y),{x:t,y:e}},transformCoordinateOnNode=(t,e,i)=>{var s=getNodeCenterCoordinate(i);return transformCoordinateReverseRotate(t,e,s.x,s.y,i.rotate)},getNodeFourCornerCoordinate=(t,e)=>{var{x:i,y:s,width:o,height:a}=t;switch(e){case"topLeft":return{x:i,y:s};case"topRight":return{x:i+o,y:s};case"bottomRight":return{x:i+o,y:s+a};case"bottomLeft":return{x:i,y:s+a}}return{}},getBoundingRect=(t=[],e=!1)=>{let i=1/0,s=-1/0,o=1/0,a=-1/0;t.forEach(t=>{var[t,e]=t;t<i&&(i=t),t>s&&(s=t),e<o&&(o=e),e>a&&(a=e)});var t=i,h=o,n=s-i,r=a-o;return e?[{x:t,y:h},{x:t+n,y:h},{x:t+n,y:h+r},{x:t,y:h+r}]:{x:t,y:h,width:n,height:r}},getNodeRotatedFourCornerCoordinate=(t,e)=>{var i=getNodeCenterCoordinate(t),e=getNodeFourCornerCoordinate(t,e);return e&&e.x&&e.y?getRotatedCoordinate(e.x,e.y,i.x,i.y,t.rotate):0},checkCoordinateIsInRectangle=(t,e,i,s,o,a)=>{var h;return"object"==typeof i&&(i=(h=i).x,s=h.y,o=h.width,a=h.height),void 0!==s&&void 0!==o&&void 0!==a&&i<=t&&t<=i+o&&s<=e&&e<=s+a},getMultiplexNodeRectInfo=(t=[])=>{if(t.length<=0)return{minX:0,maxX:0,minY:0,maxY:0};let i=1/0,s=-1/0,o=1/0,a=-1/0;return t.forEach(t=>{(t?.getEndCoordinateList?.()).forEach(({x:t,y:e})=>{t<i&&(i=t),t>s&&(s=t),e<o&&(o=e),e>a&&(a=e)})}),{minX:i,maxX:s,minY:o,maxY:a}};let textCheckEl=null;const getTextActWidth=(t,e)=>{textCheckEl||((textCheckEl=document.createElement("div")).style.position="fixed",textCheckEl.style.left="-99999px",document.body.appendChild(textCheckEl));var{fontSize:e,fontFamily:i}=e,t=(textCheckEl.innerText=t,textCheckEl.style.fontSize=e+"px",textCheckEl.style.fontFamily=i,textCheckEl.getBoundingClientRect())["width"];return t},getNodeFourCorners=t=>{var e=getNodeRotatedFourCornerCoordinate(t,"bottomRight");return[getNodeRotatedFourCornerCoordinate(t,"topLeft"),getNodeRotatedFourCornerCoordinate(t,"topRight"),getNodeRotatedFourCornerCoordinate(t,"bottomLeft"),e]},createImageObj=i=>new Promise(t=>{const e=new Image;e.setAttribute("crossOrigin","anonymous"),e.onload=()=>{t(e)},e.onerror=()=>{t(null)},e.src=i}),getWrapTextActWidth=e=>{var t=e["text"],t=splitTextLines(t);let i=-1/0;return t.forEach(t=>{t=getTextActWidth(t,e.style);t>i&&(i=t)}),i},getTextNodeSize=t=>{var{text:e,style:i}=t;return{width:getWrapTextActWidth(t),height:Math.max(splitTextLines(e).length,1)*(i.fontSize*i.lineHeightRatio)}},computedLineWidthBySpeed=(t,e,i=2)=>{let s=0;var o=i+2;return-1===e&&(e=o),.5*(s=10<=t?i:t<=.5?o+1:o-(t-.5)/9.5*o)+.3*e};class Author{app;startScrollX;startScrollY;isDragAuthor;constructor(t){this.app=t,this.startScrollX=0,this.startScrollY=0,this.isDragAuthor=!1,this.onMove=throttle(this.onMove,this,15),this.bindEvent()}onStart(){this.startScrollX=this.app.state.scrollX,this.startScrollY=this.app.state.scrollY}onMove(t,e){void 0!==this.startScrollX&&void 0!==this.startScrollY&&void 0!==this.app.state.scale&&this.app.scrollTo(this.startScrollX-e.mouseOffset.originX/this.app.state.scale,this.startScrollY-e.mouseOffset.originY/this.app.state.scale)}bindEvent(){this.app.event.on("keydown",t=>{t.keyCode===keyPosit.Space&&(this.isDragAuthor=!0,this.app.cursor.set("grab"))}),this.app.event.on("keyup",()=>{this.isDragAuthor&&(this.isDragAuthor=!1,this.app.cursor.set("default"))})}setEditAuthor(){this.app.cursor.set("default"),this.app.updateState({readonly:!1})}setReadonlyAuthor(){this.app.cursor.set("grab"),this.app.cancelActiveNode(),this.app.updateState({readonly:!0})}}class Background{app;constructor(t){this.app=t}set(){this.app.state.backgroundColor?this.addBackgroundColor():this.remove()}addBackgroundColor(){this.app.mountEL.style.backgroundColor=this.app.state.backgroundColor}remove(){this.app.mountEL.style.backgroundColor=""}static canvasAddBackgroundColor(t,e,i,s){t.save(),t.rect(0,0,e,i),t.fillStyle=s,t.fill(),t.restore()}}class Cursor{app;currentType;constructor(t){this.app=t,this.currentType="default"}set(t="default"){let e="text"===(this.currentType=t)?"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAAXNSR0IArs4c6QAAAWZJREFUSEvNlLFOwzAQhi+5iaUrDDwBHekDNHtZEOorMFk5JQ8APEAsJyOPwAjsZEZ0LAMrCzwBUxx0kVM5adI4RZXwlMj2p///fXceHGh5B+LC/wPHcXxWFMWSHSulbtvO91JsoA8AMDXAXCkV2PC9wAwgIlZ5Y8HubOWjwLX9GtCCN1Q7g1v2N+oM/Mr3/Usp5UftwAlsoG8AcNRlnfeTJHkflbGBrnvqvZGrM5iI5gDw0gNdI+KyrXQwigHoDyLO+qAM78w4DMNjz/O++todEae7oJ1gIcQpIn7+BboFHrDP5wOlVO4yuBpREBGX1HnPRWdoQ3EURQut9VMXtCzLkzRNv12UblUFET0CwEX7stZ6lmXZagx0o1gIMTEPNrEAK631dQ01rVuNyPobAHg+5PZeQ7HVXWz31ff9eynls62SiEoDCqzhU+Vu73VFMd/14qZiWDGDuCOrZf/b952G0Nh8+fwvoNqzF6HDmhsAAAAASUVORK5CYII=) 10 10, auto":"eraser"===t?"url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAAXNSR0IArs4c6QAAAbZJREFUSEvNlL1rVEEUxc95uwvCVjYKNnZa2ATEXrALNhaKiBgQDabQwt13hlQbi30w8x4oNhaCkYBFElAhoJXaip2FRfIX2FhY2c2VJy5skn0fERacbphzf3Pv5dxLzOlwTlz8H2Dv/VqSJF/NbFHS3bpqW2ec5/mqmWUk1wC8iTFmzrnLVfBWYO/9gGQxBVkl+c7M1iWdnwVvBIcQ7gN4OiP4IckPZrYj6fTB91pwURT3YozPqso1sxWSnwF8knR8WlcJDiHcAfC8yY5mdgvAT5KvJXUn+plg7/0SyZdN0Kn3bQA/JK1UgvM8v2Fmr44A/SMleSlN048zwSGEqwC2jgpNkmRxOBy+r+yx9/4xyQUAF9vCzeyKc+5trStCCCaJRVFciDF+aQG/Lmmz1schhHKKXkg6UQqzLDvT7XZ3a+BLkjZaTV6ZcafTOTsYDPbKgPF4fLLX630/VCa5nKZprRX32a1cMiRHZTsmsNFodKzf7/+a3M3stnNuvalNh3w8gQO4Jmn7r1OeADhlZjedc62sWDUgyyQfADgH4BuAR2WG5UdNmdZOXtvgOl3jdvvXT+YG/g3VNZQXhpoDKQAAAABJRU5ErkJggg==) 10 10, auto":t;this.app.mountEL.style.cursor=e}setEraser(){this.set("eraser")}setText(){this.set("text")}setMove(){this.set("move")}hide(){this.set("none")}reset(){this.set()}setCrossHair(){this.set("crosshair")}setResize(t){let e="";switch(t){case DRAG_NODE_PARTS.BODY:e="move";break;case DRAG_NODE_PARTS.ROTATE:e="grab";break;case DRAG_NODE_PARTS.TOP_LEFT_BUTTON:e="nw-resize";break;case DRAG_NODE_PARTS.TOP_RIGHT_BUTTON:e="ne-resize";break;case DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON:e="se-resize";break;case DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON:e="sw-resize"}this.set(e)}}class Event extends EventEmitter{app;calculate;lastMousePos;mouseDistance;lastMouseTime;mouseDuration;mouseSpeed;isMousedown;mousedownPos;mouseOffset;constructor(t){super(),this.app=t,this.calculate=t.calculate,this.lastMousePos={x:0,y:0},this.mouseDistance=0,this.lastMouseTime=Date.now(),this.mouseDuration=0,this.mouseSpeed=0,this.isMousedown=!1,this.mousedownPos={x:0,y:0,unGridClientX:0,unGridClientY:0,originClientX:0,originClientY:0},this.mouseOffset={x:0,y:0,originX:0,originY:0},this.onMousedown=this.onMousedown.bind(this),this.onMousemove=this.onMousemove.bind(this),this.onMouseup=this.onMouseup.bind(this),this.onDblclick=this.onDblclick.bind(this),this.onMousewheel=this.onMousewheel.bind(this),this.onKeydown=this.onKeydown.bind(this),this.onKeyup=this.onKeyup.bind(this),this.onContextmenu=this.onContextmenu.bind(this),this.bindEvent()}onMouseup(t){t=this.transformEvent(t),this.isMousedown=!1,this.mousedownPos.x=0,this.mousedownPos.y=0,this.emit("mouseup",t,this)}onDblclick(t){t=this.transformEvent(t),this.emit("dblclick",t,this)}onMousewheel(t){t=this.transformEvent(t),this.emit("mousewheel",t.originEvent.wheelDelta<0?"down":"up")}onContextmenu(t){t.stopPropagation(),t.preventDefault(),t=this.transformEvent(t),this.emit("contextmenu",t,this)}onKeydown(t){this.emit("keydown",t,this)}onKeyup(t){this.emit("keyup",t,this)}onMousedown(t){t=this.transformEvent(t),this.isMousedown=!0,this.mousedownPos.x=t.clientX,this.mousedownPos.y=t.clientY,this.mousedownPos.unGridClientX=t.unGridClientX,this.mousedownPos.unGridClientY=t.unGridClientY,this.mousedownPos.originClientX=t.originEvent.clientX,this.mousedownPos.originClientY=t.originEvent.clientY,this.emit("mousedown",t,this)}onMousemove(t){var e=(t=this.transformEvent(t)).clientX,i=t.clientY,s=(this.isMousedown&&(this.mouseOffset.x=e-this.mousedownPos.x,this.mouseOffset.y=i-this.mousedownPos.y,this.mouseOffset.originX=t.originEvent.clientX-this.mousedownPos.originClientX,this.mouseOffset.originY=t.originEvent.clientY-this.mousedownPos.originClientY),Date.now());this.mouseDuration=s-this.lastMouseTime,this.mouseDistance=getTowCoordinateDistance(e,i,this.lastMousePos.x,this.lastMousePos.y),this.mouseSpeed=this.mouseDistance/this.mouseDuration,this.emit("mousemove",t,this),this.lastMouseTime=s,this.lastMousePos.x=e,this.lastMousePos.y=i}transformEvent(t){var e=this.app["calculate"],i=e.windowToContainer(t.clientX,t.clientY),{x:i,y:s}=e.reverseScale(i.x,i.y),o=i=e.addScrollX(i),a=s=e.addScrollY(s),e=e.gridAdsorbent(i,s);return{originEvent:t,unGridClientX:o,unGridClientY:a,clientX:e.x,clientY:e.y}}bindEvent(){this.app.mountEL.addEventListener("mousedown",this.onMousedown),this.app.mountEL.addEventListener("mousemove",this.onMousemove),this.app.mountEL.addEventListener("mouseup",this.onMouseup),this.app.mountEL.addEventListener("dblclick",this.onDblclick),this.app.mountEL.addEventListener("mousewheel",this.onMousewheel),this.app.mountEL.addEventListener("contextmenu",this.onContextmenu),window.addEventListener("keydown",this.onKeydown),window.addEventListener("keyup",this.onKeyup)}unbindEvent(){this.app.mountEL.removeEventListener("mousedown",this.onMousedown),this.app.mountEL.removeEventListener("mousemove",this.onMousemove),this.app.mountEL.removeEventListener("mouseup",this.onMouseup),this.app.mountEL.removeEventListener("dblclick",this.onDblclick),this.app.mountEL.removeEventListener("mousewheel",this.onMousewheel),this.app.mountEL.removeEventListener("contextmenu",this.onContextmenu),window.removeEventListener("keydown",this.onKeydown),window.removeEventListener("keyup",this.onKeyup)}}class Export{app;openPreview;saveState;constructor(t){this.app=t,this.openPreview=!1,this.saveState={scale:0,scrollX:0,scrollY:0,width:0,height:0}}exportJson(){return this.app.getData()}render(t,e){t.save(),this.getNodeList(e).forEach(t=>{var e,i;t.noRender||(e=t.isActive,i=t.isSelected,t.isActive=!1,t.isSelected=!1,t.render(),t.isActive=e,t.isSelected=i)}),t.restore()}saveAppState(){var{width:t,height:e,state:i,ctx:s}=this.app;this.saveState.width=t,this.saveState.height=e,i.scale&&(this.saveState.scale=i.scale),i.scrollX&&(this.saveState.scrollX=i.scrollX),i.scrollY&&(this.saveState.scrollY=i.scrollY),this.saveState.ctx=s}exportImage({type:t="image/png",renderBg:e=!0,useBlob:i=!1,paddingX:s=10,paddingY:o=10,onlySelected:a=!0}={}){var{minX:h,maxX:n,minY:r,maxY:d}=getMultiplexNodeRectInfo(this.getNodeList(a)),n=n-h+2*s,d=d-r+2*o;const{canvas:l,ctx:c}=createCanvas(n,d,{noStyle:!0,noTranslate:!0});return c?(this.show(l),this.saveAppState(),this.changeAppState(h-s,r-o,c),e&&this.app.state.backgroundColor&&c&&Background.canvasAddBackgroundColor(c,n,d,this.app.state.backgroundColor),this.render(c,a),this.recoveryAppState(),i?new Promise((e,i)=>{l.toBlob(t=>{t?e(t):i()},t)}):l.toDataURL(t)):(console.error("Create Export Canvas Error"),"")}show(t){this.openPreview&&(t.style.cssText="position: absolute;left: 0;top: 0;background-color: #FFFFFF;",document.body.appendChild(t))}recoveryAppState(){var{width:t,height:e,scale:i,scrollX:s,scrollY:o,ctx:a}=this.saveState;this.app.state.scale=i,this.app.state.scrollX=s,this.app.state.scrollY=o,this.app.width=t,this.app.height=e,a&&(this.app.ctx=a)}changeAppState(t,e,i){this.app.ctx=i,this.app.width=2*t,this.app.height=2*e,this.app.state.scale=1,this.app.state.scrollX=0,this.app.state.scrollY=0}getNodeList(t=!0){if(!t)return this.app.nodes.nodeList;let e=[];return this.app.nodes.activeNode?e.push(this.app.nodes.activeNode):this.app.selection.hasSelectionNodes()&&(e=this.app.selection.getSelectionNodes()),this.app.nodes.nodeList.filter(t=>e.includes(t))}}class Canvas{width;height;el;ctx;constructor(t,e,i){this.width=t,this.height=e;var{canvas:t,ctx:e}=createCanvas(t,e,i);e&&(this.el=t,this.ctx=e)}clearCanvas(){var{width:t,height:e}=this;this.ctx?.clearRect(-t/2,-e/2,t,e)}}class Grid{app;canvas;ctx;constructor(t){this.app=t,this.canvas=null,this.ctx=null,this.init(),this.app.on("zoomChange",this.renderGrid,this),this.app.on("scrollChange",this.renderGrid,this)}renderVerticalLines(){var{calculate:e,width:i,state:t}=this.app,{gridConfig:s,scale:o}=t;let a=0;if(void 0===s||void 0===o||void 0===s.size)console.error("gridConfig or scale or gridConfig.size is undefined");else{for(let t=-i/2;t<i/2;t+=s.size)this.plotVerticalLine(t),a=t;for(let t=-i/2-s.size;t>-e.subScrollX(i/o/2);t-=s.size)this.plotVerticalLine(t);for(let t=a+s.size;t<e.addScrollX(i/o/2);t+=s.size)this.plotVerticalLine(t)}}renderHorizontalLines(){var{calculate:i,height:s,state:t}=this.app,{gridConfig:o,scale:a}=t;if(void 0!==o&&void 0!==a&&void 0!==o.size){let e=0;for(let t=-s/2;t<s/2;t+=o.size)this.plotHorizontalLine(t),e=t;for(let t=-s/2-o.size;t>-i.subScrollY(s/a/2);t-=o.size)this.plotHorizontalLine(t);for(let t=e+o.size;t<i.addScrollY(s/a/2);t+=o.size)this.plotHorizontalLine(t)}}renderGrid(){this.canvas.clearCanvas();var{gridConfig:t,scale:e,showGrid:i}=this.app.state;i&&(this.ctx&&e&&t&&this.ctx.strokeStyle&&this.ctx.lineWidth&&(this.ctx.save(),this.ctx.scale(e,e),this.ctx.strokeStyle=t.strokeStyle,this.ctx.lineWidth=t.lineWidth),this.renderVerticalLines(),this.renderHorizontalLines(),this.ctx?.restore())}plotHorizontalLine(t){var{calculate:e,width:i,state:s}=this.app;void 0!==s.scale&&(e=e.subScrollY(t),this.ctx?.beginPath(),this.ctx?.moveTo(-i/s.scale/2,e),this.ctx?.lineTo(i/s.scale/2,e),this.ctx?.stroke())}plotVerticalLine(t){var{calculate:e,height:i,state:s}=this.app;void 0!==s.scale&&(e=e.subScrollX(t),this.ctx?.beginPath(),this.ctx?.moveTo(e,-i/s.scale/2),this.ctx?.lineTo(e,i/s.scale/2),this.ctx?.stroke())}showGrid(){this.app.updateState({showGrid:!0}),this.renderGrid()}hideGrid(){this.app.updateState({showGrid:!1}),this.canvas.clearCanvas()}updateGrid(t={}){this.app.updateState({gridConfig:{...this.app.state.gridConfig,...t}}),this.app.state.showGrid&&(this.hideGrid(),this.showGrid())}init(){this.canvas&&this.app.mountEL.removeChild(this.canvas.el);var{width:t,height:e}=this.app;this.canvas=new Canvas(t,e,{className:"grid"}),this.ctx=this.canvas.ctx,this.app.mountEL.insertBefore(this.canvas.el,this.app.mountEL.children[0])}}class History{app;historyStack;length;index;fixIndex;constructor(t){this.app=t,this.historyStack=[],this.length=0,this.index=-1,this.fixIndex=-1}emitChange(){this.app.emit("shuttle",this.index,this.length)}now(){return this.historyStack[this.length-1]}clear(){this.index=-1,this.length=0,this.historyStack=[],this.emitChange()}add(t){var e=0<this.length?this.historyStack[this.length-1]:null,t=deepCopy(t);t!==e&&(this.historyStack.push(t),this.length+=1,this.index=this.length-1,this.emitChange())}shuttle(){const t=this.app.getData(),e=this.historyStack[this.index],i=(this.fixIndex=this.index,this.length);this.app.setData(e,!0).then(()=>{this.index=this.fixIndex,this.length=i,this.emitChange(),this.app.emit("change",e),this.app.emitDiffNodesChange(t,e),this.app.emitDiffStateChange(t,e)}).catch(()=>{console.error("History shuttle setData error")})}undo(){this.index<=0||(--this.index,this.shuttle())}redo(){this.index>=this.length-1||(this.index+=1,this.shuttle())}}class ImageEdit extends EventEmitter{app;el;isReady;previewEl;imageData;maxWidth;maxHeight;maxRatio;constructor(t){super(),this.app=t,this.el=null,this.isReady=!1,this.previewEl=null,this.imageData=null,this.maxWidth=750,this.maxHeight=450,this.maxRatio=this.maxWidth/this.maxHeight,this.onImageSelectChange=this.onImageSelectChange.bind(this)}updatePreviewElPos(t,e){var i;this.imageData?(i=100/this.imageData.ratio,this.previewEl||(this.previewEl=document.createElement("div"),this.previewEl.style.position="fixed",this.previewEl.style.width="100px",this.previewEl.style.height=i+"px",this.previewEl.style.backgroundImage=`url('${this.imageData.url}')`,this.previewEl.style.backgroundSize="cover",this.previewEl.style.pointerEvents="none",document.body.appendChild(this.previewEl)),t=this.app.calculate.mountELToWindow(t,e),this.previewEl.style.left=t.x-50+"px",this.previewEl.style.top=t.y-i/2+"px"):console.error("imageData is null")}reset(){this.el&&(this.el.value=""),this.isReady=!1,this.previewEl&&document.body.removeChild(this.previewEl),this.previewEl=null,this.imageData=null}async getImageUrl(s){return new Promise((t,e)=>{const i=new FileReader;i.onloadend=()=>{t(i.result)},i.onerror=()=>{e()},i.readAsDataURL(s)})}async getImageSize(e){return new Promise((s,t)=>{const o=new Image;o.setAttribute("crossOrigin","anonymous"),o.onload=()=>{let t=o["width"],e=o["height"];var i=o.width/o.height;(o.width>this.maxWidth||o.height>this.maxHeight)&&(i>this.maxRatio?(t=this.maxWidth,e=this.maxWidth/i):(e=this.maxHeight,t=this.maxHeight*i)),s({imageObj:o,size:{width:t,height:e},ratio:i})},o.onerror=()=>{t()},o.src=e})}async onImageSelectChange(t){var e,i,s,t=await this.getImageUrl(t.target.files[0]);"string"!=typeof t?console.error("url is not string"):({imageObj:e,size:i,ratio:s}=await this.getImageSize(t),this.isReady=!0,this.imageData={url:t,...i,ratio:s,imageObj:e},this.emit("imageSelectChange",this.imageData))}selectImage(){this.el||(this.el=document.createElement("input"),this.el.style.position="fixed",this.el.style.left="-9999999px",this.el.type="file",this.el.accept="image/*",this.el.addEventListener("change",this.onImageSelectChange),document.body.appendChild(this.el)),this.el.click()}}class KeyCommand{app;keyPosit;shortcutMap;constructor(t){this.app=t,this.keyPosit=keyPosit,this.shortcutMap={},this.bindEvent()}getKeyCodeArr(t){t=(t=t.replace(/\+\+/,"+add")).split(/\s*\+\s*/).map(t=>"add"===t?"+":t);const e=[];return t.forEach(t=>{e.push(keyPosit[t])}),e}getOriginEventCodeArr(t){var e=[];return(t.ctrlKey||t.metaKey)&&e.push(keyPosit.Control),t.altKey&&e.push(keyPosit.Alt),t.shiftKey&&e.push(keyPosit.Shift),e.includes(t.keyCode)||e.push(t.keyCode),e}checkKey(t,e){const i=this.getOriginEventCodeArr(t);var s=this.getKeyCodeArr(e);if(i.length!==s.length)return!1;for(let e=0;e<i.length;e+=1){var o=s.findIndex(t=>t===i[e]);if(-1===o)return!1;s.splice(o,1)}return!0}onKeydown(e){Object.keys(this.shortcutMap).forEach(t=>{this.checkKey(e,t)&&(e.stopPropagation(),e.preventDefault(),this.shortcutMap[t].forEach(t=>{t.fn.call(t.ctx)}))})}addShortcut(t,e,i){t.split(/\s*\|\s*/).forEach(t=>{this.shortcutMap[t]?this.shortcutMap[t].push({fn:e,ctx:i}):this.shortcutMap[t]=[{fn:e,ctx:i}]})}removeShortcut(t,i){t.split(/\s*\|\s*/).forEach(t=>{var e;this.shortcutMap[t]&&(i?-1!==(e=this.shortcutMap[t].findIndex(t=>t.fn===i))&&this.shortcutMap[t].splice(e,1):(this.shortcutMap[t]=[],delete this.shortcutMap[t]))})}bindEvent(){this.app.event.on("keydown",this.onKeydown,this)}unBindEvent(){this.app.event.off("keydown",this.onKeydown)}}const checkIsAtRectangleInner=(t,e)=>checkCoordinateIsInRectangle(e.x,e.y,t)?t:null,getCircleRadius=(t,e)=>Math.min(Math.abs(t),Math.abs(e))/2,checkIsAtMultiplexSegment=(t,e)=>{let i=!1;return t.forEach(t=>{i||checkIsAtSegment(e.x,e.y,...t,CLICK_DISTANCE)&&(i=!0)}),i},checkIsAtCircleEdge=(t,e)=>{var{width:i,height:s,x:o,y:a}=t,i=getCircleRadius(i,s),s=getTowCoordinateDistance(e.x,e.y,o+i,a+i);return s>=i-CLICK_DISTANCE&&s<=i+CLICK_DISTANCE?t:null},checkIsAtRectangleEdge=(t,e)=>{var{x:i,y:s,width:o,height:a}=t,o=[[i,s,i+o,s],[i+o,s,i+o,s+a],[i+o,s+a,i,s+a],[i,s+a,i,s]];return checkIsAtMultiplexSegment(o,e)?t:null},checkIsAtTriangleEdge=(t,e)=>{var{x:i,y:s,width:o,height:a}=t,a=[[i+o/2,s,i+o,s+a],[i+o,s+a,i,s+a],[i,s+a,i+o/2,s]];return checkIsAtMultiplexSegment(a,e)?t:null},checkIsAtDiamondEdge=(t,e)=>{var{x:i,y:s,width:o,height:a}=t,a=[[i+o/2,s,i+o,s+a/2],[i+o,s+a/2,i+o/2,s+a],[i+o/2,s+a,i,s+a/2],[i,s+a/2,i+o/2,s]];return checkIsAtMultiplexSegment(a,e)?t:null},checkIsAtArrowEdge=(t,e)=>{var i=t["coordinateArr"];return void 0!==i&&(i=[[i[0][0],i[0][1],i[i.length-1][0],i[i.length-1][1]]],checkIsAtMultiplexSegment(i,e))?t:null},checkIsAtArbitraryPlotLineEdge=(e,i)=>{let s=null;return void 0===e.coordinateArr?null:(e.coordinateArr.forEach(t=>{s||getTowCoordinateDistance(i.x,i.y,t[0],t[1])<=CLICK_DISTANCE&&(s=e)}),s)},checkIsAtLineEdge=(t,e)=>{var i=[];if(void 0===t.coordinateArr)return null;var s=t.coordinateArr.length,o=t.coordinateArr;for(let t=0;t<s-1;t+=1)i.push([...o[t],...o[t+1]]);return checkIsAtMultiplexSegment(i,e)?t:null};class BaseNode extends EventEmitter{app;id;type;key;isCreate;isActive;isSelected;startX;startY;x;y;width;height;startRotate;rotate;noRender;style;dragNode;constructor(t,e){super(),this.app=e,this.id=t.id,this.type=t.type||"",this.key=createNodeKey(),this.isCreate=!0,this.isActive=!0,this.isSelected=!1,this.startX=0,this.startY=0,this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.startRotate=0,this.rotate=t.rotate||0,this.noRender=!1,this.style={strokeStyle:this.app.state.defaultColor,fillStyle:"transparent",lineWidth:2,lineDash:0,globalAlpha:1,...t.style||{}},this.dragNode=void 0}isClick(t,e){throw new Error("Subclasses need to implement this method!")}offsetRotate(t){return this.updateRotate(this.startRotate+t),this}setStyle(t={}){const e=t;return Object.keys(e).forEach(t=>{"lineDash"===t?0<e.lineDash&&this.app.ctx.setLineDash([e.lineDash]):void 0!==e[t]&&""!==e[t]&&null!==e[t]&&(this.app.ctx[t]=e[t])}),this}warpRender(t){var{x:e,y:i,width:s,height:o,rotate:a,style:h}=this,{x:e,y:i}=this.app.calculate.transform(e,i),s=s/2,o=o/2,n=e+s,r=i+o;return this.app.ctx.save(),this.app.ctx.translate(n,r),this.app.ctx.rotate(degToRad(a)),this.setStyle(h),t({halfWidth:s,halfHeight:o,tx:e,ty:i,cx:n,cy:r}),this.app.ctx.restore(),this}saveState(){var{rotate:t,x:e,y:i}=this;return this.startRotate=t,this.startX=e,this.startY=i,this}move(t,e){var{startX:i,startY:s}=this;return this.x=i+t,this.y=s+e,this.emit("nodePositionChange",this.x,this.y),this}updateRotate(t){this.rotate=t=(t%=360)<0?360+t:t,this.app.emitNodeRotateChange(this.rotate)}rotateByCenter(t,e,i){this.offsetRotate(t);e=getRotatedCoordinate(this.startX,this.startY,e,i,t);this.updatePos(e.x,e.y)}startResize(t,e){return this.dragNode.startResize(t,e),this}endResize(){return this.dragNode.endResize(),this}resize(...t){return this.dragNode.handleResizeNode(...t),this}getEndCoordinateList(){return getNodeFourCorners(this)}updateRect(t,e,i,s){return this.updatePos(t,e),this.updateSize(i,s),this}updateSize(t,e){return this.width=t,this.height=e,this.emit("nodeSizeChange",this.width,this.height),this}updatePos(t,e){return this.x=t,this.y=e,this.emit("nodePositionChange",this.x,this.y),this}serialize(){return{id:this.id,type:this.type,width:this.width,height:this.height,x:this.x,y:this.y,rotate:this.rotate,style:{...this.style}}}renderDragNode(){this.isActive&&!this.isCreate?(this.dragNode.showAll(),this.dragNode.render()):this.isSelected&&(this.dragNode.onlyShowBody(),this.dragNode.render())}render(){throw new Error("Subclasses need to implement this method！")}}class BaseMultiplexCoordinateNode extends BaseNode{startCoordinateArr;coordinateArr;startWidth;startHeight;fictitiousCoordinate;constructor(t,e){super(t,e),this.startCoordinateArr=[],this.coordinateArr=t.coordinateArr||[],this.startWidth=0,this.startHeight=0,this.fictitiousCoordinate={x:0,y:0}}updateRect(t,e,i,s){var{startWidth:o,startHeight:a,startCoordinateArr:h}=this;if(void 0!==o&&void 0!==a){const n=i/o,r=s/a;this.coordinateArr=h.map(t=>{return[t[0]*n,t[1]*r,...t.slice(2)]});o=getBoundingRect(this.coordinateArr);const d=o.x-t,l=o.y-e;this.coordinateArr=this.coordinateArr.map(t=>[t[0]-d,t[1]-l,...t.slice(2)]),this.updatePos(t,e),this.updateSize(i,s)}return this}rotateByCenter(i,s,o){this.coordinateArr=this.startCoordinateArr.map(t=>{var e=getRotatedCoordinate(t[0],t[1],s,o,i);return[e.x,e.y,...t.slice(2)]}),this.updateMultiplexCoordinateBoundingRect()}serialize(){return{...super.serialize(),coordinateArr:[...this.coordinateArr]}}getEndCoordinateList(){return this.coordinateArr.map(t=>{var e=getNodeCenterCoordinate(this),t=getRotatedCoordinate(t[0],t[1],e.x,e.y,this.rotate);return{x:t.x,y:t.y}})}addCoordinate(t,e,...i){if(Array.isArray(this.coordinateArr))return this.coordinateArr.push([t,e,...i]),this}updateMultiplexCoordinateBoundingRect(){var t=getBoundingRect(this.coordinateArr);return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this}updateFictitiousCoordinate(t,e){this.fictitiousCoordinate.x=t,this.fictitiousCoordinate.y=e}move(e,i){this.coordinateArr=this.startCoordinateArr.map(t=>[t[0]+e,t[1]+i,...t.slice(2)]);var{startX:t,startY:s}=this;return t&&s&&(this.x=t+e,this.y=s+i),this}saveState(){var{rotate:t,x:e,y:i,width:s,height:o,coordinateArr:a}=this;return this.startRotate=t,this.startX=e,this.startY=i,this.startCoordinateArr=deepCopy(a),this.startWidth=s,this.startHeight=o,this}}const plotWrap=(t,e,i=!1)=>{t.beginPath(),e(),t.stroke(),i&&t.fill()},plotCircle=(t,e,i,s,o=!1)=>{plotWrap(t,()=>{t.arc(e,i,s,0,2*Math.PI)},o)},plotArrow=(i,t)=>{const e=t[0][0],s=t[0][1],o=t[t.length-1][0],a=t[t.length-1][1],h=(plotWrap(i,()=>{i.moveTo(e,s),i.lineTo(o,a)},!0),radToDeg(Math.atan2(a-s,o-e)));plotWrap(i,()=>{var t=30-h,e=o-30*Math.cos(degToRad(t)),t=a+30*Math.sin(degToRad(t));i.moveTo(e,t),i.lineTo(o,a)},!0),plotWrap(i,()=>{var t=90-h-30,e=o-30*Math.sin(degToRad(t)),t=a-30*Math.cos(degToRad(t));i.moveTo(e,t),i.lineTo(o,a)})},plotRect=(t,e,i,s,o,a=!1)=>{plotWrap(t,()=>{t.rect(e,i,s,o),a&&t.fillRect(e,i,s,o)})},plotDiamond=(t,e,i,s,o,a=!1)=>{plotWrap(t,()=>{t.moveTo(e+s/2,i),t.lineTo(e+s,i+o/2),t.lineTo(e+s/2,i+o),t.lineTo(e,i+o/2),t.closePath()},a)},transformArbitraryLineCoordinate=(t,e)=>{var{x:i,y:s}=e.app.calculate.transform(t[0],t[1]);return[i-e.cx,s-e.cy,...t.slice(2)]},plotLineSegment=(t,e,i,s,o,a=0)=>{plotWrap(t,()=>{0<a&&(t.lineWidth=a),t.moveTo(e,i),t.lineTo(s,o),t.lineCap="round",t.lineJoin="round"})},plotTriangle=(t,e,i,s,o,a=!1)=>{plotWrap(t,()=>{t.moveTo(e+s/2,i),t.lineTo(e+s,i+o),t.lineTo(e,i+o),t.closePath()},a)},plotArbitraryLine=(s,o,a)=>{for(let i=0;i<o.length-1;i+=1)plotWrap(s,()=>{var t=transformArbitraryLineCoordinate(o[i],a),e=transformArbitraryLineCoordinate(o[i+1],a);plotLineSegment(s,t[0],t[1],e[0],e[1],e[2])},!0)},plotText=(i,t,s,o)=>{const{text:e,style:a}=t,h=a.fontSize*a.lineHeightRatio;plotWrap(i,()=>{i.font=getFontString(a.fontSize,a.fontFamily),i.textBaseline="middle",splitTextLines(e).forEach((t,e)=>{i.fillText(t,s,o+(e*h+h/2))})})},plotImage=(i,s,o,a,h,n)=>{plotWrap(i,()=>{let t=0,e=0;h/n>s.ratio?(e=n,t=s.ratio*n):(t=h,e=h/s.ratio),i.drawImage(s.imageObj,o,a,t,e)})},plotLine=(i,t)=>{plotWrap(i,()=>{let e=!0;t.forEach(t=>{e?(e=!1,i.moveTo(t[0],t[1])):i.lineTo(t[0],t[1])})})};class DragNode extends BaseNode{options;node;offset;size;resizeType;diagonalCoordinate;mousedownPosAndNodePosOffset;nodeRatio;hideParts;constructor(t,e,i={}){super({type:"dragNode",notNeedDragNode:!0},e),this.options={lockRatio:!1,...i},this.style={strokeStyle:"#666",fillStyle:"transparent",lineWidth:"small",lineDash:0,globalAlpha:1},this.node=t,this.offset=5,this.size=10,this.resizeType="",this.diagonalCoordinate={x:0,y:0},this.mousedownPosAndNodePosOffset={x:0,y:0},this.nodeRatio=0,this.hideParts=[],this.x=0,this.y=0}startResize(t,e){this.resizeType=t,this.options.lockRatio&&(this.nodeRatio=this.node.width/this.node.height),t===DRAG_NODE_PARTS.BODY||t===DRAG_NODE_PARTS.ROTATE?this.node.saveState():t===DRAG_NODE_PARTS.TOP_LEFT_BUTTON?this.handleDragMousedown(e,FOUR_CORNER.TOP_LEFT):t===DRAG_NODE_PARTS.TOP_RIGHT_BUTTON?this.handleDragMousedown(e,FOUR_CORNER.TOP_RIGHT):t===DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON?this.handleDragMousedown(e,FOUR_CORNER.BOTTOM_RIGHT):t===DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON&&this.handleDragMousedown(e,FOUR_CORNER.BOTTOM_LEFT)}endResize(){this.resizeType="",this.diagonalCoordinate={x:0,y:0},this.mousedownPosAndNodePosOffset={x:0,y:0},this.nodeRatio=0}handleDragMousedown(t,e){var i=getNodeCenterCoordinate(this.node),e=getNodeRotatedFourCornerCoordinate(this.node,e);this.diagonalCoordinate.x=2*i.x-e.x,this.diagonalCoordinate.y=2*i.y-e.y,this.mousedownPosAndNodePosOffset.x=t.clientX-e.x,this.mousedownPosAndNodePosOffset.y=t.clientY-e.y,this.node.saveState()}handleResizeNode(t,e,i,s,o){var a=this["resizeType"];a===DRAG_NODE_PARTS.BODY?this.handleMoveNode(s,o):a===DRAG_NODE_PARTS.ROTATE?this.handleRotateNode(t,e,i):a===DRAG_NODE_PARTS.TOP_LEFT_BUTTON?this.handleStretchNode(t,(t,e)=>({width:2*(t.x-e.x),height:2*(t.y-e.y)}),t=>({x:t.x,y:t.y}),(t,e)=>{let i=e["x"],s=e["y"];return t>this.nodeRatio?i=e.x+e.width-this.nodeRatio*e.height:t<this.nodeRatio&&(s=e.y+(e.height-e.width/this.nodeRatio)),{x:i,y:s}}):a===DRAG_NODE_PARTS.TOP_RIGHT_BUTTON?this.handleStretchNode(t,(t,e)=>({width:2*(e.x-t.x),height:2*(t.y-e.y)}),(t,e)=>({x:t.x-e.width,y:t.y}),(t,e)=>{let i=e["x"],s=e["y"];return t>this.nodeRatio?i=e.x+this.nodeRatio*e.height:t<this.nodeRatio&&(i=e.x+e.width,s=e.y+(e.height-e.width/this.nodeRatio)),{x:i,y:s}}):a===DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON?this.handleStretchNode(t,(t,e)=>({width:2*(e.x-t.x),height:2*(e.y-t.y)}),(t,e)=>({x:t.x-e.width,y:t.y-e.height}),(t,e)=>{let i=e["x"],s=e["y"];return t>this.nodeRatio?(i=e.x+this.nodeRatio*e.height,s=e.y+e.height):t<this.nodeRatio&&(i=e.x+e.width,s=e.y+e.width/this.nodeRatio),{x:i,y:s}}):a===DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON&&this.handleStretchNode(t,(t,e)=>({width:2*(t.x-e.x),height:2*(e.y-t.y)}),(t,e)=>({x:t.x,y:t.y-e.height}),(t,e)=>{let i=e["x"],s=e["y"];return t>this.nodeRatio?(i=e.x+e.width-this.nodeRatio*e.height,s=e.y+e.height):t<this.nodeRatio&&(s=e.y+e.width/this.nodeRatio),{x:i,y:s}})}handleMoveNode(t,e){this.node.move(t,e)}handleRotateNode(t,e,i){var s=getNodeCenterCoordinate(this.node),s=getTowCoordinateRotate(s.x,s.y,t.clientX,t.clientY,e,i);this.node.offsetRotate(s)}setHideParts(t=[]){this.hideParts=t}showAll(){this.setHideParts([])}onlyShowBody(){this.setHideParts([DRAG_NODE_PARTS.ROTATE,DRAG_NODE_PARTS.TOP_LEFT_BUTTON,DRAG_NODE_PARTS.TOP_RIGHT_BUTTON,DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON,DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON])}update(){this.x=this.node.x-this.offset,this.y=this.node.y-this.offset,this.width=this.node.width+2*this.offset,this.height=this.node.height+2*this.offset,this.rotate=this.node.rotate}stretchCalc(t,e,i,s){var o={x:(t+this.diagonalCoordinate.x)/2,y:(e+this.diagonalCoordinate.y)/2},t=transformCoordinateReverseRotate(t,e,o.x,o.y,this.node.rotate),e=i(o,t);let a=!1,h=(e.width<0&&(e.width=0,a=!0),!1);e.height<0&&(e.height=0,h=!0);i=s(t,e),s={x:i.x,y:i.y,width:e.width,height:e.height};return(a||h)&&(s.x=this.node.x,s.y=this.node.y),{newRect:s,newCenter:o}}handleStretchNode(t,e,i,s){var o=t.clientX-this.mousedownPosAndNodePosOffset.x,t=t.clientY-this.mousedownPosAndNodePosOffset.y,{newRect:o,newCenter:t}=this.stretchCalc(o,t,e,i);this.options.lockRatio?this.fixStretch(o,t,e,i,s):this.node.updateRect(o.x,o.y,o.width,o.height)}fixStretch(t,e,i,s,o){o=o(t.width/t.height,t),t=getRotatedCoordinate(o.x,o.y,e.x,e.y,this.node.rotate),o=this.stretchCalc(t.x,t.y,i,s).newRect;0===o.width&&0===o.height||this.node.updateRect(o.x,o.y,o.width,o.height)}render(){this.update();const{width:i,height:s}=this;this.warpRender(({halfWidth:t,halfHeight:e})=>{this.app.ctx.save(),this.hideParts.includes(DRAG_NODE_PARTS.BODY)||(this.app.ctx.setLineDash([5]),plotRect(this.app.ctx,-t,-e,i,s),this.app.ctx.restore()),this.hideParts.includes(DRAG_NODE_PARTS.TOP_LEFT_BUTTON)||plotRect(this.app.ctx,-t-this.size,-e-this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.TOP_RIGHT_BUTTON)||plotRect(this.app.ctx,-t+this.node.width+this.size,-e-this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON)||plotRect(this.app.ctx,-t+this.node.width+this.size,-e+this.node.height+this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON)||plotRect(this.app.ctx,-t-this.size,-e+this.node.height+this.size,this.size,this.size),this.hideParts.includes(DRAG_NODE_PARTS.ROTATE)||plotCircle(this.app.ctx,-t+this.node.width/2+this.size/2,-e-2*this.size,this.size)})}checkCoordinateInDragNodeWhere(t,e){let i="";t=transformCoordinateOnNode(t,e,this.node);return checkCoordinateIsInRectangle(t.x,t.y,this)?i=DRAG_NODE_PARTS.BODY:getTowCoordinateDistance(t.x,t.y,this.x+this.width/2,this.y-2*this.size)<=this.size?i=DRAG_NODE_PARTS.ROTATE:this._checkCoordinateIsInButton(t.x,t.y,FOUR_CORNER.TOP_LEFT)?i=DRAG_NODE_PARTS.TOP_LEFT_BUTTON:this._checkCoordinateIsInButton(t.x,t.y,FOUR_CORNER.TOP_RIGHT)?i=DRAG_NODE_PARTS.TOP_RIGHT_BUTTON:this._checkCoordinateIsInButton(t.x,t.y,FOUR_CORNER.BOTTOM_RIGHT)?i=DRAG_NODE_PARTS.BOTTOM_RIGHT_BUTTON:this._checkCoordinateIsInButton(t.x,t.y,FOUR_CORNER.BOTTOM_LEFT)&&(i=DRAG_NODE_PARTS.BOTTOM_LEFT_BUTTON),i=this.hideParts.includes(i)?"":i}_checkCoordinateIsInButton(t,e,i){let s=0,o=0;switch(i){case FOUR_CORNER.TOP_LEFT:s=this.x-this.size,o=this.y-this.size;break;case FOUR_CORNER.TOP_RIGHT:s=this.x+this.width,o=this.y-this.size;break;case FOUR_CORNER.BOTTOM_RIGHT:s=this.x+this.width,o=this.y+this.height;break;case FOUR_CORNER.BOTTOM_LEFT:s=this.x-this.size,o=this.y+this.height}return checkCoordinateIsInRectangle(t,e,s,o,this.size,this.size)}}class ArbitraryPlot extends BaseMultiplexCoordinateNode{lastLineWidth;constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app),this.lastLineWidth=-1}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtArbitraryPlotLineEdge(this,t)}singleRender(t,e,i,s,o){this.app.ctx.save(),plotLineSegment(this.app.ctx,t,e,i,s,o),this.app.ctx.restore()}render(){const i=this["coordinateArr"];this.warpRender(({cx:t,cy:e})=>{plotArbitraryLine(this.app.ctx,i,{app:this.app,cx:t,cy:e})}),this.renderDragNode()}}class Arrow extends BaseMultiplexCoordinateNode{constructor(t,e){super(t,e),this.dragNode=new DragNode(this,e)}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtArrowEdge(this,t)}render(){const{coordinateArr:a,fictitiousCoordinate:h}=this;this.warpRender(({cx:i,cy:s})=>{let t=[];var e,o;0<a.length&&this.isCreate&&({x:e,y:o}=this.app.calculate.transform(h.x-i,h.y-s),t=[[e,o]]),plotArrow(this.app.ctx,a.map(t=>{var{x:t,y:e}=this.app.calculate.transform(t[0],t[1]);return[t-i,e-s]}).concat(t))}),this.renderDragNode()}}class Circle extends BaseNode{constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app,{lockRatio:!0})}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtCircleEdge(this,t)}render(){const{width:t,height:e}=this;this.warpRender(()=>{plotCircle(this.app.ctx,0,0,getCircleRadius(t,e),!0)}),this.renderDragNode()}}class Diamond extends BaseNode{constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app)}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtDiamondEdge(this,t)}getEndCoordinateList(){const{x:t,y:e,width:i,height:s,rotate:o}=this;var a=[[t+i/2,e],[t+i,e+s/2],[t+i/2,e+s],[t,e+s/2]];const h=getNodeCenterCoordinate(this);return a.map(t=>getRotatedCoordinate(t[0],t[1],h.x,h.y,o))}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:t,halfHeight:e})=>{plotDiamond(this.app.ctx,-t,-e,i,s,!0)}),this.renderDragNode()}}let Image$1=class extends BaseNode{url;imageObj;ratio;constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app,{lockRatio:!0});var{url:e,imageObj:t,ratio:i}=t;this.url=e||"",this.imageObj=t||null,this.ratio=i||1}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtRectangleInner(this,t)}serialize(){return{...super.serialize(),url:this.url,ratio:this.ratio}}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:t,halfHeight:e})=>{plotImage(this.app.ctx,this,-t,-e,i,s)}),this.renderDragNode()}};class Line extends BaseMultiplexCoordinateNode{isSingle;constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app);var{isSingle:e=!1}=t;this.isSingle=e}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtLineEdge(this,t)}render(){const{coordinateArr:a,fictitiousCoordinate:h}=this;this.warpRender(({cx:i,cy:s})=>{let t=[];var e,o;0<a.length&&this.isCreate&&({x:e,y:o}=this.app.calculate.transform(h.x-i,h.y-s),t=[[e,o]]),plotLine(this.app.ctx,a.map(t=>{var{x:t,y:e}=this.app.calculate.transform(t[0],t[1]);return[t-i,e-s]}).concat(t))}),this.renderDragNode()}}class Rectangle extends BaseNode{constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app)}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtRectangleEdge(this,t)}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:t,halfHeight:e})=>{plotRect(this.app.ctx,-t,-e,i,s,!0)}),this.renderDragNode()}}class Text extends BaseNode{text;constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app,{lockRatio:!0}),this.text=t?.text||"",this.style.fillStyle=t?.style?.fillStyle||"#000000",this.style.fontSize=t?.style?.fontSize||18,this.style.lineHeightRatio=t?.style?.lineHeightRatio||1.5,this.style.fontFamily=t?.style?.fontFamily||"Microsoft YaHei, sans-serif"}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtRectangleInner(this,t)}updateRect(t,e,i,s){var{text:o,style:a}=this;this.style.fontSize=Math.floor(s/splitTextLines(o).length/a.lineHeightRatio),super.updateRect(t,e,i,s)}serialize(){return{...super.serialize(),text:this.text}}render(){this.warpRender(({halfWidth:t,halfHeight:e})=>{plotText(this.app.ctx,this,-t,-e)}),this.renderDragNode()}}class Triangle extends BaseNode{constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app)}getEndCoordinateList(){const{x:t,y:e,width:i,height:s,rotate:o}=this;var a=[[t+i/2,e],[t+i,e+s],[t,e+s]];const h=getNodeCenterCoordinate(this);return a.map(t=>getRotatedCoordinate(t[0],t[1],h.x,h.y,o))}isClick(t,e){t=transformCoordinateOnNode(t,e,this);return checkIsAtTriangleEdge(this,t)}render(){const{width:i,height:s}=this;this.warpRender(({halfWidth:t,halfHeight:e})=>{plotTriangle(this.app.ctx,-t,-e,i,s,!0)}),this.renderDragNode()}}class Nodes{app;nodeList;activeNode;isCreateNode;isResize;resizeNode;constructor(t){this.app=t,this.nodeList=[],this.activeNode=void 0,this.isCreateNode=!1,this.isResize=!1,this.resizeNode=null,this.handleResize=throttle(this.handleResize,this,15)}createNode(t,e=()=>{},i,s){return!this.hasActiveNode()&&!this.isCreateNode&&(t.id=getNodeID(),t=this.pureCreateNode(t))&&(this.addNode(t),s||this.setActiveNode(t),this.isCreateNode=!0,e.call(i,t)),this}copyNode(e,a,h){return new Promise(async o=>{var t;e&&("image"===(t=e.serialize?.()).type&&null!=t.url&&(t.imageObj=await createImageObj(t.url)),this.createNode(t,t=>{t.startResize(DRAG_NODE_PARTS.BODY);let e=20,i=20;h&&(e=h.x-t.x-t.width/2,i=h.y-t.y-t.height/2);var s=this.app.calculate.gridAdsorbent(e,i);t.resize(null,null,null,s.x,s.y),t.isCreate=!1,a&&(t.isActive=!1),this.isCreateNode=!1,o(t)},this,a))})}createRectangleLikeNode(t,e,i,s,o){this.createNode({type:t,x:e,y:i,width:s,height:o}),this.activeNode?.updateSize?.(s,o)}createCircle(t,e,i){this.createNode({type:"circle",x:t,y:e});i=getTowCoordinateDistance(i.clientX,i.clientY,t,e);this.activeNode?.updateSize?.(i,i)}createArbitraryPlot(t,e){this.createNode({type:"arbitrary-plot"});var i=this.activeNode,s=computedLineWidthBySpeed(e.mouseSpeed,i?.lastLineWidth),{calculate:o,ctx:a,state:h}=(i?.lastLineWidth&&(i.lastLineWidth=s),i?.addCoordinate?.(t.clientX,t.clientY,s),this.app),e=o.transformToCanvasCalculate(o.subScrollX(e.lastMousePos.x),o.subScrollY(e.lastMousePos.y)),o=o.transformToCanvasCalculate(o.subScrollX(t.clientX),o.subScrollY(t.clientY));a.save(),a.scale(h.scale,h.scale),i?.singleRender?.(e.x,e.y,o.x,o.y,s),a.restore()}createImage(t,{width:e,height:i,imageObj:s,url:o,ratio:a}){t=this.app.calculate.gridAdsorbent(t.unGridClientX-e/2,t.unGridClientY-i/2);this.createNode({type:"image",x:t.x,y:t.y,url:o,imageObj:s,width:e,height:i,ratio:a})}editingText(t){"text"===t.type&&(t.noRender=!0,this.setActiveNode(t))}completeEditingText(){var t=this.activeNode;t&&"text"===t.type&&(t?.text?.trim()?t.noRender=!1:(this.deleteNode(t),this.setActiveNode()))}completeCreateArrow(t){this.activeNode?.addCoordinate?.(t.clientX,t.clientY)}createArrow(e,i,t){this.createNode({type:"arrow",x:e,y:i},t=>{t.addCoordinate(e,i)}),this.activeNode?.updateFictitiousCoordinate?.(t.clientX,t.clientY)}createLine(e,i,t,s=!1,o=!1){o||this.createNode({type:"line",x:e,y:i,isSingle:s},t=>{t.addCoordinate(e,i)});o=this.activeNode;o&&o.updateFictitiousCoordinate?.(t.clientX,t.clientY)}insertNode(t,e){this.nodeList.splice(e,0,t)}addNode(t){return this.nodeList.push(t),this}getNodesNum(){return this.nodeList.length}hasNodes(){return 0<this.nodeList.length}unshiftNode(t){return this.nodeList.unshift(t),this}deleteNode(t){var e=this.getNodeIndex(t);return-1!==e&&(this.nodeList.splice(e,1),t.isActive)&&this.cancelActiveNode(),this}deleteAllNodes(){return this.activeNode=void 0,this.nodeList=[],this.isCreateNode=!1,this.isResize=!1,this.resizeNode=null,this}getNodeIndex(e){return this.nodeList.findIndex(t=>t===e)}createNodesFromData(t){return this.app.oldData=this.app.getData(),t.forEach(t=>{t=this.pureCreateNode(t);t.isActive=!1,t.isCreate=!1,this.addNode(t)}),this}hasActiveNode(){return this.activeNode}setActiveNode(t){return this.cancelActiveNode(),(this.activeNode=t)&&(t.isActive=!0),this.app.emit("activeNodeChange",this.activeNode),this}cancelActiveNode(){return this.hasActiveNode()&&(this.activeNode&&(this.activeNode.isActive=!1,this.activeNode=void 0),this.app.emit("activeNodeChange",this.activeNode)),this}checkIsClickNode(t){var e=t.unGridClientX,i=t.unGridClientY;for(let t=this.nodeList.length-1;0<=t;--t){var s=this.nodeList[t];if(s.isClick?.(e,i))return s}return null}pureCreateNode(t={}){switch(t.type){case"rectangle":return new Rectangle(t,this.app);case"diamond":return new Diamond(t,this.app);case"triangle":return new Triangle(t,this.app);case"circle":return new Circle(t,this.app);case"arbitrary-plot":return new ArbitraryPlot(t,this.app);case"image":return new Image$1(t,this.app);case"arrow":return new Arrow(t,this.app);case"line":return new Line(t,this.app);case"text":return new Text(t,this.app);default:return null}}completeCreateLine(t,e=()=>{}){let i=this.activeNode;var s=t.clientX,t=t.clientY;i&&i.isSingle?(i.addCoordinate?.(s,t),e()):(this.createNode({type:"line",isSingle:!1}),(i=this.activeNode)?.addCoordinate?.(s,t),i?.updateFictitiousCoordinate?.(s,t))}completeCreateNode(){this.isCreateNode=!1;var t=this.activeNode;return t&&(["arbitrary-plot","arrow","line"].includes(t.type)&&t.updateMultiplexCoordinateBoundingRect(),t.isCreate=!1,this.app.emitChange()),this}setActiveNodeStyle(e={}){return this.hasActiveNode()&&Object.keys(e).forEach(t=>{this.activeNode.style[t]=e[t]}),this}checkInResizeHand(t,e){var i=this.activeNode,t=i?.dragNode?.checkCoordinateInDragNodeWhere?.(t,e);return t?{node:i,hand:t}:null}checkIsResize(t,e,i){return!!this.hasActiveNode()&&!!(t=this.checkInResizeHand(t,e))&&(this.isResize=!0,t.node&&(this.resizeNode=t.node,this.resizeNode.startResize?.(t.hand,i)),this.app.cursor.setResize(t.hand),!0)}handleResize(...t){this.isResize&&this.resizeNode?.resize?.(...t)}endResize(){this.isResize=!1,this.resizeNode?.endResize?.(),this.resizeNode=null}serialize(t=!1){var e=this.nodeList.map(t=>t.serialize?.());return t?JSON.stringify(e):e}}class Render{app;beingCopyActiveNode;beingCopySelectedNodes;beingCopyNode;constructor(t){this.app=t,this.beingCopyActiveNode=null,this.beingCopySelectedNodes=[],this.registerShortcutKeys()}setActiveNodeStyle(t={}){return this.app.nodes.hasActiveNode()&&(this.app.nodes.setActiveNodeStyle(t),this.render(),this.app.nodes.isCreateNode||this.app.emitChange()),this}setCurrentNodesStyle(t={}){this.setActiveNodeStyle(t),this.app.selection.setSelectedNodeStyle(t)}clearCanvas(){var{width:t,height:e}=this.app;return this.app.ctx.clearRect(-t/2,-e/2,t,e),this}render(){var t=this.app["state"];return this.clearCanvas(),this.app.ctx.save(),this.app.ctx.scale(t.scale,t.scale),this.app.nodes.nodeList.forEach(t=>{t.noRender||t.render()}),this.app.ctx.restore(),this}registerShortcutKeys(){this.app.keyCommand.addShortcut("Control+a",()=>{this.selectAll()}),this.app.keyCommand.addShortcut("Control+0",()=>{this.setZoom(1)}),this.app.keyCommand.addShortcut("Del|Backspace",()=>{this.deleteCurrentNodes()}),this.app.keyCommand.addShortcut("Control+c",()=>{this.copyCurrentNode()}),this.app.keyCommand.addShortcut("Control+x",()=>{this.cutCurrentNode()}),this.app.keyCommand.addShortcut("Control+z",()=>{this.app.history.undo()}),this.app.keyCommand.addShortcut("Control+'",()=>{this.app.state.showGrid?this.app.grid.hideGrid():this.app.grid.showGrid()}),this.app.keyCommand.addShortcut("Control+y",()=>{this.app.history.redo()}),this.app.keyCommand.addShortcut("Control+v",()=>{this.pasteCurrentNode(!0)})}copyCurrentNode(){this.app.nodes.activeNode?(this.beingCopySelectedNodes=[],this.beingCopyNode=this.app.nodes.activeNode):this.app.selection.hasSelectionNodes()&&(this.beingCopyNode=void 0,this.beingCopySelectedNodes=this.app.selection.getSelectionNodes())}cutCurrentNode(){this.app.nodes.activeNode?(this.copyCurrentNode(),this.deleteCurrentNodes()):this.app.selection.hasSelectionNodes()&&(this.copyCurrentNode(),this.deleteCurrentNodes(),this.app.selection.setMultiplexSelectNodes(this.beingCopySelectedNodes),this.app.selection.emitChange())}pasteCurrentNode(t=!1){let e=null;var i,s;t&&(i=this.app.event.lastMousePos["x"],s=this.app.event.lastMousePos["y"],e={x:i,y:s}),this.beingCopyNode?this.copyNode(this.beingCopyNode,!1,e).then(()=>{}):0<this.beingCopySelectedNodes.length&&this.app.selection.copySelectionNodes(t?e:null)}deleteNode(t){this.app.nodes.deleteNode(t),this.render(),this.app.emitChange()}async copyNode(t,e,i){this.app.nodes.cancelActiveNode(),await this.app.nodes.copyNode(t,e,i),this.render(),this.app.emitChange()}deleteActiveNode(){this.app.nodes.hasActiveNode()&&this.deleteNode(this.app.nodes.activeNode)}deleteCurrentNodes(){this.deleteActiveNode(),this.app.selection.deleteSelectedNodes()}cancelActiveNode(){return this.app.nodes.hasActiveNode()&&(this.app.nodes.cancelActiveNode(),this.render()),this}updateActiveNodePosition(t,e){return this.app.nodes.hasActiveNode()&&(this.app.nodes.activeNode.updatePos(t,e),this.render()),this}updateActiveNodeSize(t,e){return this.app.nodes.hasActiveNode()&&(this.app.nodes.activeNode.updateSize(t,e),this.render()),this}updateActiveNodeRotate(t){return this.app.nodes.hasActiveNode()&&(this.app.nodes.activeNode.updateRotate(t),this.render()),this}empty(){this.app.nodes.deleteAllNodes(),this.render(),this.app.emitChange()}zoomIn(t=.1){this.app.state.scale&&(this.app.updateState({scale:this.app.state.scale+t}),this.render(),this.app.emit("zoomChange",this.app.state.scale))}zoomOut(t=.1){this.app.state.scale&&(this.app.updateState({scale:0<this.app.state.scale-t?this.app.state.scale-t:0}),this.render(),this.app.emit("zoomChange",this.app.state.scale))}setZoom(t){t<0||1<t||(this.app.updateState({scale:t}),this.render(),this.app.emit("zoomChange",this.app.state.scale))}fit(){var t,e,i,s;this.app.nodes.hasNodes()&&(this.scrollToCenter(),{minX:t,maxX:s,minY:e,maxY:i}=getMultiplexNodeRectInfo(this.app.nodes.nodeList),s=Math.min(this.app.width/(s-t),this.app.height/(i-e)),this.setZoom(s))}scrollTo(t,e){this.app.updateState({scrollX:t,scrollY:e}),this.render(),this.app.emit("scrollChange",this.app.state.scrollX,this.app.state.scrollY)}scrollToCenter(){var t,e,i,s;this.app.nodes.hasNodes()?({minX:t,maxX:e,minY:i,maxY:s}=getMultiplexNodeRectInfo(this.app.nodes.nodeList),this.scrollTo(t-(this.app.width-(e-t))/2,i-(this.app.height-(s-i))/2)):this.scrollTo(0,0)}copyPasteCurrentNodes(){this.copyCurrentNode(),this.pasteCurrentNode()}setBackgroundColor(t){this.app.updateState({backgroundColor:t}),this.app.background.set()}selectAll(){this.app.selection.selectNodes(this.app.nodes.nodeList)}}class Calculate{app;constructor(t){this.app=t}transformToCanvasCalculate(t,e){return{x:t-=this.app.width/2,y:e-=this.app.height/2}}gridAdsorbent(t,e){var{gridConfig:i,showGrid:s}=this.app.state;return void 0===i?{}:s?void 0===(s=i.size)?{}:{x:t-t%s,y:e-e%s}:{x:t,y:e}}addScrollY(t){return void 0===this.app.state.scrollY?0:this.app.state.scrollY+t}addScrollX(t){return void 0===this.app.state.scrollX?0:this.app.state.scrollX+t}subScrollY(t){return void 0===this.app.state.scrollY?0:t-this.app.state.scrollY}subScrollX(t){return void 0===this.app.state.scrollX?0:t-this.app.state.scrollX}transformToScreenCalculate(t,e){return{x:t+=this.app.width/2,y:e+=this.app.height/2}}transform(t,e){t=this.transformToCanvasCalculate(t,e);return{x:this.subScrollX(t.x),y:this.subScrollY(t.y)}}mountELToWindow(t,e){return{x:t+this.app.left,y:e+this.app.top}}windowToContainer(t,e){return{x:t-this.app.left,y:e-this.app.top}}scale(t,e){var i=this.app["state"];return void 0===i.scale?{}:(t=this.transformToCanvasCalculate(t,e),{x:(e=this.transformToScreenCalculate(t.x*i.scale,t.y*i.scale)).x,y:e.y})}reverseScale(t,e){var i=this.app["state"];return void 0===i.scale?{}:(t=this.transformToCanvasCalculate(t,e),{x:(e=this.transformToScreenCalculate(t.x/i.scale,t.y/i.scale)).x,y:e.y})}}class MultiplexSelectNode extends BaseNode{selectedNodeList;wholeCenterPos;constructor(t,e){super(t,e),this.dragNode=new DragNode(this,this.app),this.selectedNodeList=[],this.wholeCenterPos={x:0,y:0}}updateNodes(e){const i=[];this.selectedNodeList.forEach(t=>{e.includes(t)&&i.push(t)}),this.setSelectedNodeList(i)}updateRect(){var t,e,i,s;this.selectedNodeList.length<=0?super.updateRect(0,0,0,0):({minX:t,maxX:e,minY:i,maxY:s}=getMultiplexNodeRectInfo(this.selectedNodeList),super.updateRect(t,i,e-t,s-i))}resize(...e){this.selectedNodeList.forEach(t=>{t.dragNode&&"rotate"===t.dragNode.resizeType?this.handleRotate(t,...e):t?.resize?.(...e)})}handleRotate(t,e,i,s){e=getTowCoordinateRotate(this.wholeCenterPos.x,this.wholeCenterPos.y,e.clientX,e.clientY,i,s);t.rotateByCenter?.(e,this.wholeCenterPos.x,this.wholeCenterPos.y)}endResize(){this.selectedNodeList.forEach(t=>{t.endResize?.()})}setSelectedNodeList(t){this.selectedNodeList.forEach(t=>{t.isSelected=!1}),this.selectedNodeList=t,this.selectedNodeList.forEach(t=>{t.isSelected=!0})}startResize(...e){this.selectedNodeList.forEach(t=>{"rotate"===e[0]&&(this.wholeCenterPos=getNodeCenterCoordinate(this)),t.startResize?.(...e)})}render(){this.width&&this.height&&0<this.selectedNodeList.length&&(this.width<=0||this.height<=0||this.dragNode.render())}}class Selection{app;canvas;ctx;createSelection;hasSelection;isResize;state;width;height;calculate;rectangle;multiplexSelectNode;constructor(t){this.app=t,this.canvas=null,this.ctx=void 0,this.createSelection=!1,this.hasSelection=!1,this.isResize=!1,this.state=this.app.state,this.width=this.app.width,this.height=this.app.height,this.calculate=new Calculate(this),this.rectangle=new Rectangle({type:"rectangle",style:{strokeStyle:"rgba(9,132,227,0.3)",fillStyle:"rgba(9,132,227,0.3)"}},this),this.multiplexSelectNode=new MultiplexSelectNode({type:"multiplexSelectNode"},this),this.checkInNodes=throttle(this.checkInNodes,this,20),this.handleResize=throttle(this.handleResize,this,15),this.init(),this.bindEvent()}checkInNodes(t,e){const h=Math.min(e.mousedownPos.x,t.clientX),n=Math.min(e.mousedownPos.y,t.clientY),r=Math.max(e.mousedownPos.x,t.clientX),d=Math.max(e.mousedownPos.y,t.clientY),l=[];this.app.nodes.nodeList.forEach(t=>{let i=1/0,s=-1/0,o=1/0,a=-1/0;var e=t?.getEndCoordinateList?.();getBoundingRect(e.map(t=>[t.x,t.y]),!0).forEach(({x:t,y:e})=>{t<i&&(i=t),t>s&&(s=t),e<o&&(o=e),e>a&&(a=e)}),i>=h&&s<=r&&o>=n&&a<=d&&l.push(t)}),this.setMultiplexSelectNodes(l,!0),this.app.render.render()}checkInResizeHand(t,e){return this.multiplexSelectNode.dragNode.checkCoordinateInDragNodeWhere(t,e)}deleteSelectedNodes(){this.getSelectionNodes().forEach(t=>{this.app.nodes.deleteNode(t)}),this.selectNodes([]),this.app.emitChange()}hasSelectionNodes(){return 0<this.getSelectionNodes().length}getSelectionNodes(){return this.multiplexSelectNode.selectedNodeList}async copySelectionNodes(t){var e=this.getSelectionNodes().map(t=>this.app.nodes.copyNode(t,!0)),e=await Promise.all(e);if(this.setMultiplexSelectNodes(e),t){if(this.multiplexSelectNode.startResize(DRAG_NODE_PARTS.BODY),!(this.multiplexSelectNode.x&&this.multiplexSelectNode.y&&this.multiplexSelectNode.width&&this.multiplexSelectNode.height))return void console.error("multiplexSelectNode x or y or width or height is null");e=t.x-this.multiplexSelectNode.x-this.multiplexSelectNode.width/2,t=t.y-this.multiplexSelectNode.y-this.multiplexSelectNode.height/2,e=this.app.calculate.gridAdsorbent(e,t);this.multiplexSelectNode.resize(null,null,null,e.x,e.y),this.multiplexSelectNode.endResize(),this.multiplexSelectNode.updateRect()}this.app.render.render(),this.renderSelection(),this.app.emitChange()}checkIsResize(t,e,i){return!!this.hasSelection&&!!(t=this.multiplexSelectNode.dragNode.checkCoordinateInDragNodeWhere(t,e))&&(this.isResize=!0,this.multiplexSelectNode.startResize(t,i),this.app.cursor.setResize(t),!0)}handleResize(...t){this.isResize&&(this.multiplexSelectNode.resize(...t),this.app.render.render(),this.multiplexSelectNode.updateRect(),this.renderSelection())}endResize(){this.isResize=!1,this.multiplexSelectNode.endResize()}setSelectedNodeStyle(i={}){this.hasSelectionNodes()&&(Object.keys(i).forEach(e=>{this.getSelectionNodes().forEach(t=>{t.style[e]=i[e]})}),this.app.render.render(),this.app.emitChange())}selectNodes(t=[]){this.hasSelection=0<t.length,this.setMultiplexSelectNodes(t),this.app.render.render(),this.renderSelection(),this.emitChange()}cancelSelectNodes(){this.selectNodes([])}setMultiplexSelectNodes(t=[],e){this.multiplexSelectNode.setSelectedNodeList(t),e||this.multiplexSelectNode.updateRect()}emitChange(){this.app.emit("multiplexSelectChange",this.getSelectionNodes())}bindEvent(){this.app.on("change",()=>{this.state=this.app.state,this.multiplexSelectNode.updateNodes(this.app.nodes.nodeList),this.renderSelection()}),this.app.on("scrollChange",()=>{this.renderSelection()}),this.app.on("zoomChange",()=>{this.renderSelection()})}onMousedown(t,e){1===t.originEvent.which&&(this.createSelection=!0,this.rectangle.updatePos(e.mousedownPos.x,e.mousedownPos.y))}onMousemove(t,e){Math.abs(e.mouseOffset.x)<=10&&Math.abs(e.mouseOffset.y)<=10||this.onMove(t,e)}onMouseup(){this.createSelection=!1,this.rectangle.updateRect(0,0,0,0),this.hasSelection=this.hasSelectionNodes(),this.multiplexSelectNode.updateRect(),this.renderSelection(),this.emitChange()}onMove(t,e){this.rectangle.updateSize(e.mouseOffset.x,e.mouseOffset.y),this.renderSelection(),this.checkInNodes(t,e)}reset(){this.setMultiplexSelectNodes([]),this.hasSelection=!1,this.renderSelection(),this.emitChange()}renderSelection(){this.canvas.clearCanvas(),this.ctx?.save(),this.app.state.scale&&this.ctx?.scale(this.app.state.scale,this.app.state.scale),this.rectangle.render(),this.multiplexSelectNode.render(),this.ctx?.restore()}init(){this.canvas&&this.app.mountEL.removeChild(this.canvas.el),this.width=this.app.width,this.height=this.app.height,this.canvas=new Canvas(this.width,this.height,{className:"selection"}),this.ctx=this.canvas.ctx,this.app.mountEL.appendChild(this.canvas.el)}}class TextEdit extends EventEmitter{app;editable;isEditing;constructor(t){super(),this.app=t,this.editable=void 0,this.isEditing=!1,this.onTextInput=this.onTextInput.bind(this),this.onTextBlur=this.onTextBlur.bind(this)}showTextEdit(){this.editable?this.editable.style.display="block":this.crateTextInputEl(),void 0!==this.editable&&(this.updateTextInputStyle(),this.editable.focus(),this.editable.select(),this.isEditing=!0)}onTextInput(){var t,e,i=this.app.nodes["activeNode"];i&&void 0!==this.editable&&(i.text=this.editable.value,{width:t,height:e}=getTextNodeSize(i),i.width=t,i.height=e,this.updateTextInputStyle())}onTextBlur(){void 0!==this.editable&&(this.editable.style.display="none",this.editable.value="",this.emit("blur"),this.isEditing=!1)}crateTextInputEl(){this.editable=document.createElement("textarea"),this.editable.dir="auto",this.editable.tabIndex=0,this.editable.wrap="off",this.editable.className="textInput",Object.assign(this.editable.style,{position:"fixed",display:"block",minHeight:"1em",backfaceVisibility:"hidden",margin:0,padding:0,border:0,outline:0,resize:"none",background:"transparent",overflow:"hidden",whiteSpace:"pre"}),this.editable.addEventListener("input",this.onTextInput),this.editable.addEventListener("blur",this.onTextBlur),document.body.appendChild(this.editable)}updateTextInputStyle(){var t,e,i,s,o,a,h,n,r=this.app.nodes["activeNode"];r&&void 0!==this.editable&&({x:a,y:h}=r,{width:r,height:t,style:e,text:o,rotate:i}=r,{calculate:n,state:s}=this.app,this.editable.value=o,a=n.subScrollX(a),h=n.subScrollY(h),void 0!==s.scale)&&(o=n.scale(a,h),a=n.mountELToWindow(o.x,o.y),h=e.fontSize*s.scale,n={font:getFontString(h,e.fontFamily),lineHeight:h*e.lineHeightRatio+"px",left:a.x+"px",top:a.y+"px",color:e.fillStyle,width:Math.max(r,100)*s.scale+"px",height:t*s.scale+"px",transform:`rotate(${i}deg)`,opacity:e.globalAlpha},Object.assign(this.editable.style,n))}}function isEqual(e,i){if(typeof e!=typeof i)return!1;if("object"!=typeof e)return e===i;var s=Object.keys(e),t=Object.keys(i);if(s.length!==t.length)return!1;for(let t=0;t<s.length;t+=1){var o=s[t];if(!isEqual(e[o],i[o]))return!1}return!0}function getDiffData(e,i){var s=void 0===e,t=void 0===i;if(!s||!t){if(s)return{type:"cover-all",nodes:i.nodes};if(t||s&&0===i.nodes.length)return{type:"delete-all"};if(!isEqual(e.nodes,i.nodes)){const h=e.nodes||[],n=i.nodes||[];var t=h.length,o=n.length,s=t<o,e=o<t;if(s||e){i=s?n:h;const r=s?h.map(t=>t.id):n.map(t=>t.id);let t=i.filter(t=>!r.includes(t.id));return{type:s?"add":"delete",nodes:t=e?t.map(t=>({id:t.id})):t}}if(o===t){var a=[];for(let e=0;e<o;e+=1)if(!isEqual(h[e],n[e])){if("coordinateArr"in n[e]||"coordinateArr"in h[e])break;const d={};Object.keys(n[e]).forEach(t=>{isEqual(h[e][t],n[e][t])||(d[t]=n[e][t])}),d.id=n[e].id,a.push(d)}if(0<a.length)return{type:"update",nodes:a}}}}}function parseDiffNodes(i,{type:t,nodes:e}){return{add:()=>{i.push(...e)},delete:()=>{e.forEach(e=>{var t=i.findIndex(t=>t.id===e.id);i.splice(t,1)})},update:()=>{e.forEach(e=>{var t=i.findIndex(t=>t.id===e.id);i[t]={...i[t],...e}})},"cover-all":()=>{i.splice(0,i.length,...e)},"delete-all":()=>{i.splice(0,i.length)}}[t](),i}function getDiffState(t,e){var i,s,o,a,h,n,t=t?.state;if(void 0!==t)return e=e?.state,i=t.backgroundColor!==e.backgroundColor,s=t.showGrid!==e.showGrid,o=t.readonly!==e.readonly,a=t.scrollY!==e.scrollY,h=t.scrollX!==e.scrollX,t=t.scale!==e.scale,i||s||o?(n={},i&&(n.backgroundColor=e.backgroundColor),s&&(n.showGrid=e.showGrid),o&&(n.readonly=e.readonly),a&&(n.scrollY=e.scrollY),h&&(n.scrollX=e.scrollX),t&&(n.scale=e.scale),{type:"update-state",state:n}):void 0}function parseDiffState(e,{state:i}){return Object.keys(i).forEach(t=>{e[t]=i[t]}),e}class CreatLoader extends EventEmitter{options;mountEL;plotType;width;height;left;top;canvas;ctx;state;calculate;event;keyCommand;imageEdit;textEdit;cursor;history;export;background;selection;grid;author;nodes;render;watch;static utils;static checkClick;static plot;static nodes;oldData;constructor(t){super(),this.options=t,this.mountEL=t.mountEL,this.plotType=t.plotType||"selection",this.width=0,this.height=0,this.left=0,this.top=0,this.canvas=void 0,this.ctx=void 0,this.state={scale:1,scrollX:0,scrollY:0,scrollStep:25,backgroundColor:"",showGrid:!1,readonly:!1,defaultColor:"#000000",gridConfig:{size:20,strokeStyle:"#dfe0e1",lineWidth:1},...t.state||{}},this.initCanvas(),this.calculate=new Calculate(this),this.event=new Event(this),this.event.on("mousedown",this.onMousedown,this),this.event.on("mousemove",this.onMousemove,this),this.event.on("mouseup",this.onMouseup,this),this.event.on("dblclick",this.onDblclick,this),this.event.on("mousewheel",this.onMousewheel,this),this.event.on("contextmenu",this.onContextmenu,this),this.keyCommand=new KeyCommand(this),this.imageEdit=new ImageEdit(this),this.imageEdit.on("imageSelectChange",this.onImageSelectChange,this),this.textEdit=new TextEdit(this),this.textEdit.on("blur",this.onTextInputBlur,this),this.cursor=new Cursor(this),this.history=new History(this),this.export=new Export(this),this.background=new Background(this),this.selection=new Selection(this),this.grid=new Grid(this),this.nodes=new Nodes(this),this.render=new Render(this),this.author=new Author(this),this.mountFunction(),this.checkIsOnNode=throttle(this.checkIsOnNode,this),this.emitChange(),this.helpUpdate(),this.watch={zoomChange:t=>this.on("zoomChange",t),scrollChange:t=>this.on("scrollChange",t),currentTypeChange:t=>this.on("currentTypeChange",t),shuttle:t=>this.on("shuttle",t),activeNodeChange:t=>this.on("activeNodeChange",t),multiplexSelectChange:t=>this.on("multiplexSelectChange",t),contextmenu:t=>this.on("contextmenu",t),diffNodesChange:t=>this.on("diffNodesChange",t),diffStateChange:t=>this.on("diffStateChange",t),localDataChange:t=>this.on("change",t),nodeRotateChange:t=>this.on("nodeRotateChange",t)}}mountFunction(){["exportImage","exportJson"].forEach(t=>{this[t]=this.export[t].bind(this.export)}),["showGrid","hideGrid","updateGrid"].forEach(t=>{this[t]=this.grid[t].bind(this.grid)}),["setEditAuthor","setReadonlyAuthor"].forEach(t=>{this[t]=this.author[t].bind(this.author)}),["undo","redo"].forEach(t=>{this[t]=this.history[t].bind(this.history)}),["unBindEvent","bindEvent"].forEach(t=>{this[t]=this.keyCommand[t].bind(this.keyCommand)}),["setSelectedNodeStyle","cancelSelectNodes"].forEach(t=>{this[t]=this.selection[t].bind(this.selection)}),["updateActiveNodeRotate","updateActiveNodeSize","updateActiveNodePosition","cancelActiveNode","scrollToCenter","copyPasteCurrentNodes","empty","zoomIn","zoomOut","setZoom","selectAll","fit","deleteActiveNode","deleteCurrentNodes","setBackgroundColor","copyNode","copyCurrentNode","deleteNode","setActiveNodeStyle","setCurrentNodesStyle","scrollTo","cutCurrentNode","pasteCurrentNode"].forEach(t=>{this[t]=this.render[t].bind(this.render)})}getData(){return{state:{...this.state},nodes:this.nodes.serialize()}}onImageSelectChange(){this.cursor.hide()}getContainerRectInfo(){var{width:t,height:e,left:i,top:s}=this.mountEL.getBoundingClientRect();this.width=t,this.height=e,this.left=i,this.top=s}helpUpdate(){this.state.readonly&&this.setReadonlyAuthor(),this.state.showGrid&&this.grid.showGrid(),this.background.set()}async setData({state:t={},nodes:e=[]},i,s){this.state=t;var o=[];for(const a of e.map(async t=>"image"===t.type?{...t,imageObj:await createImageObj(t.url)}:t))o.push(await a);this.helpUpdate(),this.nodes.deleteAllNodes().createNodesFromData(o),this.render.render(),i||this.emitChange(s)}initCanvas(){this.getContainerRectInfo(),this.canvas&&this.mountEL.removeChild(this.canvas);var{canvas:t,ctx:e}=createCanvas(this.width,this.height,{className:"main"});this.canvas=t,this.ctx=e,this.mountEL.appendChild(this.canvas),console.log("a")}resize(){this.initCanvas(),this.render.render(),this.selection.init(),this.grid.init(),this.grid.renderGrid()}updateState(t={}){this.state={...this.state,...t},this.emitChange(void 0,!0)}updateCurrentType(t){this.plotType=t,"image"===this.plotType&&this.imageEdit.selectImage(),"eraser"===this.plotType?(this.cursor.setEraser(),this.cancelActiveNode()):"text"===this.plotType?this.cursor.setText():"selection"!==this.plotType?this.cursor.setCrossHair():this.cursor.reset(),this.emit("currentTypeChange",this.plotType)}onMousedown(t,e){var i;this.state.readonly||this.author.isDragAuthor?this.author.onStart():this.nodes.isCreateNode||this.textEdit.isEditing||(i=this.nodes.checkIsClickNode(t),"selection"===this.plotType?this.nodes.hasActiveNode()?this.nodes.checkIsResize(e.mousedownPos.unGridClientX,e.mousedownPos.unGridClientY,t)||(this.nodes.setActiveNode(i),this.render.render()):this.selection.hasSelection?this.selection.checkIsResize(e.mousedownPos.unGridClientX,e.mousedownPos.unGridClientY,t)||(this.selection.reset(),this.nodes.setActiveNode(i),this.render.render()):(i?(this.nodes.setActiveNode(i),this.render.render(),this):this.selection).onMousedown(t,e):"eraser"===this.plotType&&this.deleteNode(i))}onMousemove(t,e){var i,s,o,a;this.state.readonly||this.author.isDragAuthor?e.isMousedown&&this.author.onMove(t,e):e.isMousedown?(i=e.mousedownPos.x,s=e.mousedownPos.y,a=Math.max(e.mouseOffset.x,0),o=Math.max(e.mouseOffset.y,0),"selection"===this.plotType?this.selection.isResize?this.selection.handleResize(t,i,s,e.mouseOffset.x,e.mouseOffset.y):this.selection.createSelection?this.selection.onMousemove(t,e):(this.nodes.handleResize(t,i,s,e.mouseOffset.x,e.mouseOffset.y),this.render.render()):["rectangle","diamond","triangle"].includes(this.plotType)?(this.nodes.createRectangleLikeNode(this.plotType,i,s,a,o),this.render.render()):"circle"===this.plotType?(this.nodes.createCircle(i,s,t),this.render.render()):"arbitrary-plot"===this.plotType?this.nodes.createArbitraryPlot(t,e):"arrow"===this.plotType?(this.nodes.createArrow(i,s,t),this.render.render()):"line"===this.plotType&&3<getTowCoordinateDistance(i,s,t.clientX,t.clientY)&&(this.nodes.createLine(i,s,t,!0),this.render.render())):this.imageEdit.isReady?(this.cursor.hide(),this.imageEdit.updatePreviewElPos(t.originEvent.clientX,t.originEvent.clientY)):"selection"===this.plotType?this.nodes.hasActiveNode()?this.nodes.checkInResizeHand(t.unGridClientX,t.unGridClientY)?this.cursor.setResize("".hand):this.checkIsOnNode(t):this.selection.hasSelection&&(a=this.selection.checkInResizeHand(t.unGridClientX,t.unGridClientY))?this.cursor.setResize(a):this.checkIsOnNode(t):"line"===this.plotType&&(this.nodes.createLine(void 0,void 0,t,!1,!0),this.render.render())}checkIsOnNode(t){this.nodes.checkIsClickNode(t)?this.cursor.setMove():this.cursor.reset()}resetCurrentType(){"selection"!==this.plotType&&(this.plotType="selection",this.emit("currentTypeChange","selection"))}completeCreateNewNode(){this.resetCurrentType(),this.nodes.completeCreateNode(),this.render.render()}onMouseup(t){this.state.readonly||this.author.isDragAuthor||("text"===this.plotType?this.textEdit.isEditing||(this.createTextNode(t),this.resetCurrentType()):this.imageEdit.isReady?(this.nodes.createImage(t,this.imageEdit.imageData),this.completeCreateNewNode(),this.cursor.reset(),this.imageEdit.reset()):"arrow"===this.plotType?(this.nodes.completeCreateArrow(t),this.completeCreateNewNode()):"line"===this.plotType?(this.nodes.completeCreateLine(t,()=>{this.completeCreateNewNode()}),this.render.render()):this.nodes.isCreateNode?"arbitrary-plot"===this.plotType?(this.nodes.completeCreateNode(),this.nodes.setActiveNode()):this.completeCreateNewNode():this.nodes.isResize?(this.nodes.endResize(),this.emitChange()):this.selection.createSelection?this.selection.onMouseup():this.selection.isResize&&(this.selection.endResize(),this.emitChange()))}onDblclick(t){var e;"line"===this.plotType?this.completeCreateNewNode():(e=this.nodes.checkIsClickNode(t))?"text"===e.type&&(this.nodes.editingText(e),this.render.render(),this.keyCommand.unBindEvent(),this.textEdit.showTextEdit()):this.textEdit.isEditing||this.createTextNode(t)}onTextInputBlur(){this.keyCommand.bindEvent(),this.nodes.completeEditingText(),this.render.render(),this.emitChange()}createTextNode(t){this.nodes.createNode({type:"text",x:t.clientX,y:t.clientY}),this.keyCommand.unBindEvent(),this.textEdit.showTextEdit()}onMousewheel(t){var e;void 0!==this.state.scrollStep&&void 0!==this.state.scale&&(e=this.state.scrollStep/this.state.scale,this.scrollTo(this.state.scrollX,this.state.scrollY+("down"===t?e:-e)))}onContextmenu(t){let e;this.nodes.hasActiveNode()?e=[this.nodes.activeNode]:this.selection.hasSelectionNodes()&&(e=this.selection.getSelectionNodes()),this.emit("contextmenu",t.originEvent,e)}unBindEvent(){this.keyCommand.unBindEvent()}bindEvent(){this.keyCommand.bindEvent()}emitNodeRotateChange(t){this.emit("nodeRotateChange",t)}emitChange(t,e){var i=this.getData(),s=this.history.now();(void 0!==s||0===i.nodes.length)&&void 0===s||e||this.history.add(i),t||(this.emitDiffNodesChange(s,i),this.emitDiffStateChange(s,i)),this.emit("change",i)}emitDiffNodesChange(t,e){t=getDiffData(t,e);"object"==typeof t&&this.emit("diffNodesChange",t)}emitDiffStateChange(t,e){t=getDiffState(t,e);void 0!==t&&this.emit("diffStateChange",t)}async parseSetDiffData(t){var e=this.getData(),i={};"update-state"===t.type?(i.nodes=e.nodes,i.state=parseDiffState(e.nodes,t)):(i.state=e.state,i.nodes=parseDiffNodes(e.nodes,t)),await this.setData(i,!1,!0)}}function creatLoader(e){return{mount:function(t){if(!((t="string"==typeof t?document.querySelector(t):t)&&t instanceof HTMLElement))throw new Error("mountEl is not a HTMLElement !");if(["absolute","fixed","relative"].includes(window.getComputedStyle(t).position))return new CreatLoader({mountEL:t,plotType:e.plotType,state:e});throw new Error("The DOM being mounted needs to be set to absolute/fixed/relative positioning!")}}}export{creatLoader as default};
//# sourceMappingURL=creat-loader.es.js.map
