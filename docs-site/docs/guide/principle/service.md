# service æ ¸å¿ƒè®¾è®¡ ğŸ’»

## æ–‡ä»¶æ ‘
```
.
â”œâ”€â”€ common.py
â”œâ”€â”€ creat_data
â”‚   â”œâ”€â”€ __init__.py
â”œâ”€â”€ creat_room
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ room_manager.py
â”‚   â””â”€â”€ user.py
â”œâ”€â”€ creat_transfer
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ msg.py
â”‚   â”œâ”€â”€ painted_handle.py
â”‚   â””â”€â”€ transfer.py
â”œâ”€â”€ main.py
â”œâ”€â”€ README.md
â”œâ”€â”€ requirement
â”œâ”€â”€ system_framework.drawio.png
â”œâ”€â”€ tests
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ send_data.py
â”‚   â””â”€â”€ test_room.py
â””â”€â”€ utils
    â”œâ”€â”€ __init__.py
    â””â”€â”€ response.py
```

<br />

---

> (å›¾ç‰‡è¾ƒå¤§ï¼Œå¯èƒ½éœ€è¦åŠ è½½ä¸€ä¼š)


## åŠŸèƒ½æ¶æ„

![image](https://user-images.githubusercontent.com/73827386/201654440-4f8e9f65-1560-475c-851b-6f918a4740ce.png)

<br />

## è®¾è®¡æ€è·¯

![Top-level-design](https://user-images.githubusercontent.com/73827386/201654969-6ef1bd71-04b8-4153-84c7-124f7b27fdf8.png)

<br />

## å†…éƒ¨åŠŸèƒ½å®ç°

![Internal-links](https://user-images.githubusercontent.com/73827386/201654799-9a592811-e4de-430d-8fb0-03edb263f8b7.png)


- creat_room: æˆ¿é—´ç®¡ç†,ä¸»è¦æ¶‰åŠå¯¹æˆ¿é—´å†…çš„æ“ä½œæ§åˆ¶
- creat_data: æ•°æ®ç®¡ç†,ä¸»è¦æ¶‰åŠå¯¹æ•°æ®ä¿å­˜ä»¥åŠå‹ç¼©çš„æ§åˆ¶
- creat_transfer: æ˜¯æ¥å—WebSocketä¿¡æ¯çš„ç¬¬ä¸€é˜¶æ®µ,ä¸»è¦è´Ÿè´£æ•°æ®åˆ†é…ä¸æˆ¿é—´æ§åˆ¶

<br />

## API

::: tip
å¦‚æœä½ éœ€è¦ä½¿ç”¨ `service` æ¨¡å—çš„è¯ï¼Œä»¥ä¸‹å†…å®¹æ‚¨å¯èƒ½ä¼šéœ€è¦
:::

### ä¸€ã€åˆ›å»ºä¼šè®®

**æ¯ä¸ªç™½æ¿ä¸€ä¸ªidï¼Œå¯ä»¥åœ¨æ­¤ç™½æ¿åŸºç¡€ä¸Šåˆ›å»ºä¼šè®®ï¼Œæ‰€æœ‰æ•°æ®å‰ç«¯æä¾›ã€‚**

#### 1.1  è¾“å…¥

```json
{
  "type": "create_meeting",    // ä¼ è¾“æ•°æ®ç±»å‹
  "whiteboard":{
    "id":"xxxxxxxxxxx",       // ç™½æ¿å”¯ä¸€è¯†åˆ«
    "name": "æœªå‘½åæ–‡ä»¶1",     // ç™½æ¿åç§° 
    "nodes":[],              // åˆå§‹ç™½æ¿æ•°æ®
    "readonly":false         // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
  "user":{
    "id":"xxxxxxxxxxx",  // ç”¨æˆ·å”¯ä¸€è¯†åˆ«  
    "name":"xxxx",      // ç”¨æˆ·æ˜µç§°
    "color":"xxx",     // ç”¨æˆ·é»˜è®¤é¢œè‰²
  }
}
```

```json
{
  "type": "create_meeting",   
  "whiteboard":{
    "id":"xxxxxxxxxxx",      
    "name": "æœªå‘½åæ–‡ä»¶1",    
    "nodes":[],             
    "readonly":false        
  },
  "user":{
    "id":"a", 
    "name":"xxxx",     
    "color":"xxx"
  }
}
```

#### 1.2  å“åº”

```json
{
  "status": 200,
  "msg": "åˆ›å»ºæˆ¿é—´æˆåŠŸ",
}
```

#### 1.3  æ•°æ®ç¼“å­˜

ç±»ä¼¼è¿™æ ·

```json
key: creat-xxxxxxxx (creat-ç™½æ¿id)
value: {
  "author_id": "xxxxx",
  "whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",     // ç™½æ¿åç§° 
    "nodes":[],              // åˆå§‹ç™½æ¿æ•°æ®
    "readonly":false         // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
}
```

### äºŒã€ æ£€æŸ¥ä¼šè®®

å…ˆè¦æœ‰æ¥å£åˆ¤æ–­ä¼šè®®æ˜¯å¦å­˜åœ¨ï¼Œå³åˆ¤æ–­ç¼“å­˜æ˜¯å¦æœ‰idï¼Œå¹¶ä¸”è·å–æƒé™

#### 2.1  è¾“å…¥

```json
{
  "type": "check_meeting",
  "whiteboard":{
    "id":"xxxxxxxxxxx",      // ç™½æ¿å”¯ä¸€è¯†åˆ«
  },
}
```

#### 2.2  å“åº”

##### 2.2.1 ç¼“å­˜ä¸­å·²å­˜åœ¨è¯¥ç™½æ¿ï¼ˆå·²åˆ›å»ºï¼‰

```json
{
  "status":200
  "whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",     // ç™½æ¿åç§° 
    "readonly":true         // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
}
```

##### 2.2.2 ç¼“å­˜ä¸­ä¸å­˜åœ¨è¯¥ç™½æ¿ ï¼ˆæœªåˆ›å»ºï¼‰

```json
{
  "status":404
}
```

### ä¸‰ã€è¿›å…¥ä¼šè®®

ç™½æ¿æ˜¯å¦åªè¯»ç”± ç« èŠ‚ï¼šâ€œäºŒã€æ£€æŸ¥ä¼šè®®â€ è·å–ï¼Œå‰ç«¯åˆ¤æ–­ã€‚

#### 3.1  è¾“å…¥

##### 3.1.1 ç™½æ¿åªè¯»æƒ…å†µä¸‹è¾“å…¥

```json
{
  "type": "join_meeting",
  "whiteboard":{
    "id":"xxxxxxxxxxx",      // ç™½æ¿å”¯ä¸€è¯†åˆ«
  },
}
```

##### 3.1.1 ç™½æ¿éåªè¯»æƒ…å†µä¸‹è¾“å…¥

```json
{
  "type": "join_meeting",
  "whiteboard":{
    "id":"xxxxxxxxxxx"  
  },
  "user":{      
    "id":"b",  
    "name":"aaa",      
    "color":"xxx"
  }
}
```

##### 3.2  å“åº”

è¿™é‡Œå’Œåˆ›å»ºä¼šè®®æ—¶ç¼“å­˜é‡Œçš„çš„ä½œè€…idå¯¹æ¯”

##### 3.2.1 ç™½æ¿åªè¯»æƒ…å†µä¸‹

**a.  åŠ å…¥çš„æ˜¯ä½œè€…ï¼Œåˆ™å“åº”**

å¦‚æœåŠ å…¥çš„æ˜¯ä½œè€…ï¼Œåˆ™ä¸ºï¼š

```json
{
  "whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",     // ç™½æ¿åç§° 
    "nodes":[],              // åˆå§‹ç™½æ¿æ•°æ®
    "readonly":true        // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
  "user_rights":"author"  // ç”¨æˆ·ç±»å‹
}
```

**b.   åŠ å…¥çš„æ˜¯è´¡çŒ®è€…ï¼Œåˆ™å“åº”**

åŠ å…¥çš„ä¸æ˜¯ä½œè€…ï¼Œåˆ™æ˜¯ï¼š

```json
{
  "whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",       // ç™½æ¿åç§° 
    "nodes":[],               // åˆå§‹ç™½æ¿æ•°æ®
    "readonly":true         // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
  "user_rights":"contributor"   // ç”¨æˆ·ç±»å‹
}
```

**c.  è½¬å‘ç»™å…¶ä»–æˆå‘˜**

æ— 

##### 3.2.2 ç™½æ¿éåªè¯»æƒ…å†µä¸‹

**a.  åŠ å…¥çš„æ˜¯ä½œè€…ï¼Œåˆ™å“åº”**

å¦‚æœåŠ å…¥çš„æ˜¯ä½œè€…ï¼Œåˆ™ä¸ºï¼š

```json
{
  "whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",         // ç™½æ¿åç§° 
    "nodes":[],                 // åˆå§‹ç™½æ¿æ•°æ®
    "readonly":false           // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
  "user_rights":"author",    // ç”¨æˆ·ç±»å‹
  "cooperation_users": [    // å·²åœ¨çº¿åä½œç”¨æˆ·æ•°æ®
    {  
      "name": "aaa",
      "color": "xxx",
      "rights": "contributor"
    }
    .....
  ],
}
```

**b.  åŠ å…¥çš„æ˜¯è´¡çŒ®è€…ï¼Œåˆ™å“åº”**

åŠ å…¥çš„ä¸æ˜¯ä½œè€…ï¼Œåˆ™æ˜¯ï¼š

```json
{
  "whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",            // ç™½æ¿åç§° 
    "nodes":[],                    // åˆå§‹ç™½æ¿æ•°æ®
    "readonly":false              // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
  "user_rights":"contributor",  // ç”¨æˆ·ç±»å‹
  "cooperation_users": [       // å·²åœ¨çº¿åä½œç”¨æˆ·æ•°æ®
    {  
      "name": "aaa",
      "color": "xxx",
      "rights": "contributor"
    }
    .....
  ],
}
```

**c.  è½¬å‘ç»™å…¶ä»–æˆå‘˜**

```json
{
  "type": "join_meeting",
  "join_user":{      
    "name":"aaa",       // ç”¨æˆ·æ˜µç§° ï¼ˆåŠ å…¥çš„æ—¶å€™ä¼šåˆ¤æ–­ï¼Œæ˜¯å¦å·²ç»å­˜åœ¨è¯¥ç”¨æˆ·æ˜µç§°ï¼Œå­˜åœ¨åˆ™åé¦ˆï¼‰   
    "color":"xxx",     // ç”¨æˆ·é»˜è®¤é¢œè‰²
  }
}
```

### å››ã€é€€å‡ºä¼šè®®

#### 4.1  è¾“å…¥

```json
{
  "type": "quit_meeting",
  "user":{
    "name":"xxxxx"   // ç”¨æˆ·æ˜µç§° 
  }
}

```

#### 4.2  å…¶ä»–æˆå‘˜å“åº”

```json
{
  "type": "quit_meeting",
  "user":{
    "name":"xxxxx"   // ç”¨æˆ·æ˜µç§° 
  }
}
```

### äº”ã€å…³é—­ä¼šè®®

åªæœ‰ä½œè€…å¯ä»¥å…³é—­ï¼ŒåŒæ ·åˆ¤æ–­idæ˜¯å¦å’Œç¼“å­˜é‡Œçš„idæ˜¯å¦ç›¸åŒï¼Œ**å…³é—­ä¹‹ååˆ™åˆ é™¤ç¼“å­˜**

#### 5.1 è¾“å…¥

```json
{
  "type": "close_meeting",
  "user":{
    "id":"xxxxxxxxxxx",  // ç”¨æˆ·å”¯ä¸€è¯†åˆ«
  }
}
```

### å…­ã€æ›´æ”¹ä¼šè®®çŠ¶æ€

åªæœ‰ä½œè€…æœ‰æƒé™ï¼Œä¿®æ”¹ä¹‹åï¼Œredisä¸­çš„ç¼“å­˜æ•°æ®ä¹Ÿä¼šä¿®æ”¹

#### 6.1  è¾“å…¥

```json
{
  "type": "change_meeting",    // ä¼ è¾“æ•°æ®ç±»å‹
  "whiteboard":{
    "name": "ä¿®æ”¹æ–‡ä»¶1",      //  ç™½æ¿åç§°                 // è¿™ä¸ªå¯ä»¥ä¿®æ”¹
    "readonly":true         // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€   // è¿™ä¸ªå¯ä»¥ä¿®æ”¹
  }
}
```

#### 6.2 ç»™ä½œè€…çš„å“åº”

```json
{
  "status": 200,
  "msg": "æˆåŠŸ",
}
```

#### 6.3  å…¶ä»–æˆå‘˜å“åº”

```json
{
  "type": "change_meeting",    // ä¼ è¾“æ•°æ®ç±»å‹
  "whiteboard":{
    "name": "ä¿®æ”¹æ–‡ä»¶1",      //  ç™½æ¿åç§°
    "readonly":true         // è¿™é‡Œæ˜¯å…¨å±€çš„æ˜¯å¦åªè¯»çŠ¶æ€
  },
}
```

### ä¸ƒã€æ›´æ”¹ä¼šè®®ç™½æ¿æ•°æ®ï¼ˆåŒæ­¥ï¼‰

readonly ä¸º true çš„æ—¶å€™ï¼Œåªæœ‰ä½œè€…å¯ä»¥ä¿®æ”¹ï¼Œå½“ç„¶å‰ç«¯ä¹Ÿä¸ä¼šå‘é€æ•°æ®ã€‚

åç«¯å¯¹redisä¸­çš„ç¼“å­˜åŒæ ·è¿›è¡Œæ›´æ–°ï¼Œä¹‹åå†è½¬å‘ç»™å…¶å®ƒäºº

```json
"whiteboard":{
    "name": "æœªå‘½åæ–‡ä»¶1",
    "nodes":[],              // ğŸ‘ˆè¿™é‡Œ
    "readonly":false
  },
```

#### 7.1  `update` æ›´æ–° nodes

> æ‰¾åˆ°idåï¼Œé€šè¿‡ `node[key] = newNode[key]` è¦†ç›–

**è¾“å…¥**

```json
{
  "type": "nodes-update",
  "nodes":[
    {
      "id":"aaaaaa"
      "æ›´æ–°çš„key":"æ›´æ–°çš„æ•°æ®"
        .......
    },
    {
      "id":"bbbb"
      "æ›´æ–°çš„key":"æ›´æ–°çš„æ•°æ®"
        .......
    }
  ]
}
```

è¾“å‡º

```json
{
  "type": "nodes-update",
  "nodes":[
    {
      "id":"aaaaaa"
      "æ›´æ–°çš„key":"æ›´æ–°çš„æ•°æ®"
        .......
    },
    {
      "id":"bbbb"
      "æ›´æ–°çš„key":"æ›´æ–°çš„æ•°æ®"
        .......
    }
  ]
}
```

#### 7.2  `add` æ–°å¢ node

> å¯ä»¥æ–°å¢å¤šä¸ªï¼Œæ‰€ä»¥nodeså¯¹è±¡æ˜¯ä¸ªæ•°ç»„ï¼Œè¿½åŠ åˆ°æœ«å°¾ï¼Œå°½é‡ä¿ç•™åŸé¡ºåº

**è¾“å…¥**

```json
{
  "type": "add",
  "nodes": [
    {
      "id": "aaaaaa1",
      "æ›´æ–°çš„key": "æ›´æ–°çš„æ•°æ®"
    },
    {
      "id": "aaaaaa2",
      "æ›´æ–°çš„key": "æ›´æ–°çš„æ•°æ®"
    }
  ]
}
```

è¾“å‡º

```json
{
  "type": "add",
  "nodes":[
    {
      .......
    },
    {
      .......
    }  
  ]
}
```

#### 7.3  `delete` åˆ é™¤ node

> å¯ä»¥åˆ é™¤å¤šä¸ªï¼Œæ‰€ä»¥nodeså¯¹è±¡æ˜¯ä¸ªæ•°ç»„ï¼Œæ ¹æ®idåˆ é™¤ï¼Œå°½é‡ä¿ç•™åŸé¡ºåº

**è¾“å…¥**

```json
{
  "type": "delete",
  "nodes":[
    {
      "id":"aaa"
      },
    {
      "id":"bbb"
    }  
  ]
}
```

è¾“å‡º

```json
{
  "type": "delete",
  "nodes":[
    {
      "id":"aaa"
      },
    {
      "id":"bbb"
    }  
  ]
}
```

#### 7.4  `delete-all` åˆ é™¤å…¨éƒ¨ nodes

**è¾“å…¥**

```json
{
  "type": "nodes-delete-all",
}
```

#### 7.5  `cover-all` è¦†ç›–å…¨éƒ¨ nodes

> ç›´æ¥è¦†ç›–åœ¨ä»£ç çš„æ‰§è¡Œé€»è¾‘ä¸Š....... è²Œä¼¼è¿™ç§æƒ…å†µä¸ä¼šå‘ç”Ÿï¼Œä¿ç•™æ˜¯ä¸ºäº†é¿å…é”™è¯¯

**è¾“å…¥**

```json
{
  "type": "cover-all",
  "nodes":[ ..... ]
}
```

#### 7.6 `sync-mouse` é¼ æ ‡ä½ç½®åŒæ­¥

é¼ æ ‡æŒ‰ä¸‹å»çš„æ—¶å€™ä¼ è¾“ä½ç½®å¹¶æ˜¾ç¤º

**è¾“å…¥**

```json
{
    "type":"sync-mouse",
    "coordinate":{
        "x":"100",
        "y":"200",
        "isMousedown": false
    },
    "user":{
        "name":"xxx",
        "color":"xxx"
    }
}
```

è¾“å‡º

```json
{
    "type":"sync-mouse",
    "coordinate":{
        "x":"100",
        "y":"200",
        "isMousedown": false
    },
    "user":{
        "name":"xxx",
        "color":"xxx"
    }
}
```

#### 7.7  `update-state` åŒæ­¥æ“ä½œçŠ¶æ€&#x20;

**è¾“å…¥**

```json
{
    "type":"update-state",
    "state":{
        "æ›´æ–°çš„key":"æ›´æ–°çš„æ•°æ®",
    },
}
```

**è¾“**å‡º

```json
{
    "type":"update-state",
    "state":{
        "æ›´æ–°çš„key":"æ›´æ–°çš„æ•°æ®",
    },
}
```
